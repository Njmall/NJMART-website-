<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Profile</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --max-width:980px;
      --bg:#f6fbf8;
      --card:#fff;
      --muted:#6b7280;
      --accent:#2db34a;
      --accent-dark:#1f8a34;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(12,30,40,0.06);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--max-width);margin:18px auto;padding:12px}

    header.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    h1{font-size:20px;margin:0}
    .muted{color:var(--muted);font-size:13px}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}

    form .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:180px}
    label{display:block;font-weight:700;margin:8px 0 6px}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e8f0ec;font-size:15px;background:#fff}
    textarea{min-height:90px;resize:vertical}

    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e6eef0}
    .btn.warn{background:var(--danger);color:#fff}

    .small{font-size:13px;color:var(--muted)}
    .info{background:#f8fff9;border-radius:8px;padding:10px;border:1px solid #eef8ee;margin-top:8px}

    .center{display:flex;align-items:center;gap:8px}
    .hidden{display:none}

    @media(max-width:720px){
      .row{flex-direction:column}
      .col{min-width:unset}
    }
  </style>

  <!-- script-config provides callScriptAPI, getLocalUser, setLocalUser etc. -->
  <script src="./script-config.js"></script>
  <!-- firebase-config may exist for signOut, optional -->
  <script type="module" src="./firebase-config.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>
          <h1>My Profile</h1>
          <div class="muted">Manage your contact, address & preferences</div>
        </div>
      </div>

      <div class="center">
        <div id="userPhone" class="small muted">Not signed in</div>
        <button id="btnLogout" class="btn ghost hidden"><i class="fa fa-sign-out-alt"></i> Logout</button>
      </div>
    </header>

    <!-- Profile card -->
    <section class="card" aria-labelledby="profileTitle">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="profileTitle" style="margin:0">Account details</h2>
          <div class="small muted">Your basic profile info (editable)</div>
        </div>
        <div id="statusNote" class="small muted">Autosave to Google Sheet</div>
      </div>

      <form id="profileForm" style="margin-top:12px">
        <div class="row">
          <div class="col">
            <label for="fullName">Full name</label>
            <input id="fullName" name="fullName" placeholder="e.g. Nitin Kumar">
          </div>
          <div class="col">
            <label for="email">Email (optional)</label>
            <input id="email" name="email" placeholder="you@example.com" type="email">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col">
            <label for="phone">Phone (required)</label>
            <input id="phone" name="phone" placeholder="+91 9XXXXXXXXX" required>
          </div>
          <div class="col">
            <label for="pincode">Pincode</label>
            <input id="pincode" name="pincode" placeholder="e.g. 110001">
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="address">Full address</label>
          <textarea id="address" name="address" placeholder="House no, street, area, city, state"></textarea>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button id="btnLocation" type="button" class="btn ghost"><i class="fa fa-location-dot"></i> Use current location</button>
          <button id="btnSave" type="button" class="btn primary"><i class="fa fa-save"></i> Save profile</button>
          <div id="saveMsg" class="small muted" style="margin-left:8px">Not saved</div>
        </div>

        <div class="info" style="margin-top:12px">
          <div style="font-weight:700">How this works</div>
          <div class="small muted" style="margin-top:6px">
            When you save, the profile is stored in your Google Sheet (admin panel). Admin can edit it later.
            Billing and orders will use the phone number you save here.
          </div>
        </div>
      </form>
    </section>

    <!-- Saved addresses (readable) -->
    <section id="addressesCard" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">Saved addresses</h2>
          <div class="small muted">Manage your delivery addresses (stored in sheet)</div>
        </div>
        <div>
          <button id="btnAddAddress" class="btn primary">Add address</button>
        </div>
      </div>

      <div id="addressesList" style="margin-top:12px">
        <!-- addresses will be injected here -->
        <div class="small muted">Loading saved addresses…</div>
      </div>
    </section>

    <!-- Address modal-like area (simple inline form) -->
    <section id="addressEditor" class="card hidden">
      <h3 style="margin:0 0 8px 0">Add / Edit address</h3>
      <form id="addrForm">
        <div class="row">
          <div class="col">
            <label for="addrName">Name</label>
            <input id="addrName" placeholder="Name for this address">
          </div>
          <div class="col">
            <label for="addrPhone">Phone</label>
            <input id="addrPhone" placeholder="Phone">
          </div>
        </div>
        <div style="margin-top:8px">
          <label for="addrLine">Address line</label>
          <input id="addrLine" placeholder="House no, building, street">
        </div>
        <div class="row" style="margin-top:8px">
          <div class="col">
            <label for="addrCity">City</label>
            <input id="addrCity" placeholder="City">
          </div>
          <div class="col">
            <label for="addrPin">Pincode</label>
            <input id="addrPin" placeholder="Pincode">
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="addrSaveBtn" type="button" class="btn primary">Save address</button>
          <button id="addrCancelBtn" type="button" class="btn ghost">Cancel</button>
          <button id="addrUseLoc" type="button" class="btn ghost">Use current location</button>
          <div id="addrMsg" class="small muted" style="margin-left:8px"></div>
        </div>
      </form>
    </section>

    <!-- Orders quick link -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">Your Orders</h2>
          <div class="small muted">View or track past orders</div>
        </div>
        <div><button id="viewOrdersBtn" class="btn ghost">My Orders</button></div>
      </div>
    </section>

    <footer style="text-align:center;margin-top:10px" class="small muted">NJ Mart © 2025 — Your data stored in Google Sheet (admins can edit)</footer>
  </div>

  <!-- ================ SCRIPT ================ -->
  <script>
  /************************************************************************
   * profile.html
   *
   * This script:
   *  - checks if user is logged in (getLocalUser or localStorage)
   *  - fetches profile from Google Sheet via callScriptAPI
   *  - allows save/update to sheet (payload types: addCustomer / updateCustomer)
   *  - manages address list stored in Sheet (add/edit/delete)
   *
   * Requirements:
   *  - script-config.js must be present and expose callScriptAPI(), getLocalUser(), setLocalUser()
   *  - Apps Script WebApp should accept payload types:
   *       { type: "getCustomer", userId }           -> returns { ok:true, data: { ... } }  (preferred)
   *       { type: "getCustomers" }                  -> returns list of customers
   *       { type: "addCustomer", customer }         -> add a customer
   *       { type: "updateCustomer", customer }      -> update by id
   *       { type: "getAddresses", userId }          -> optional: get addresses for user
   *       { type: "addAddress", address }           -> optional: add address row
   *       { type: "updateAddress", address }        -> optional
   *       { type: "deleteAddress", addressId }      -> optional
   *
   * If your Apps Script uses different keys, change the payload types below.
   ************************************************************************/

  // small helpers that use script-config wrappers if available
  const callAPI = (typeof callScriptAPI === 'function') ? callScriptAPI : null;
  const getLocal = (typeof getLocalUser === 'function') ? getLocalUser : (() => JSON.parse(localStorage.getItem('nj_user')||'null'));
  const saveLocal = (typeof setLocalUser === 'function') ? setLocalUser : ((u)=> localStorage.setItem('nj_user', JSON.stringify(u)));

  // DOM elements
  const fullNameEl = document.getElementById('fullName');
  const emailEl = document.getElementById('email');
  const phoneEl = document.getElementById('phone');
  const pincodeEl = document.getElementById('pincode');
  const addressEl = document.getElementById('address');
  const saveBtn = document.getElementById('btnSave');
  const saveMsg = document.getElementById('saveMsg');
  const userPhoneBadge = document.getElementById('userPhone');
  const logoutBtn = document.getElementById('btnLogout');

  // address editor elements
  const addressListEl = document.getElementById('addressesList');
  const addrEditor = document.getElementById('addressEditor');
  const addrForm = document.getElementById('addrForm');
  const addrName = document.getElementById('addrName');
  const addrPhone = document.getElementById('addrPhone');
  const addrLine = document.getElementById('addrLine');
  const addrCity = document.getElementById('addrCity');
  const addrPin = document.getElementById('addrPin');
  const addrSaveBtn = document.getElementById('addrSaveBtn');
  const addrCancelBtn = document.getElementById('addrCancelBtn');
  const addrUseLoc = document.getElementById('addrUseLoc');
  const addrMsg = document.getElementById('addrMsg');
  const addAddressBtn = document.getElementById('btnAddAddress');

  // orders button
  const viewOrdersBtn = document.getElementById('viewOrdersBtn');

  // state
  let CURRENT_USER = null;      // object -> { id, uid, name, phone, email, address, ... }
  let ADDRESSES = [];           // list of addresses from sheet or localStorage
  let EDITING_ADDRESS_INDEX = -1;

  /***********************
   * Init on load
   ***********************/
  (async function init(){
    // 1) check local user (from login)
    CURRENT_USER = getLocal();
    if(!CURRENT_USER){
      // not logged in, show message and redirect to login optionally
      userPhoneBadge.textContent = 'Not signed in';
      // If you want to force login:
      // if(confirm('You are not signed in. Login now?')) location.href='login.html';
    } else {
      // show phone/email in header
      userPhoneBadge.textContent = CURRENT_USER.phone || (CURRENT_USER.email || 'Signed in');
      logoutBtn.classList.remove('hidden');
    }

    // 2) load profile from backend (if available), otherwise use local user
    await loadProfile();

    // 3) load addresses
    await loadAddresses();

    // 4) wire up events
    setupEvents();

    // 5) nice UX: focus name field if empty
    if(!fullNameEl.value) fullNameEl.focus();
  })();

  /***********************
   * LOAD PROFILE
   ***********************/
  async function loadProfile(){
    // If we have logged-in user ID, try to fetch record from sheet
    const userId = CURRENT_USER ? (CURRENT_USER.id || CURRENT_USER.uid || CURRENT_USER.email) : null;

    // first, fill from local if exists
    if(CURRENT_USER){
      fullNameEl.value = CURRENT_USER.name || '';
      emailEl.value = CURRENT_USER.email || '';
      phoneEl.value = CURRENT_USER.phone || '';
      addressEl.value = CURRENT_USER.address || '';
      pincodeEl.value = CURRENT_USER.pincode || '';
      saveMsg.textContent = 'Loaded from local';
    }

    if(!callAPI || !userId){
      // No backend or no user => we stop here
      return;
    }

    // try preferred API: getCustomer by userId
    try {
      const r = await callAPI({ type: 'getCustomer', userId });
      if(r && r.ok && r.data){
        // expected r.data to be a single object
        CURRENT_USER = r.data;
        // update local copy
        try { saveLocal(CURRENT_USER); } catch(e){}
        // populate fields
        fullNameEl.value = CURRENT_USER.name || '';
        emailEl.value = CURRENT_USER.email || '';
        phoneEl.value = CURRENT_USER.phone || '';
        addressEl.value = CURRENT_USER.address || '';
        pincodeEl.value = CURRENT_USER.pincode || '';
        saveMsg.textContent = 'Loaded from sheet';
        userPhoneBadge.textContent = CURRENT_USER.phone || CURRENT_USER.email || 'Signed in';
        logoutBtn.classList.remove('hidden');
        return;
      }
    } catch (err) {
      console.warn('getCustomer API error', err);
    }

    // fallback: get all customers and find by phone/email
    try {
      const resAll = await callAPI({ type: 'getCustomers' });
      if(resAll && resAll.ok && Array.isArray(resAll.data)){
        const found = resAll.data.find(c => (CURRENT_USER && (c.phone === CURRENT_USER.phone || c.email === CURRENT_USER.email)));
        if(found){
          CURRENT_USER = found;
          try { saveLocal(CURRENT_USER); } catch(e){}
          fullNameEl.value = CURRENT_USER.name || '';
          emailEl.value = CURRENT_USER.email || '';
          phoneEl.value = CURRENT_USER.phone || '';
          addressEl.value = CURRENT_USER.address || '';
          pincodeEl.value = CURRENT_USER.pincode || '';
          saveMsg.textContent = 'Loaded from sheet';
          userPhoneBadge.textContent = CURRENT_USER.phone || CURRENT_USER.email || 'Signed in';
          logoutBtn.classList.remove('hidden');
          return;
        }
      }
    } catch (err){
      console.warn('getCustomers fallback error', err);
    }

    // if we reach here, profile not found on sheet — keep local
    saveMsg.textContent = 'Profile not found on sheet (local only)';
  }

  /***********************
   * SAVE / UPDATE PROFILE
   ***********************/
  saveBtn.addEventListener('click', async ()=>{
    // validate phone
    const name = fullNameEl.value.trim();
    const email = emailEl.value.trim();
    const phone = phoneEl.value.trim();
    const address = addressEl.value.trim();
    const pincode = pincodeEl.value.trim();

    if(!phone){
      alert('Phone is required');
      phoneEl.focus();
      return;
    }

    // create payload
    const customer = {
      id: CURRENT_USER && (CURRENT_USER.id || CURRENT_USER.uid) ? (CURRENT_USER.id || CURRENT_USER.uid) : ('c_' + Date.now()),
      name, email, phone, address, pincode
    };

    // optimistic local save
    try { saveLocal(customer); CURRENT_USER = customer; } catch(e){ console.warn(e); }

    // UI feedback
    saveMsg.textContent = 'Saving...';

    // if we have backend, call add/update
    if(callAPI){
      try {
        // prefer updateCustomer if exists
        const useType = (CURRENT_USER && CURRENT_USER.id) ? 'updateCustomer' : 'addCustomer';
        const r = await callAPI({ type: useType, customer });
        if(r && r.ok){
          saveMsg.textContent = 'Saved';
          // update CURRENT_USER with returned data if any
          if(r.data) { CURRENT_USER = r.data; try{ saveLocal(CURRENT_USER); }catch(e){} }
          // refresh addresses
          await loadAddresses();
          return;
        } else {
          saveMsg.textContent = 'Saved locally (sheet returned error)';
          console.warn('sheet save error', r);
        }
      } catch (err) {
        saveMsg.textContent = 'Saved locally (sheet error)';
        console.warn('callAPI error', err);
      }
    } else {
      saveMsg.textContent = 'Saved locally (no backend)';
    }
  });

  /***********************
   * LOGOUT
   ***********************/
  logoutBtn.addEventListener('click', async ()=>{
    // clear local user
    try {
      // if firebase-config exports signOutUser
      if(typeof signOutUser === 'function'){
        await signOutUser();
      }
    } catch(e){ console.warn('firebase sign out', e) }

    // clear local storage values related to auth/profile
    try {
      localStorage.removeItem('nj_user');
    } catch(e){/* ignore */}
    CURRENT_USER = null;
    userPhoneBadge.textContent = 'Not signed in';
    logoutBtn.classList.add('hidden');
    alert('Logged out');
    // optionally redirect to login
    // location.href = 'login.html';
  });

  /***********************
   * ADDRESSES: load / render / add / update / delete
   ***********************/
  async function loadAddresses(){
    // prefer backend call if available
    if(callAPI && CURRENT_USER && (CURRENT_USER.id || CURRENT_USER.phone || CURRENT_USER.email)){
      try {
        const userId = CURRENT_USER.id || CURRENT_USER.uid || CURRENT_USER.email || CURRENT_USER.phone;
        const r = await callAPI({ type: 'getAddresses', userId });
        if(r && r.ok && Array.isArray(r.data)){
          ADDRESSES = r.data;
          renderAddresses();
          return;
        }
      } catch(err){
        console.warn('getAddresses error', err);
      }
    }

    // fallback to localStorage stored addresses
    try {
      ADDRESSES = JSON.parse(localStorage.getItem('nj_addresses_' + (CURRENT_USER ? (CURRENT_USER.id || CURRENT_USER.phone || 'guest') : 'guest')) || '[]');
      renderAddresses();
    } catch(e){
      ADDRESSES = [];
      renderAddresses();
    }
  }

  function renderAddresses(){
    addressListEl.innerHTML = '';
    if(!ADDRESSES || ADDRESSES.length === 0){
      addressListEl.innerHTML = '<div class="small muted">No saved addresses</div>';
      return;
    }
    ADDRESSES.forEach((a, idx)=>{
      const node = document.createElement('div');
      node.className = 'card';
      node.style.marginBottom = '10px';
      node.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div>
            <div style="font-weight:800">${a.name} <span class="small muted">(${a.phone})</span></div>
            <div class="small muted" style="margin-top:6px">${a.line}, ${a.city} - ${a.pin}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn ghost" data-act="select" data-idx="${idx}">Deliver here</button>
            <button class="btn ghost" data-act="edit" data-idx="${idx}">Edit</button>
            <button class="btn ghost" data-act="delete" data-idx
