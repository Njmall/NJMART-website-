<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Account (Login / Profile)</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg:#f5fbf8; --card:#fff; --accent:#2db34a; --muted:#65707a;
      --shadow: 0 10px 30px rgba(12,30,40,0.06);
      --maxw:920px;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:#111;padding:20px}
    .wrap{max-width:var(--maxw);margin:10px auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#1f8a34);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
    h1{margin:0;font-size:20px}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
    @media(max-width:960px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow)}
    .section-title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted);font-size:13px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #eee}
    .input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;margin-top:8px}
    .row{display:flex;gap:10px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .profile-pic{width:72px;height:72px;border-radius:999px;object-fit:cover}

    /* phone UI */
    #phonePanel .input-row{display:flex;gap:8px}
    #phonePanel .input-row input{flex:1}
    .note{font-size:13px;color:#777;margin-top:8px}

    /* profile form */
    .field{margin-top:10px}
    .save-btn{margin-top:12px}

    /* recaptcha container */
    #recaptcha-container{margin-top:12px}

    /* messages */
    .msg{padding:8px;border-radius:8px;margin-top:10px}
    .msg.success{background:#f0fff4;color:#1f8a34}
    .msg.error{background:#fff0f0;color:#c43b3b}

    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
  </style>

  <!-- Firebase v8 compat libs (easier for signInWithPopup & signInWithPhoneNumber) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- include user script-config.js which should set SCRIPT_URL (optional) -->
  <script src="./script-config.js"></script>
  <!-- include firebase-config.js (must export firebaseConfig variable) -->
  <script src="./firebase-config.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">NJ</div>
      <div>
        <h1>NJ Mart — Account</h1>
        <div class="muted">Sign in with Google or Phone — fill profile and save</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: login options + profile form -->
      <div>
        <!-- LOGIN CARDS -->
        <div class="card" id="loginCard">
          <div class="section-title">Sign in</div>

          <!-- Google -->
          <div style="margin-top:8px">
            <button id="btnGoogle" class="btn primary" style="width:100%">
              <i class="fa fa-google"></i> Continue with Google
            </button>
            <div class="note">Will open Google's sign-in window. On success you'll be returned here.</div>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px dashed #eee">

          <!-- Phone -->
          <div id="phonePanel">
            <div class="section-title small">Phone (OTP)</div>

            <div class="input-row" style="margin-top:8px">
              <input id="phoneInput" class="input" placeholder="+91 91234 56789" />
            </div>

            <!-- recaptcha placeholder -->
            <div id="recaptcha-container"></div>

            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="sendOtpBtn" class="btn primary">Send OTP</button>
              <button id="verifyOtpBtn" class="btn ghost" disabled>Verify OTP</button>
            </div>

            <div id="otpRow" style="margin-top:10px;display:none">
              <input id="otpInput" class="input" placeholder="Enter OTP" />
            </div>

            <div id="phoneMsg" class="note"></div>
          </div>
        </div>

        <!-- PROFILE: visible after login -->
        <div class="card" id="profileCard" style="margin-top:16px;display:none">
          <div class="section-title">Your profile</div>

          <div style="display:flex;gap:12px;align-items:center">
            <img id="pfPic" class="profile-pic" src="https://via.placeholder.com/72" alt="Profile">
            <div>
              <div id="pfName" style="font-weight:800"></div>
              <div id="pfEmail" class="small"></div>
            </div>
          </div>

          <form id="profileForm" onsubmit="return false;">
            <div class="field">
              <label class="small">Full name</label>
              <input id="nameField" class="input" placeholder="Your full name">
            </div>

            <div class="field">
              <label class="small">Phone</label>
              <input id="phoneField" class="input" placeholder="Mobile number">
            </div>

            <div class="field">
              <label class="small">Email (optional)</label>
              <input id="emailField" class="input" placeholder="you@example.com">
            </div>

            <div class="field">
              <label class="small">Address</label>
              <input id="addressField" class="input" placeholder="House, street, area">
            </div>

            <div class="field">
              <label class="small">Pincode</label>
              <input id="pinField" class="input" placeholder="110001">
            </div>

            <div style="display:flex;gap:8px;margin-top:12px">
              <button id="saveProfileBtn" class="btn primary save-btn">Save profile</button>
              <button id="logoutBtn" class="btn ghost">Logout</button>
            </div>

            <div id="profileMsg" class="msg" style="display:none"></div>
          </form>
        </div>

      </div>

      <!-- RIGHT: help / tips / actions -->
      <aside>
        <div class="card">
          <div class="section-title">Why sign in?</div>
          <ul class="small" style="margin-top:8px;line-height:1.6">
            <li>Save addresses & speed up checkout</li>
            <li>Order history & tracking</li>
            <li>One-tap login across devices</li>
          </ul>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="section-title">Dev & Debug</div>
          <div class="small">
            <strong>LocalStorage keys</strong><br>
            <code>nj_user</code> — saved user object<br>
            <code>nj_checkout</code> — saved checkout snapshot
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="section-title">Support</div>
          <div class="small">Call/WhatsApp: +91 70629 18607<br>Email: support@njmart.example</div>
        </div>
      </aside>
    </div>

    <footer>NJ Mart • Keep your Firebase config & script-config.js updated for full functionality</footer>
  </div>

  <!-- ================= SCRIPT ================= -->
  <script>
  /******************************************************************
   * Final expanded login.html script
   * Uses firebase v8 auth (firebase-app.js + firebase-auth.js loaded above)
   * Requires firebaseConfig variable (from firebase-config.js)
   * Optional: SCRIPT_URL from script-config.js to save profile to Google Sheet via Apps Script
   ******************************************************************/

  // Initialize Firebase
  if(typeof firebaseConfig === 'undefined'){
    console.error('firebaseConfig missing — add firebase-config.js with your project config.');
    alert('Firebase config missing. Add firebase-config.js and reload.');
  } else {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = firebase.auth();

  // DOM refs
  const btnGoogle = document.getElementById('btnGoogle');
  const btnSendOtp = document.getElementById('sendOtpBtn');
  const btnVerifyOtp = document.getElementById('verifyOtpBtn');
  const phoneInput = document.getElementById('phoneInput');
  const otpInput = document.getElementById('otpInput');
  const otpRow = document.getElementById('otpRow');
  const phoneMsg = document.getElementById('phoneMsg');

  const profileCard = document.getElementById('profileCard');
  const profileForm = document.getElementById('profileForm');
  const pfPic = document.getElementById('pfPic');
  const pfName = document.getElementById('pfName');
  const pfEmail = document.getElementById('pfEmail');
  const nameField = document.getElementById('nameField');
  const phoneField = document.getElementById('phoneField');
  const emailField = document.getElementById('emailField');
  const addressField = document.getElementById('addressField');
  const pinField = document.getElementById('pinField');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const profileMsg = document.getElementById('profileMsg');

  // reCAPTCHA verifier (render once)
  let recaptchaVerifier = null;
  function ensureRecaptcha(){
    if(recaptchaVerifier) return;
    // invisible reCAPTCHA container
    recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      size: 'invisible',
      callback: function(response){
        // reCAPTCHA solved - will proceed with signInWithPhoneNumber
      }
    });
    // render explicitly (optional, returns widgetId)
    recaptchaVerifier.render().then(function(widgetId){
      // widgetId available if needed
    });
  }

  // ---------- GOOGLE SIGN-IN ----------
  btnGoogle.addEventListener('click', async ()=>{
    try{
      const provider = new firebase.auth.GoogleAuthProvider();
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      const userObj = {
        uid: user.uid,
        name: user.displayName || '',
        email: user.email || '',
        phone: user.phoneNumber || '',
        photo: user.photoURL || ''
      };
      onLoginSuccess(userObj, 'Signed in with Google');
    }catch(err){
      console.error('Google sign-in error', err);
      alert('Google sign-in failed: ' + (err.message || err));
    }
  });

  // ---------- PHONE OTP ----------
  let confirmationResult = null;

  btnSendOtp.addEventListener('click', async ()=>{
    const phone = phoneInput.value.trim();
    if(!phone){ phoneMsg.textContent = 'Enter phone number with country code (e.g. +91 9123456789)'; phoneMsg.className='note'; return; }
    ensureRecaptcha();
    phoneMsg.textContent = 'Sending OTP...'; phoneMsg.className='note';

    try{
      // firebase v8: signInWithPhoneNumber
      confirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);
      // show OTP input
      otpRow.style.display = 'block';
      btnVerifyOtp.disabled = false;
      phoneMsg.textContent = 'OTP sent. Please enter the code.';
      phoneMsg.className='note';
    }catch(err){
      console.error('sendOtp error',err);
      phoneMsg.textContent = 'Failed to send OTP: ' + (err.message||err);
      phoneMsg.className='note';
      // reset recaptcha in case of error
      if(recaptchaVerifier) recaptchaVerifier.clear();
    }
  });

  btnVerifyOtp.addEventListener('click', async ()=>{
    const code = otpInput.value.trim();
    if(!code){ phoneMsg.textContent = 'Enter the OTP'; return; }
    try{
      const result = await confirmationResult.confirm(code);
      const user = result.user;
      const userObj = {
        uid: user.uid,
        name: user.displayName || '',
        email: user.email || '',
        phone: user.phoneNumber || phoneInput.value.trim(),
        photo: user.photoURL || ''
      };
      onLoginSuccess(userObj, 'Phone verified');
    }catch(err){
      console.error('verifyOtp error',err);
      phoneMsg.textContent = 'OTP verification failed: ' + (err.message||err);
      phoneMsg.className='note';
    }
  });

  // ---------- common: after login ----------
  function onLoginSuccess(userObj, note){
    // save locally
    localStorage.setItem('nj_user', JSON.stringify(userObj));

    // show profile card and populate fields
    showProfile(userObj);

    // optionally save to Apps Script (if SCRIPT_URL provided)
    if(typeof SCRIPT_URL !== 'undefined' && SCRIPT_URL){
      // call addCustomer action of your Apps Script
      try{
        fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ type: 'addCustomer', customer: {
            id: userObj.uid,
            name: userObj.name,
            email: userObj.email,
            phone: userObj.phone,
            address: '',
            pincode: ''
          }})
        }).catch(e=>console.warn('AppsScript addCustomer failed', e));
      }catch(e){ console.warn(e); }
    }

    // small message
    profileMsg.style.display = 'block';
    profileMsg.className = 'msg success';
    profileMsg.textContent = note + '. Profile loaded.';

    // redirect to home after short delay so user sees success
    setTimeout(()=>{ location.href = 'index.html'; }, 900);
  }

  // ---------- profile UI ----------
  function showProfile(userObj){
    profileCard.style.display = 'block';
    document.getElementById('loginCard').style.display = 'none';

    pfPic.src = userObj.photo || 'https://via.placeholder.com/72';
    pfName.textContent = userObj.name || (userObj.phone || 'Customer');
    pfEmail.textContent = userObj.email || '';

    // populate form
    nameField.value = userObj.name || '';
    phoneField.value = userObj.phone || '';
    emailField.value = userObj.email || '';
  }

  // Save profile button
  saveProfileBtn.addEventListener('click', async ()=>{
    const u = JSON.parse(localStorage.getItem('nj_user') || 'null');
    if(!u){ alert('Not logged in'); return; }

    const payload = {
      id: u.uid,
      name: nameField.value.trim(),
      phone: phoneField.value.trim(),
      email: emailField.value.trim(),
      address: addressField.value.trim(),
      pincode: pinField.value.trim()
    };

    // update local storage
    const newUser = Object.assign({}, u, { name: payload.name, email: payload.email, phone: payload.phone });
    localStorage.setItem('nj_user', JSON.stringify(newUser));
    pfName.textContent = payload.name || payload.phone;
    pfEmail.textContent = payload.email || '';

    // show success
    profileMsg.style.display = 'block';
    profileMsg.className = 'msg success';
    profileMsg.textContent = 'Profile saved locally';

    // optional: send to Apps Script backend
    if(typeof SCRIPT_URL !== 'undefined' && SCRIPT_URL){
      try{
        await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ type: 'updateCustomer', customer: {
            id: payload.id, name: payload.name, phone: payload.phone, email: payload.email, address: payload.address, pincode: payload.pincode
          }})
        });
        profileMsg.textContent = 'Profile saved to server';
      }catch(err){
        console.warn('save profile to script failed',err);
        profileMsg.textContent = 'Saved locally (server save failed)';
        profileMsg.className = 'msg error';
      }
    }
  });

  // Logout
  logoutBtn.addEventListener('click', async ()=>{
    // firebase sign out
    try{ await auth.signOut(); }catch(e){}
    localStorage.removeItem('nj_user');
    // reset UI
    profileCard.style.display = 'none';
    document.getElementById('loginCard').style.display = 'block';
    profileMsg.style.display = 'none';
    // reload page
    location.reload();
  });

  // ---------- auto-check on load: existing local user ----------
  (function boot(){
    const saved = JSON.parse(localStorage.getItem('nj_user') || 'null');
    if(saved){
      // show profile UI directly
      showProfile(saved);
    } else {
      // show login UI
      document.getElementById('loginCard').style.display = 'block';
      profileCard.style.display = 'none';
    }

    // prepare recaptcha (but keep invisible until needed)
    try{ ensureRecaptcha(); }catch(e){ console.warn('recaptcha init failed', e); }

    // small UX: enable Enter key on OTP input
    otpInput.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter'){ btnVerifyOtp.click(); }
    });
  })();

  </script>
</body>
</html>
