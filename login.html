<!-- ===========================
     login.html  — NJ Mart (FINAL)
     Part 1 of 3
     Copy Part1, then Part2, then Part3 into a single file.
     =========================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Login</title>
  <meta name="description" content="NJ Mart — Login & account. Sign in with Google or Phone OTP." />

  <!-- ====== Fonts & icons ====== -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- ====== Page styles (light, responsive) ====== -->
  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2db34a;
      --accent-dark:#1f8a34;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(12,30,40,0.06);
      --max-width:960px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    .wrap{max-width:var(--max-width);margin:20px auto;padding:18px}
    header.site-header{
      background:var(--card);
      border-radius:12px;
      box-shadow:var(--shadow);
      padding:12px 16px;
      display:flex;align-items:center;gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px}
    h1.brand-title{font-size:18px;margin:0}
    .muted{color:var(--muted)}

    /* layout */
    .main{display:grid;grid-template-columns:420px 1fr;gap:16px;margin-top:16px}
    @media(max-width:900px){ .main{grid-template-columns:1fr} }

    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow)}
    .muted-sm{color:var(--muted);font-size:13px}
    .btn{border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e6eef0}

    .auth-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1px solid #e6eef0;background:#fff;cursor:pointer}
    .auth-btn .icon{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center}

    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-weight:700;font-size:13px}
    input[type="text"], input[type="tel"], input[type="email"]{
      padding:10px;border-radius:8px;border:1px solid #e6eef0;background:#fff;font-size:14px;
    }

    .small-note{font-size:12px;color:var(--muted);margin-top:8px}

    /* help / status box */
    .status-box{padding:10px;border-radius:8px;background:#f5ffef;border:1px solid rgba(45,179,74,0.08);color:var(--accent-dark);font-weight:600}

    /* center content */
    .center{display:flex;align-items:center;justify-content:center}

    /* bottom links */
    .links-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .help{font-size:13px;color:var(--muted)}
    .divider{height:1px;background:#f1f3f4;margin:10px 0;border-radius:4px}
  </style>

  <!-- =========================
       Firebase SDKs — MUST be included BEFORE any firebase-config or code that uses firebase.
       Using compat libraries (so older style firebase.* calls still work).
       ========================= -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- Part 1 ends here; Part 2 contains firebase-config + helper core + UI body start -->
</head>
<body>

  <div class="wrap">

    <header class="site-header" role="banner">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>
          <h1 class="brand-title">NJ Mart</h1>
          <div class="muted" style="font-size:12px">Login & account</div>
        </div>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <a href="index.html" class="btn ghost">Home</a>
        <a href="checkout.html" class="btn primary">Checkout</a>
      </div>
    </header>

    <div class="main" role="main">

      <!-- LEFT: auth card -->
      <aside>
        <div class="card">
          <h2 style="margin:0 0 8px 0">Sign in or create account</h2>
          <div class="muted-sm">Secure & fast — sign in with Google or Phone OTP</div>

          <div style="height:12px"></div>

          <!-- Google sign in -->
          <div id="btnGoogle" class="auth-btn" role="button" aria-label="Sign in with Google">
            <div class="icon" aria-hidden>
              <svg width="20" height="20" viewBox="0 0 488 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill="#EA4335" d="M..."></path>
              </svg>
            </div>
            <div style="flex:1;font-weight:700">Sign in with Google</div>
          </div>

          <div class="divider"></div>

          <!-- Phone OTP -->
          <div>
            <h3 style="margin:0 0 8px 0">Phone OTP</h3>
            <div class="muted-sm">Enter your phone number with country code (e.g. +91xxxxxxxxxx)</div>

            <div class="field" style="margin-top:10px">
              <label for="phoneInput">Phone</label>
              <input id="phoneInput" type="tel" placeholder="+91xxxxxxxxxx" />
            </div>

            <!-- recaptcha placeholder -->
            <div id="recaptcha-container" class="center" style="margin:8px 0"></div>

            <div style="display:flex;gap:8px">
              <button id="btnSendOtp" class="btn primary" style="flex:1">Send OTP</button>
              <button id="btnVerifyOtp" class="btn ghost" style="flex:1;display:none">Verify OTP</button>
            </div>

            <div id="otpRow" style="display:none;margin-top:8px">
              <div class="field">
                <label for="otpInput">Enter OTP</label>
                <input id="otpInput" type="text" placeholder="6-digit code" />
              </div>
            </div>

            <div id="authNote" class="small-note">OTP-based login requires Firebase phone auth to be configured (reCAPTCHA & authorized domain).</div>
          </div>

          <div class="divider"></div>

          <div class="small-note">Why sign in? Save profile (address, phone) to reuse at checkout — view orders & faster checkout.</div>
        </div>
      </aside>

<!-- =========================
     Firebase config and script-core (inline)
     ========================= -->
      <!-- RIGHT: account & quick actions -->
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">Create or sign in</h2>
              <div class="muted-sm">Use Google or Phone OTP. Email/password intentionally not used to keep flow simple.</div>
            </div>
            <div id="statusBadge" class="status-box">Not signed in</div>
          </div>

          <div class="divider"></div>

          <div id="accountArea">
            <div id="signedOutBlock">
              <div style="padding:12px 0">
                <div class="help">You are not signed in. Use Google or Phone OTP to sign in.</div>
                <div style="margin-top:12px">
                  <button id="btnCheckLocal" class="btn ghost">Check saved profile</button>
                </div>
              </div>
            </div>

            <div id="signedInBlock" style="display:none">
              <div style="display:flex;gap:12px;align-items:center">
                <div style="width:72px;height:72px;border-radius:12px;background:#f2f6f4;display:flex;align-items:center;justify-content:center;font-weight:700" id="uiAvatar">NJ</div>
                <div>
                  <div id="uiName" style="font-weight:800">User</div>
                  <div id="uiPhone" class="muted-sm">phone</div>
                </div>
              </div>

              <div class="divider"></div>

              <div class="field">
                <label for="uiAddress">Delivery address</label>
                <textarea id="uiAddress" placeholder="House no, locality, city, pin..." rows="3" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0"></textarea>
              </div>

              <div style="display:flex;gap:8px">
                <button id="btnSaveProfileLocal" class="btn primary">Save profile</button>
                <button id="btnSignOutNow" class="btn ghost">Sign out</button>
              </div>
            </div>

          </div>

        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h3 style="margin:0 0 8px 0">Help</h3>
          <div class="muted-sm">Need help logging in? Contact support or check Firebase console settings (authorized domains, phone auth, recaptcha).</div>
        </div>
      </section>

    </div> <!-- main -->
  </div> <!-- wrap -->

  <!-- =========================
       Inline Firebase config + NJ core script
       NOTE: This block initializes Firebase and sets up helper functions for authentication.
       ========================= -->
  <script>
  /******************************************************************
   * NJ Mart — Inline Firebase + core helpers (used by login page)
   * This file intentionally inlined so you can copy/paste single file.
   *
   * IMPORTANT:
   * - Firebase SDK scripts must be loaded BEFORE this script (they are in head).
   * - Replace BACKEND_URL if you re-deploy Apps Script backend.
   ******************************************************************/

  // ---------------- CONFIG ----------------
  const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwsG5H7er3nqwGjEbrtokssc5LeGFc9Zog2bG1s0C5bQ-P2b_1S1kisSLpOmdESH7FB/exec';
  // Firebase config (from your project) — already filled for NJ Mart
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCbf19k8pLFh-9UQz8sQRim2rPYTIqaEL8",
    authDomain: "njmartonline.firebaseapp.com",
    projectId: "njmartonline",
    storageBucket: "njmartonline.appspot.com",
    messagingSenderId: "594505763627",
    appId: "1:594505763627:web:a13bd3ef40e620f9b936e"
  };

  // ---------------- init firebase ----------------
  (function initFirebase(){
    try{
      if(typeof firebase === 'undefined'){
        console.error('Firebase SDK not found — ensure <script> includes loaded before this block.');
        return;
      }
      if(!firebase.apps || !firebase.apps.length){
        firebase.initializeApp(FIREBASE_CONFIG);
        console.log('Firebase initialized for NJ Mart.');
      }
    }catch(err){
      console.error('Firebase init error:', err);
    }
  })();

  // short handles
  const _auth = (typeof firebase !== 'undefined' && firebase.auth) ? firebase.auth() : null;
  const _db = (typeof firebase !== 'undefined' && firebase.firestore) ? firebase.firestore() : null;

  // ---------------- local keys ----------------
  const KEY_PROFILE = 'nj_profile';

  // small helper
  function el(id){ return document.getElementById(id); }
  function showStatus(text, color){ const b = el('statusBadge'); if(!b) return; b.textContent = text; if(color) b.style.color = color; }

  // ------- local profile helpers --------
  function saveLocalProfile(profile){
    try{ localStorage.setItem(KEY_PROFILE, JSON.stringify(profile||{})); }catch(e){}
  }
  function loadLocalProfile(){
    try{ const raw = localStorage.getItem(KEY_PROFILE); return raw ? JSON.parse(raw) : null; }catch(e){ return null; }
  }
  function clearLocalProfile(){
    try{ localStorage.removeItem(KEY_PROFILE); }catch(e){} 
    renderSignedOut();
  }

  // ---------------- UI helpers ----------------
  function renderSignedOut(){
    el('signedInBlock').style.display = 'none';
    el('signedOutBlock').style.display = 'block';
    showStatus('Not signed in',''); 
  }
  function renderSignedIn(profile){
    el('signedOutBlock').style.display = 'none';
    el('signedInBlock').style.display = 'block';
    el('uiName').textContent = profile.Name || 'User';
    el('uiPhone').textContent = profile.Phone || '';
    el('uiAddress').value = profile.Address || '';
    el('uiAvatar').textContent = ( (profile.Name||'').split(' ').slice(0,2).map(s=>s[0]).join('').toUpperCase() ) || 'NJ';
    showStatus('Signed in','var(--accent-dark)');
  }

  // ---------------- API helpers (backend) ----------------
  async function apiGet(params){
    const url = new URL(BACKEND_URL);
    Object.keys(params||{}).forEach(k=>url.searchParams.set(k, params[k]));
    try{
      const res = await fetch(url.toString(), { method:'GET', cache:'no-store' });
      return await res.json();
    }catch(err){
      return { ok:false, error: String(err) };
    }
  }
  async function apiPost(body){
    try{
      const res = await fetch(BACKEND_URL, {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      return await res.json();
    }catch(err){
      return { ok:false, error: String(err) };
    }
  }

  // ---------------- Auth helpers ----------------
  // Google sign-in popup
  async function signInWithGoogle(){
    if(!_auth){ alert('Firebase Auth not ready'); return; }
    const provider = new firebase.auth.GoogleAuthProvider();
    try{
      const result = await _auth.signInWithPopup(provider);
      const user = result.user;
      // create minimal profile
      const profile = {
        Name: user.displayName || '',
        Phone: user.phoneNumber || '',
        Email: user.email || '',
        Address: '',
        uid: user.uid || ''
      };
      saveLocalProfile(profile);
      renderSignedIn(profile);
      // optionally call backend to create customer
      await apiPost({ action:'addcustomer', Name: profile.Name, Phone: profile.Phone, Email: profile.Email, Address: profile.Address });
      return profile;
    }catch(err){
      console.error('Google sign-in failed', err);
      alert('Google sign-in failed: ' + (err && err.message ? err.message : String(err)));
    }
  }

  // Part 2 ends here — Part 3 contains Phone OTP flow and event wiring + final closure
  </script>
<!-- =========================
     Part 3 of 3
     Phone OTP flow, event wiring, and final logic
     ========================= -->
  <script>
  /*****************************************************************
   * Phone OTP flow & page wiring
   *****************************************************************/

  // reCAPTCHA verifier placeholder (invisible)
  let recaptchaVerifier = null;
  let confirmationResult = null;

  function setupRecaptcha(){
    if(!window.firebase || !firebase.auth) {
      console.warn('Firebase not available for reCAPTCHA setup.');
      return;
    }
    // Use invisible reCAPTCHA bound to #recaptcha-container
    try{
      recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        size: 'invisible',
        callback: function(response){
          // reCAPTCHA solved — proceed with sign-in
          console.log('reCAPTCHA solved');
        }
      });
      recaptchaVerifier.render().then(widgetId=>{
        console.log('reCAPTCHA rendered, widget id:', widgetId);
      });
    }catch(err){
      console.error('recaptcha init error', err);
    }
  }

  // send OTP
  async function sendOtpForPhone(phone){
    if(!_auth) { alert('Auth not ready'); return; }
    if(!recaptchaVerifier) setupRecaptcha();
    try{
      el('btnSendOtp').disabled = true;
      el('btnSendOtp').textContent = 'Sending…';
      confirmationResult = await _auth.signInWithPhoneNumber(phone, recaptchaVerifier);
      // show OTP UI
      el('otpRow').style.display = 'block';
      el('btnVerifyOtp').style.display = 'inline-block';
      showStatus('OTP sent — check SMS','var(--accent-dark)');
    }catch(err){
      console.error('sendOtp error', err);
      alert('Failed to send OTP: ' + (err && err.message ? err.message : String(err)));
      // reset recaptcha if needed
      try{ recaptchaVerifier.clear(); }catch(e){}
    }finally{
      el('btnSendOtp').disabled = false;
      el('btnSendOtp').textContent = 'Send OTP';
    }
  }

  // verify OTP
  async function verifyOtp(code){
    if(!confirmationResult){
      alert('No OTP flow started. Click Send OTP first.');
      return;
    }
    try{
      el('btnVerifyOtp').disabled = true;
      el('btnVerifyOtp').textContent = 'Verifying…';
      const res = await confirmationResult.confirm(code);
      const user = res.user;
      const profile = {
        Name: user.displayName || '',
        Phone: user.phoneNumber || el('phoneInput').value.trim(),
        Email: user.email || '',
        Address: ''
      };
      saveLocalProfile(profile);
      renderSignedIn(profile);
      // call backend to append customer row
      await apiPost({ action:'addcustomer', Name: profile.Name, Phone: profile.Phone, Email: profile.Email, Address: profile.Address });
      alert('Phone verified — signed in');
    }catch(err){
      console.error('OTP verify failed', err);
      alert('OTP verify failed: ' + (err && err.message ? err.message : String(err)));
    }finally{
      el('btnVerifyOtp').disabled = false;
      el('btnVerifyOtp').textContent = 'Verify OTP';
    }
  }

  // sign out
  async function signOutNow(){
    try{
      if(_auth) await _auth.signOut();
    }catch(e){}
    clearLocalProfile();
    alert('Signed out');
  }

  // save profile to backend (manual)
  async function saveProfileToBackend(){
    const profile = loadLocalProfile();
    if(!profile || !profile.Phone) { alert('No profile to save'); return; }
    const res = await apiPost({ action:'addcustomer', Name: profile.Name, Phone: profile.Phone, Email: profile.Email||'', Address: el('uiAddress').value || profile.Address || '' });
    if(res && res.ok){
      showStatus('Profile saved to backend');
      // update local
      profile.Address = el('uiAddress').value || profile.Address || '';
      saveLocalProfile(profile);
    }else{
      alert('Save failed: ' + (res && res.error ? res.error : 'unknown'));
    }
  }

  // ---------------- Init & event wiring ----------------
  async function initPage(){
    // Setup recaptcha (if firebase ready)
    try{ setupRecaptcha(); }catch(e){ console.warn(e); }

    // Wire events
    el('btnGoogle').addEventListener('click', async ()=>{
      el('btnGoogle').setAttribute('disabled','disabled');
      await signInWithGoogle();
      el('btnGoogle').removeAttribute('disabled');
    });

    el('btnSendOtp').addEventListener('click', async ()=>{
      const phone = el('phoneInput').value.trim();
      if(!phone){ alert('Enter phone number'); el('phoneInput').focus(); return; }
      // basic validation
      const digits = phone.replace(/\D/g,'');
      if(digits.length < 10){ alert('Enter valid phone'); el('phoneInput').focus(); return; }
      await sendOtpForPhone(phone);
    });

    el('btnVerifyOtp').addEventListener('click', async ()=>{
      const code = el('otpInput').value.trim();
      if(!code){ alert('Enter OTP'); el('otpInput').focus(); return; }
      await verifyOtp(code);
    });

    el('btnCheckLocal').addEventListener('click', ()=>{
      const p = loadLocalProfile();
      if(!p) return alert('No saved profile');
      alert('Saved: ' + (p.Name||'') + ' — ' + (p.Phone||''));
    });

    el('btnSignOutNow').addEventListener('click', signOutNow);
    el('btnSaveProfileLocal').addEventListener('click', saveProfileToBackend);

    // On load: if local profile exists, render signed in
    const p = loadLocalProfile();
    if(p && p.Phone){
      renderSignedIn(p);
    }else{
      renderSignedOut();
    }

    // If firebase auth state changes (someone signed in via google popup), update UI
    if(_auth){
      _auth.onAuthStateChanged(async (user)=>{
        if(user){
          const profile = {
            Name: user.displayName || '',
            Phone: user.phoneNumber || '',
            Email: user.email || '',
            Address: ''
          };
          saveLocalProfile(profile);
          renderSignedIn(profile);
        }else{
          // signed out
        }
      });
    }

    console.log('NJ Mart login page loaded. BACKEND URL:', BACKEND_URL);
  }

  document.addEventListener('DOMContentLoaded', initPage);
  </script>

</body>
</html>  
