<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NJ Mart — Login</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--green:#2db34a;--muted:#7c8086;--bg:#f4f7f8;--card:#fff}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Roboto,Segoe UI,sans-serif;background:var(--bg);color:#0b1220}
  .page{max-width:920px;margin:16px auto;padding:14px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(12,30,40,.06);padding:18px}
  h1{margin:0 0 10px 0;font-size:22px}
  .google-btn{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;border:1px solid #e6e9eb;background:#fff;cursor:pointer}
  .or{display:flex;align-items:center;gap:8px;color:var(--muted);margin:12px 0}
  .or div{flex:1;height:1px;background:#e6e9eb}
  input[type="tel"]{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9eb;font-size:15px}
  .row{display:flex;gap:10px;margin-top:12px}
  .btn{flex:1;padding:12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--green);color:#fff}
  .btn.ghost{background:#fff;border:1px solid #e6e9eb}
  .muted{color:var(--muted);font-size:13px;margin-top:10px}
  .otp-box{margin-top:12px;display:none}
  .notice{background:#f3fff4;padding:10px;border-radius:8px;color:#155724;margin-top:12px}
  @media(min-width:720px){.page{padding:20px}}
</style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>Sign in to NJ Mart</h1>

      <!-- Google sign-in (works if Firebase config is added) -->
      <div id="googleSign" class="google-btn" role="button" aria-label="Sign in with Google">
        <img src="https://www.gstatic.com/devrel-devsite/prod/vb2f8a1b1d1c6b0ed4adb0e0a6c3d5b0f2e6c2b1d8a1ec9c3f2a0f86b6a2ce6e/firebase/images/touchicon-180.png" style="width:24px;height:24px">
        <div style="flex:1">Sign in with Google</div>
      </div>

      <div class="or" aria-hidden="true">
        <div></div><div style="width:40px;text-align:center">or</div><div></div>
      </div>

      <!-- Phone number -->
      <label for="phone">Phone number</label>
      <input id="phone" type="tel" placeholder="+91 9876543210" />

      <div class="row">
        <button id="sendOtp" class="btn primary">Send OTP</button>
        <button id="clearSession" class="btn ghost">Clear local session</button>
      </div>

      <div id="otpBox" class="otp-box">
        <label for="otp">Enter OTP</label>
        <input id="otp" type="text" placeholder="123456" />
        <div class="row" style="margin-top:8px">
          <button id="verifyOtp" class="btn primary">Verify OTP</button>
          <button id="cancelOtp" class="btn ghost">Cancel</button>
        </div>
        <div class="muted">Demo: If Firebase not configured, enter <strong>123456</strong> as OTP to simulate success.</div>
      </div>

      <div id="signedMsg" class="notice" style="display:none"></div>

      <div class="muted">By signing in you agree to our Terms & Privacy.</div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Welcome to NJ Mart</h3>
      <div class="muted">Fast grocery delivery. Your profile and orders are saved locally in this demo.</div>
    </div>
  </div>

  <!-- Optional Firebase SDK - only include if you plan to enable real Google/phone auth.
       If you use Firebase, paste your firebaseConfig below in the FIREBASE_CONFIG object.
  -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
/*
  login.html
  - If you add FIREBASE_CONFIG (object), Google & phone auth will try to use Firebase.
  - If not configured or Firebase fails, fallback demo OTP is used (enter 123456).
  - On success: saves localStorage 'nj_user' = {email, phone, name?} and redirects to profile.html?next=checkout
*/

// =========== CONFIG ===========
// If you want real Firebase auth, replace FIREBASE_CONFIG with your project's config.
// Example:
// const FIREBASE_CONFIG = {
//   apiKey: "...",
//   authDomain: "yourproject.firebaseapp.com",
//   projectId: "...",
//   appId: "..."
// };
const FIREBASE_CONFIG = null; // <-- set to your config object (or keep null for demo fallback)

// ===============================
let firebaseAuth = null;
if(FIREBASE_CONFIG){
  try{
    firebase.initializeApp(FIREBASE_CONFIG);
    firebaseAuth = firebase.auth();
    console.log('Firebase initialized');
  }catch(e){
    console.warn('Firebase init failed', e);
    firebaseAuth = null;
  }
}

const googleSign = document.getElementById('googleSign');
const phoneEl = document.getElementById('phone');
const sendOtpBtn = document.getElementById('sendOtp');
const otpBox = document.getElementById('otpBox');
const otpInput = document.getElementById('otp');
const verifyOtpBtn = document.getElementById('verifyOtp');
const cancelOtpBtn = document.getElementById('cancelOtp');
const clearSessionBtn = document.getElementById('clearSession');
const signedMsg = document.getElementById('signedMsg');

// helper: save user and redirect
function onSignSuccess(userObj){
  // userObj: { email?, phone?, name? }
  try{
    localStorage.setItem('nj_user', JSON.stringify(userObj));
  }catch(e){}
  signedMsg.style.display = 'block';
  signedMsg.textContent = 'Signed in as: ' + (userObj.email || userObj.phone || 'User');
  setTimeout(()=>{
    // after sign in redirect to profile to complete details
    const next = new URLSearchParams(location.search).get('next') || 'profile.html?next=checkout';
    location.href = next;
  },900);
}

// Google sign flow
googleSign.addEventListener('click', async ()=>{
  if(firebaseAuth){
    const provider = new firebase.auth.GoogleAuthProvider();
    try{
      const res = await firebaseAuth.signInWithPopup(provider);
      const u = res.user;
      onSignSuccess({ email: u.email, name: u.displayName, phone: u.phoneNumber });
    }catch(err){
      alert('Google sign-in failed: ' + (err.message||err));
    }
  } else {
    // demo: ask for email and sign in locally
    const email = prompt('Firebase not configured. Enter email to simulate Google sign-in:');
    if(email) onSignSuccess({ email });
  }
});

// Phone OTP flow
sendOtpBtn.addEventListener('click', async ()=>{
  const phone = phoneEl.value.trim();
  if(!phone){ alert('Enter phone number'); phoneEl.focus(); return; }

  if(firebaseAuth){
    // real Firebase flow: we need to render reCAPTCHA container.
    // For simplicity we create an invisible recaptcha each time.
    try{
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('sendOtp', {
        'size': 'invisible',
        'callback': (response) => { /* recaptcha solved */ }
      });
      const appVerifier = window.recaptchaVerifier;
      const confirmationResult = await firebaseAuth.signInWithPhoneNumber(phone, appVerifier);
      window.confirmationResult = confirmationResult;
      otpBox.style.display = 'block';
      alert('OTP sent via Firebase — enter it below.');
    }catch(e){
      alert('Firebase phone auth failed. Falling back to demo OTP.\n\n' + (e.message||e));
      otpBox.style.display = 'block';
    }
  } else {
    // demo: show OTP box and "pretend" to send code
    otpBox.style.display = 'block';
    alert('Demo mode: OTP sent (use 123456 to verify).');
  }
});

// verify OTP
verifyOtpBtn.addEventListener('click', async ()=>{
  const code = otpInput.value.trim();
  const phone = phoneEl.value.trim();
  if(!code){ alert('Enter OTP'); otpInput.focus(); return; }

  if(firebaseAuth && window.confirmationResult){
    try{
      const res = await window.confirmationResult.confirm(code);
      const u = res.user;
      onSignSuccess({ phone: u.phoneNumber, uid: u.uid });
    }catch(e){
      alert('Firebase verification failed: ' + (e.message||e));
    }
  } else {
    // demo verification accept 123456 only
    if(code === '123456'){
      onSignSuccess({ phone });
    } else {
      alert('Invalid demo OTP. Use 123456 in demo mode.');
    }
  }
});

// cancel OTP
cancelOtpBtn.addEventListener('click', ()=>{
  otpBox.style.display = 'none';
  otpInput.value = '';
});

// clear local session
clearSessionBtn.addEventListener('click', ()=>{
  if(confirm('Clear local session and saved user info?')){
    localStorage.removeItem('nj_user');
    signedMsg.style.display = 'block';
    signedMsg.textContent = 'Local session cleared';
    setTimeout(()=> signedMsg.style.display = 'none',2500);
  }
});

// if already signed in, redirect to profile
(function init(){
  const raw = localStorage.getItem('nj_user');
  if(raw){
    try{
      const u = JSON.parse(raw);
      signedMsg.style.display = 'block';
      signedMsg.textContent = 'Already signed in: ' + (u.email || u.phone || 'User');
      setTimeout(()=>{ location.href = 'profile.html?next=checkout'; },900);
    }catch(e){}
  }
})();
</script>
</body>
</html>
