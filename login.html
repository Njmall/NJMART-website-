<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Admin Login</title>

  <!-- ======= Basic Styling (Expandible) ======= -->
  <style>
    :root{
      --brand: #2da84f;
      --brand-dark: #23823d;
      --muted:#6b7280;
      --bg:#f7fafc;
      --card:#ffffff;
      --danger:#e53e3e;
      --glass: rgba(255,255,255,0.85);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,#f0fbf6 0%, #f7fafc 100%);color:#111827;}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;}
    .card{
      width:980px;
      max-width:98%;
      background:var(--card);
      border-radius:14px;
      box-shadow: 0 6px 30px rgba(14, 30, 37, 0.08);
      display:grid;
      grid-template-columns: 420px 1fr;
      overflow:hidden;
      border:1px solid rgba(15,23,42,0.03);
    }

    /* left panel - branding + info */
    .left{
      padding:28px;
      background:linear-gradient(180deg,var(--brand) 0%, #1fa742 100%);
      color:white;
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:flex-start;
      justify-content:center;
    }
    .brand{
      display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px;
    }
    .brand .logo{
      width:46px;height:46px;border-radius:10px;background:white;color:var(--brand);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;
    }
    .bigTitle{font-size:26px;font-weight:700;margin-top:6px}
    .desc{opacity:0.95;font-size:14px;line-height:1.45; margin-bottom:6px}
    .leftFooter{margin-top:18px;font-size:13px;opacity:0.95;}

    /* right panel - forms */
    .right{
      padding:28px 34px;
    }
    .tabs{
      display:flex;gap:18px;align-items:center;margin-bottom:18px;
    }
    .tab{cursor:pointer;padding:8px 12px;border-radius:10px;background:transparent;border:1px solid transparent;color:var(--muted);}
    .tab.active{background:var(--bg);border-color:rgba(15,23,42,0.04);color:#111;font-weight:600;}
    .form{
      background:transparent;padding:6px;display:flex;flex-direction:column;gap:12px;
    }

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"]{
      width:100%;padding:12px 12px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:transparent;outline:none;font-size:14px;
    }

    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;
      font-weight:600;
    }
    .btn-primary{background:var(--brand);color:white;box-shadow:0 6px 18px rgba(45,168,79,0.20)}
    .btn-ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:#111}
    .row{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px;color:var(--muted)}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#eee,transparent);margin:12px 0;border-radius:2px}

    .socialRow{display:flex;gap:8px}
    .socialBtn{padding:10px 12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);display:flex;gap:10px;align-items:center;background:white;cursor:pointer}
    .socialBtn .icon{width:18px;height:18px;display:inline-block}

    .error{color:var(--danger);font-size:13px}
    .success{color:green;font-size:13px}
    .hint{font-size:13px;color:var(--muted)}

    /* OTP area */
    .otpInputs{display:flex;gap:8px}
    .otpInputs input{width:48px;text-align:center;font-size:18px;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)}

    /* responsive */
    @media (max-width:880px){
      .card{grid-template-columns:1fr; padding:0}
      .left{display:none}
      .right{padding:22px}
    }

    /* footer small */
    .footer{margin-top:16px;font-size:13px;color:var(--muted);text-align:center}
    .support{font-weight:600;color:var(--brand-dark)}
  </style>

  <!-- ======= Firebase (compat) SDKs =======
       Using compat here keeps code compact and familiar (RecaptchaVerifier + auth)
       If you prefer modular SDK, replace with modular imports and update code accordingly.
  -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="njmart-heading">

      <!-- Left: Branding -->
      <div class="left" aria-hidden="false">
        <div class="brand">
          <div class="logo">NJ</div>
          <div>
            <div style="font-size:13px;opacity:0.95">NJ Mart</div>
            <div style="font-size:11px;opacity:0.8">Admin Panel</div>
          </div>
        </div>
        
        <div class="bigTitle" id="njmart-heading">NJ Mart Admin Login</div>
        <div class="desc">Secure admin access — use Email, Google or Phone OTP. Keep your credentials private. Use authorized domains in Firebase console for sign-in to work.</div>

        <div class="leftFooter">
          <div style="font-weight:700">Quick checklist</div>
          <ul style="padding-left:18px;margin:8px 0;line-height:1.6">
            <li>Auth methods enabled: Email, Google, Phone</li>
            <li>Authorized domain added in Firebase (e.g. njmart.netlify.app)</li>
            <li>APIs enabled (Identity Toolkit)</li>
            <li>Recaptcha for phone must be visible on the page</li>
          </ul>
        </div>
      </div>

      <!-- Right: Forms -->
      <div class="right">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-weight:800;font-size:18px">Sign in to your admin account</div>
          <div class="muted small">Support: <span class="support">+91 70000 00000</span></div>
        </div>

        <div class="tabs" role="tablist" aria-label="Auth methods">
          <div class="tab active" id="tab-email" data-tab="email">Email Login</div>
          <div class="tab" id="tab-phone" data-tab="phone">Phone Login (OTP)</div>
          <div class="tab" id="tab-google" data-tab="google">Google</div>
        </div>

        <!-- messages -->
        <div id="messageArea" class="muted small" aria-live="polite">Status: Ready</div>

        <!-- forms wrapper -->
        <div style="margin-top:12px;">
          <!-- Email form -->
          <div id="panel-email" class="panel" aria-hidden="false">
            <div class="form" role="form" aria-label="Email login form">
              <div>
                <label for="emailInput">Email</label>
                <input id="emailInput" type="email" placeholder="Enter admin email">
              </div>

              <div>
                <label for="passwordInput">Password</label>
                <input id="passwordInput" type="password" placeholder="Enter password">
              </div>

              <div class="row" style="justify-content:space-between;margin-top:8px">
                <div class="row">
                  <button id="emailSignInBtn" class="btn btn-primary">Login</button>
                  <button id="emailSignupBtn" class="btn btn-ghost" style="margin-left:8px">Sign up</button>
                </div>
                <div>
                  <a href="#" id="forgotLink" class="small">Forgot password?</a>
                </div>
              </div>

              <div class="hr"></div>

              <div class="small muted">Or sign in with</div>
              <div class="socialRow" style="margin-top:8px">
                <div id="googleBtn" class="socialBtn" title="Sign in with Google">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" width="18" height="18" aria-hidden="true">
                    <path d="M21 12.3c0-.7-.1-1.4-.2-2H12v3.8h5.5c-.2 1.1-.9 2.1-1.9 2.8v2.3h3.1c1.8-1.7 2.8-4 2.8-6.9z" fill="#4285F4"/>
                    <path d="M12 22c2.7 0 4.9-.9 6.6-2.5l-3.1-2.3c-.9.6-2.1.9-3.5.9-2.7 0-5-1.8-5.8-4.3H3.7v2.7C5.4 19.9 8.5 22 12 22z" fill="#34A853"/>
                    <path d="M6.2 14.8A6.99 6.99 0 016 12c0-.9.2-1.7.6-2.5V6.7H3.7A10 10 0 002 12c0 1.6.3 3.1.9 4.4l2-1.6z" fill="#FBBC05"/>
                    <path d="M12 5.4c1.5 0 2.9.5 4 1.5l3-3C16.8 2.3 14.6 1.4 12 1.4 8.5 1.4 5.4 3.5 3.7 6.7l2.9 2.8C7 7.2 9.3 5.4 12 5.4z" fill="#EA4335"/>
                  </svg>
                  <span>Google</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Phone OTP form -->
          <div id="panel-phone" class="panel" style="display:none" aria-hidden="true">
            <div class="form" role="form" aria-label="Phone login form">
              <div>
                <label for="phoneInput">Phone number</label>
                <input id="phoneInput" type="tel" placeholder="+91 70629 18607">
              </div>

              <div id="recaptcha-container" style="margin:6px 0"></div>

              <div style="display:flex;gap:8px;margin-top:6px">
                <button id="sendOtpBtn" class="btn btn-primary">Send OTP</button>
                <button id="verifyOtpBtn" class="btn btn-ghost" style="display:none">Verify OTP</button>
              </div>

              <div style="margin-top:8px">
                <label for="otpInput">Enter OTP (6 digits)</label>
                <input id="otpInput" type="text" maxlength="6" placeholder="123456" style="width:160px">
              </div>

              <div class="hr"></div>
              <div class="hint">Phone auth uses a visible reCAPTCHA. If recaptcha render error appears, check authorized domains and API keys in Google Cloud console.</div>
            </div>
          </div>

        </div>

        <div class="hr"></div>

        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small muted">© NJ Mart — All rights reserved.</div>
          <div><button id="logoutBtn" class="btn btn-ghost" style="display:none">Logout</button></div>
        </div>
                <div class="footer">Need help? Add support email in Firebase console. Keep API keys rotated if leaked.</div>
      </div>
    </div>
  </div>

  <!-- ======= JS: Firebase config & auth logic ======= -->
  <script>
    /******************************************************************
     * IMPORTANT:
     * - You provided an API KEY; that is used below.
     * - Replace other firebaseConfig values if yours differ.
     * - Do NOT paste service account JSON here.
     ******************************************************************/

    const firebaseConfig = {
      apiKey: "AIzaSyCCyk9ZfXo2EgAFg3tWsF4N5_8fgncnZSI",  // <= YOUR API KEY (you provided)
      authDomain: "njmartonline.firebaseapp.com",        // example - update if different
      projectId: "njmartonline",
      storageBucket: "njmartonline.firebasestorage.app",
      messagingSenderId: "594505763627",
      appId: "1:594505763627:web:a13b0dae1f4e0e269fb936"  // example - update if different
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    // optional analytics: firebase.analytics();

    const auth = firebase.auth();
    const firestore = firebase.firestore();

    // UI elements
    const messageArea = document.getElementById('messageArea');
    const tabEmail = document.getElementById('tab-email');
    const tabPhone = document.getElementById('tab-phone');
    const tabGoogle = document.getElementById('tab-google');
    const panelEmail = document.getElementById('panel-email');
    const panelPhone = document.getElementById('panel-phone');

    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const emailSignInBtn = document.getElementById('emailSignInBtn');
    const emailSignupBtn = document.getElementById('emailSignupBtn');
    const forgotLink = document.getElementById('forgotLink');

    const googleBtn = document.getElementById('googleBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // Phone elements
    const phoneInput = document.getElementById('phoneInput');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const otpInput = document.getElementById('otpInput');
    let confirmationResult = null;

    // small helper to show status
    function setStatus(msg, cls){
      messageArea.textContent = msg;
      messageArea.className = cls ? cls : 'muted small';
      console.log('[STATUS]', msg);
    }

    // tab switching
    function showTab(name){
      tabEmail.classList.remove('active');
      tabPhone.classList.remove('active');
      tabGoogle.classList.remove('active');
      panelEmail.style.display = 'none';
      panelPhone.style.display = 'none';

      if(name === 'email'){ tabEmail.classList.add('active'); panelEmail.style.display='block';}
      if(name === 'phone'){ tabPhone.classList.add('active'); panelPhone.style.display='block'; }
      if(name === 'google'){ tabGoogle.classList.add('active'); panelEmail.style.display='block'; /* google uses email panel UI for button */ }
    }

    tabEmail.addEventListener('click', ()=> showTab('email'));
    tabPhone.addEventListener('click', ()=> showTab('phone'));
    tabGoogle.addEventListener('click', ()=> {
      showTab('google');
      // directly popup google sign in
      setTimeout(()=> { googleSignIn(); }, 150);
    });

    // ============ Email/Password ============
    emailSignInBtn.addEventListener('click', async (e)=>{
      setStatus('Logging in...', 'muted small');
      const email = (emailInput.value || '').trim();
      const password = (passwordInput.value || '').trim();
      if(!email || !password){ setStatus('Please enter email and password', 'error'); return; }
      try{
        const res = await auth.signInWithEmailAndPassword(email, password);
        setStatus('Login successful', 'success');
        onUserSignedIn(res.user);
      }catch(err){
        console.error(err);
        setStatus('Login failed: ' + (err.message||err.code), 'error');
      }
    });

    emailSignupBtn.addEventListener('click', async ()=>{
      const email = (emailInput.value || '').trim();
      const password = (passwordInput.value || '').trim();
      if(!email || !password){ setStatus('Please enter email and password to sign up', 'error'); return; }
      try{
        const res = await auth.createUserWithEmailAndPassword(email, password);
        setStatus('Sign up successful. Please verify email if needed.', 'success');
        // You can send email verification if your product requires:
        // res.user.sendEmailVerification();
      }catch(err){
        console.error(err);
        setStatus('Sign up failed: ' + (err.message||err.code), 'error');
      }
    });

    forgotLink.addEventListener('click', async (e)=>{
      e.preventDefault();
      const email = (emailInput.value || '').trim();
      if(!email){ setStatus('Enter your email to reset password', 'error'); return; }
      try{
        await auth.sendPasswordResetEmail(email);
        setStatus('Password reset email sent', 'success');
      }catch(err){ setStatus('Reset failed: ' + (err.message||err.code),'error');}
    });

    // ============ Google Sign-In ============
    async function googleSignIn(){
      setStatus('Opening Google sign-in...', 'muted small');
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('profile');
      provider.addScope('email');
      try{
        const res = await auth.signInWithPopup(provider);
        setStatus('Google sign-in successful', 'success');
        onUserSignedIn(res.user);
      }catch(err){
        console.error('Google sign-in error', err);
        setStatus('Google sign-in failed: ' + (err.message||err.code), 'error');
      }
    }
    googleBtn.addEventListener('click', googleSignIn);

    // ============ Phone Auth (OTP) ============
    // Render reCAPTCHA verifier once
    let recaptchaWidgetId = null;
    function renderRecaptcha(){
      try{
        // if already exists, clear and re-render
        if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function'){
          try{ window.recaptchaVerifier.clear(); }catch(e){ console.warn(e); }
        }
      }catch(e){ /* ignore */ }

      // create new recaptcha instance
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        size: 'normal', // change to 'invisible' if you want invisible (but phone requires visible sometimes)
        callback: function(response){
          console.log('reCAPTCHA solved', response);
        },
        'expired-callback': function(){ console.log('reCAPTCHA expired'); }
      });
      window.recaptchaVerifier.render().then(function(widgetId){
        recaptchaWidgetId = widgetId;
        console.log('recaptcha rendered id=', widgetId);
      }).catch(function(err){
        console.error('recaptcha render error', err);
        setStatus('reCAPTCHA render failed: ' + (err.message||err.code), 'error');
      });
    }

    // initial render
    renderRecaptcha();

    sendOtpBtn.addEventListener('click', async ()=>{
      const phone = (phoneInput.value || '').trim();
      if(!phone){ setStatus('Enter phone number (include country code)', 'error'); return; }
      setStatus('Sending OTP...', 'muted small');
      try{
        // ensure recaptchaVerifier exists
        if(!window.recaptchaVerifier){
          renderRecaptcha();
        }
        confirmationResult = await auth.signInWithPhoneNumber(phone, window.recaptchaVerifier);
        setStatus('OTP sent. Enter the code and click Verify', 'success');
        verifyOtpBtn.style.display = 'inline-flex';
        sendOtpBtn.style.display = 'none';
      }catch(err){
        console.error('send OTP error', err);
        setStatus('Send OTP failed: ' + (err.message||err.code), 'error');
        // reset recaptcha in case of error to allow retry
        try{ renderRecaptcha(); }catch(e){}
      }
    });

    verifyOtpBtn.addEventListener('click', async ()=>{
      const code = (otpInput.value || '').trim();
      if(!code || !confirmationResult){ setStatus('Enter OTP or request again', 'error'); return; }
      setStatus('Verifying OTP...', 'muted small');
      try{
        const res = await confirmationResult.confirm(code);
        setStatus('Phone login successful', 'success');
        onUserSignedIn(res.user);
      }catch(err){
        console.error('verify OTP error', err);
        setStatus('OTP verify failed: ' + (err.message||err.code), 'error');
      }
    });

    // ============ Auth listener ============
    auth.onAuthStateChanged(user=>{
      if(user){
        console.log('User signed in:', user);
        onUserSignedIn(user);
      }else{
        console.log('User signed out');
        onUserSignedOut();
      }
    });

    function onUserSignedIn(user){
      // show logout button + user info
      logoutBtn.style.display = 'inline-flex';
      document.getElementById('emailInput').value = user.email || '';
      setStatus('Signed in: ' + (user.displayName || user.email || user.phoneNumber || user.uid), 'success');

      // Example: check admin role in Firestore (optional)
      // firestore.collection('admins').doc(user.uid).get()...
      // For simple flow, we just stay logged in.

      // hide OTP send controls
      verifyOtpBtn.style.display = 'none';
      sendOtpBtn.style.display = 'none';
      // optionally redirect to admin dashboard:
      // window.location.href = '/admin/dashboard.html';
    }

    function onUserSignedOut(){
      logoutBtn.style.display = 'none';
      setStatus('No user logged in', 'muted small');
      // reset phone UI
      sendOtpBtn.style.display = 'inline-flex';
      verifyOtpBtn.style.display = 'none';
      otpInput.value = '';
      // re-render recaptcha to be ready
      try{ renderRecaptcha(); }catch(e){}
    }

    logoutBtn.addEventListener('click', async ()=>{
      try{
        await auth.signOut();
        setStatus('Logged out', 'muted small');
      }catch(err){ setStatus('Logout error: ' + (err.message||err.code),'error');}
    });

    // ============ Utility: show error details nicely ============
    function friendlyError(err){
      if(!err) return 'Unknown error';
      if(typeof err === 'string') return err;
      if(err.code) return err.code + ' — ' + (err.message || '');
      return (err.message || JSON.stringify(err));
    }

    // ============ Developer helpers & debugging ============
    // Put helpful console commands for debugging in dev console:
    console.log('%cNJ Mart Admin Login ready', 'color:#2da84f;font-weight:700;');
    console.log('firebaseConfig used:', firebaseConfig);
    setStatus('Firebase initialized for NJ Mart. STATUS: Ready. Use Google / Email / Phone to login.');

    // For extra safety: show how to revoke API key if leaked:
    // TODO (manual): Go to Google Cloud Console -> Credentials -> Delete or rotate API key.

    // Extra: auto-detect small issues on load
    window.addEventListener('load', ()=>{
      // quick sanity checks
      if(firebaseConfig.apiKey && firebaseConfig.projectId){
        console.log('Config ok');
      }else{
        setStatus('Firebase config incomplete — please check apiKey & projectId', 'error');
      }
    });
  </script>

  <!-- big footer comment block to add size / expand file (helps if you wanted many lines) -->
  <!--
    -------------------------------------------------------------------------
    NJ MART Admin Login - Notes & Hints
    -------------------------------------------------------------------------
    - If you see "API key not valid" or "auth/api-key-not-valid" errors:
        1) Ensure API key is correct in firebaseConfig.
        2) Ensure the Identity Toolkit / Identity Platform API is enabled in Google Cloud.
        3) Make sure the domain (e.g., njmart.netlify.app or localhost) is added to
           Authentication -> Authorized domains in Firebase console.
        4) For Phone Auth: ensure reCAPTCHA renders, and the domain is authorized.
           Sometimes you must wait a few minutes after adding domain or new API key.
        5) If GitHub secret scanning found your API key publicly leaked: rotate
           the API key (Google Cloud Console -> Credentials -> Create new API key),
           then update this file and remove API keys from public repos.
    - Phone sign-in specifics:
        * On web, Firebase uses reCAPTCHA to prevent abuse. reCAPTCHA must be visible
          and functional for signInWithPhoneNumber to work.
        * If reCAPTCHA returns "render failed" or "recaptchaVerifier not found",
          try re-rendering or check that no ad-blocker is preventing gstatic/recaptcha scripts.
    - Recommended production practice:
        * Do not commit API keys into public repos.
        * For production, restrict API key to your website(s) under "Application restrictions".
        * Use server-side verification for high-trust operations.
    -------------------------------------------------------------------------
  -->

</body>
</html>
