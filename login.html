<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Admin Login (Part 1)</title>

  <!-- Basic styles (embedded so nothing external is strictly required) -->
  <style>
    :root{
      --green:#28a745;
      --dark:#1f2937;
      --muted:#6b7280;
      --bg:#f8fafc;
      --card:#ffffff;
      --shadow: 0 6px 18px rgba(17,24,39,0.08);
      --radius:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--dark);}
    .container{max-width:1000px;margin:28px auto;padding:20px;}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:8px;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
    .title{font-size:20px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}
    .card{background:var(--card);box-shadow:var(--shadow);padding:22px;border-radius:var(--radius);display:flex;gap:20px}
    .panel{flex:1;min-width:260px}
    .left{width:360px}
    .right{flex:1}
    h2{margin:0 0 6px 0}
    p.small{margin:4px 0 12px 0;color:var(--muted);font-size:13px}
    label{display:block;margin:10px 0 6px 0;font-weight:600;font-size:13px}
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"], select {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6e9ee; font-size:14px; outline:none;
    }
    .btn{background:var(--green);color:#fff;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6e9ee;color:var(--dark)}
    .row{display:flex;gap:12px}
    .helper{font-size:12px;color:var(--muted);margin-top:8px}
    .separator{height:1px;background:#eef2f6;margin:18px 0;border-radius:4px}
    .notice{background:#fffbe6;border:1px solid #ffe7a8;padding:10px;border-radius:8px;color:#5a4b00;font-size:13px}
    .social-btn{display:flex;gap:8px;margin-top:12px}
    .social-btn button{flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;display:flex;align-items:center;gap:8px;cursor:pointer}
    .small-muted{font-size:12px;color:var(--muted)}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    .recaptcha-wrap{margin-top:8px}
    /* responsive */
    @media (max-width:880px){
      .card{flex-direction:column}
      .left{width:100%}
    }
    /* large filler styles to expand file size a bit (repeating helpers, not necessary but requested expanded file) */
    .list { margin: 12px 0; padding: 0; list-style:none; }
    .list li { padding: 6px 0; color:var(--muted); font-size:13px; }
    .support { display:flex; gap:12px; align-items:center; margin-top:10px; }
    .support .item { background:#f3f8f6; padding:8px 10px; border-radius:8px; font-size:13px; }
    .phone{font-weight:700;color:var(--green); }
  </style>

  <!-- Firebase (modular) via CDN - using compat loader for convenience in this template -->
  <!-- We'll use the v9 modular scripts but import compat wrappers for simpler code. -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Google Identity Toolkit will be loaded dynamically where needed -->
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>
          <div class="title">NJ Mart — Admin</div>
          <div class="subtitle">Secure admin access | Manage products, orders & staff</div>
        </div>
      </div>

      <div class="support">
        <div class="item small-muted">Support: <span class="phone">+91 70000 00000</span></div>
        <div class="item small-muted">Email: <span id="support-email">support@njmart.example</span></div>
      </div>
    </div>

    <div class="card" role="main" aria-labelledby="login-heading">
      <!-- Left column: Login methods -->
      <div class="panel left" aria-hidden="false">
        <h2 id="login-heading">Admin Login</h2>
        <p class="small">Choose one of the sign-in options below to access the admin panel.</p>

        <!-- Social / quick sign-in -->
        <div>
          <div class="social-btn" aria-hidden="false">
            <button id="btn-google" title="Sign in with Google">
              <svg width="18" height="18" viewBox="0 0 48 48" style="vertical-align:middle">
                <path fill="#EA4335" d="M24 9.5c3.9 0 7 1.4 9.6 4.1l6.6-6.6C36 2.9 30.4 0 24 0 14.7 0 6.8 5.3 3.1 13.1l7.7 6C12.8 15 18 9.5 24 9.5z"/>
                <path fill="#34A853" d="M46.5 24.5c0-1.6-.2-3.2-.6-4.7H24v9.1h12.9c-.5 2.5-2.1 4.6-4.3 6.1l6.7 5.1c3.9-3.6 6.2-8.9 6.2-15.6z"/>
                <path fill="#4A90E2" d="M9.8 28.1c-.5-1.5-.8-3.2-.8-4.9s.3-3.4.8-4.9L2.1 12.3C.8 15.1 0 18.5 0 22s.8 6.9 2.1 9.7l7.7-3.6z"/>
                <path fill="#FBBC05" d="M24 48c6.4 0 12-2.1 16-5.8l-7.7-5.8C29.7 37.8 27 38.9 24 38.9c-6 0-11.1-4.5-12.1-10.4l-7.7 3.6C6.8 42.7 14.7 48 24 48z"/>
              </svg>
              <span style="flex:1">Continue with Google</span>
            </button>
            <button id="btn-email" title="Sign in with Email">Email</button>
          </div>
          <div class="helper">Google sign-in uses the Google account linked to Firebase Auth. If you see API errors, check your Firebase project API keys & authorized domains.</div>
        </div>

        <div class="separator"></div>

        <!-- Email/password form -->
        <div id="email-block" style="margin-top:8px;">
          <h3 style="margin-bottom:6px">Email Login</h3>
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="Enter email" autocomplete="email" />
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Enter password" autocomplete="current-password" />
          <div style="display:flex;gap:8px;margin-top:12px;">
            <button id="btn-login-email" class="btn">Login</button>
            <button id="btn-signup-email" class="btn ghost">Sign up</button>
            <button id="btn-reset-password" class="btn ghost">Forgot</button>
          </div>
          <div class="helper">Use email and password to sign in. Sign up will create a new Firebase Auth user (if allowed).</div>
        </div>

        <div class="separator"></div>

        <!-- Phone login -->
        <div id="phone-block" style="margin-top:8px;">
          <h3 style="margin-bottom:6px">Phone Login (OTP)</h3>
          <label for="phone">Phone number</label>
          <input id="phone" type="tel" placeholder="+91xxxxxxxxxx" />
          <!-- recaptcha container -->
          <div class="recaptcha-wrap" id="recaptcha-container"></div>

          <div style="display:flex;gap:8px;margin-top:12px;">
            <button id="btn-send-otp" class="btn">Send OTP</button>
            <button id="btn-verify-otp" class="btn ghost">Verify OTP</button>
          </div>

          <label for="otp">Enter OTP</label>
          <input id="otp" type="text" placeholder="6-digit code" />
          <div class="helper">Phone authentication requires reCAPTCHA rendered by Firebase. Make sure API key in config is valid and domain is authorized.</div>
        </div>

        <div class="separator"></div>

        <div class="notice">
          <strong>Quick checklist:</strong>
          <ul class="list" style="margin:6px 0 0 12px;padding-left:12px">
            <li>Firebase project configured (apiKey, projectId set below).</li>
            <li>Authorized domains: <code>njmart.netlify.app</code> and <code>localhost</code></li>
            <li>Sign-in methods enabled in console: Google, Email/Password, Phone.</li>
            <li>reCAPTCHA enabled for phone sign-in.</li>
          </ul>
        </div>
      </div>

      <!-- Right column: Status / Debug / Info -->
      <div class="panel right">
        <h3>Status & Debug</h3>
        <div id="status" class="small-muted">Initializing…</div>

        <div class="separator"></div>

        <div>
          <h4>Current user</h4>
          <pre id="current-user" style="background:#f7fafb;padding:12px;border-radius:8px;border:1px solid #eef2f6;min-height:110px;">
No user signed in.
          </pre>
        </div>

        <div style="margin-top:12px">
          <h4>Action log</h4>
          <pre id="log" style="background:#fff;padding:12px;border-radius:8px;border:1px solid #eef2f6;min-height:180px;font-size:13px;color:#1f2937;overflow:auto;">
Console log will appear here...
          </pre>
        </div>

        <div class="separator"></div>

        <div>
          <h4>Useful links</h4>
          <ul class="list">
            <li>Firebase console → Authentication → Sign-in method</li>
            <li>Check authorized domains and API key restrictions in Google Cloud Console</li>
            <li>If Google login fails: ensure OAuth client & API key are valid for your origin</li>
          </ul>
        </div>
      </div>
    </div>

    <footer>
      © NJ Mart — Admin panel. Support: <span class="phone">+91 70000 00000</span> • <span id="footer-email">support@njmart.example</span>
    </footer>
  </div>

  <!-- ========= Firebase config + App Initialization ========= -->
  <script>
    // ---- Firebase config (from your Firebase console - config mode) ----
    // NOTE: If you want to update these values, change them here.
    const firebaseConfig = {
      apiKey: "AIzaSyCbf19k8pLFh-9UQz8sQRim2rPYT1qaEL8",
      authDomain: "njmartonline.firebaseapp.com",
      projectId: "njmartonline",
      storageBucket: "njmartonline.appspot.com",
      messagingSenderId: "594505763627",
      appId: "1:594505763627:web:a13b0d3ef40e620f9b936e"
    };

    // Initialize Firebase (compat)
    try {
      firebase.initializeApp(firebaseConfig);
      // Using compat auth for simpler examples
      const auth = firebase.auth();
      const db = firebase.firestore();
      const log = (s)=> {
        const el = document.getElementById('log');
        el.textContent = (new Date()).toLocaleTimeString() + " — " + s + "\n" + el.textContent;
      };
      log('[NJ_FIREBASE] Firebase initialized: ' + (firebaseConfig.projectId || 'unknown project'));

      // Expose for other functions
      window.NJ = {
        auth, db, firebase
      };

    } catch (err) {
      console.error('Firebase init error:', err);
      document.getElementById('status').textContent = 'Failed to initialize Firebase — check config.';
      document.getElementById('log').textContent = 'Firebase init error: ' + err;
    }
  </script>

  <!-- ========= App logic (part 1) ========= -->
  <script>
    (function(){
      // UI refs
      const statusEl = document.getElementById('status');
      const curUserEl = document.getElementById('current-user');
      const logEl = document.getElementById('log');

      function appendLog(txt){
        logEl.textContent = (new Date()).toLocaleTimeString() + ' - ' + txt + '\n' + logEl.textContent;
      }

      // Grab auth
      const auth = window.NJ && window.NJ.auth;
      if(!auth){
        appendLog('Error: Firebase auth not found. Ensure firebase scripts loaded.');
        statusEl.textContent = 'Firebase not initialized';
        return;
      }

      // Update UI helper
      function showStatus(msg){
        statusEl.textContent = msg;
        appendLog(msg);
      }

      showStatus('Firebase ready — login options available.');

      // Auth state observer
      auth.onAuthStateChanged(user => {
        if(user){
          curUserEl.textContent = JSON.stringify({
            uid: user.uid,
            email: user.email || null,
            phoneNumber: user.phoneNumber || null,
            providers: user.providerData.map(p => p.providerId)
          }, null, 2);
          showStatus('User signed in: ' + (user.email || user.phoneNumber || user.uid));
        } else {
          curUserEl.textContent = 'No user signed in.';
          showStatus('Not signed in');
        }
      });

      // ========== Google Sign-in ==========
      document.getElementById('btn-google').addEventListener('click', async function(){
        showStatus('Opening Google sign-in...');
        appendLog('Opening Google sign-in flow.');
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          // optional: provider.addScope('profile');
          // Use popup for admin flows
          const res = await auth.signInWithPopup(provider);
          appendLog('Google sign-in successful: ' + (res.user && (res.user.email || res.user.uid)));
        } catch(err){
          console.error('Google sign-in failed:', err);
          appendLog('Google sign-in failed: ' + err.message);
          alert('Google sign-in error: ' + (err.message || err));
          showStatus('Google sign-in error (check console).');
        }
      });

      // ========== Email / Password ==========
      const emailInput = document.getElementById('email');
      const passInput = document.getElementById('password');
      document.getElementById('btn-login-email').addEventListener('click', async ()=>{
        const email = emailInput.value.trim();
        const pwd = passInput.value;
        if(!email || !pwd){ alert('Enter email and password'); return; }
        showStatus('Signing in with email...');
        try{
          const res = await auth.signInWithEmailAndPassword(email, pwd);
          appendLog('Email login success: ' + res.user.uid);
        }catch(err){
          appendLog('Email login error: ' + err.message);
          alert('Login failed: ' + err.message);
        }
      });
      document.getElementById('btn-signup-email').addEventListener('click', async ()=>{
        const email = emailInput.value.trim();
        const pwd = passInput.value;
        if(!email || !pwd){ alert('Enter email and password for signup'); return; }
        showStatus('Creating account...');
        try{
          const res = await auth.createUserWithEmailAndPassword(email, pwd);
          appendLog('Account created: ' + res.user.uid);
        }catch(err){
          appendLog('Signup error: ' + err.message);
          alert('Signup failed: ' + err.message);
        }
      });
      document.getElementById('btn-reset-password').addEventListener('click', async ()=>{
        const email = emailInput.value.trim();
        if(!email){ alert('Enter email to reset'); return; }
        try{
          await auth.sendPasswordResetEmail(email);
          appendLog('Password reset sent to ' + email);
          alert('Reset email sent.');
        }catch(err){
          appendLog('Reset error: ' + err.message);
          alert('Reset failed: ' + err.message);
        }
      });

      // ========== Phone Auth (OTP) ==========
      // Setup recaptcha (invisible)
      let recaptchaVerifier = null;
      function ensureRecaptcha(){
        if(recaptchaVerifier) return recaptchaVerifier;
        // Use Firebase Recaptcha in visible mode so user can see it
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          size: 'invisible', // invisible usually; can be 'normal' to show widget
          callback: function(response){
            appendLog('reCAPTCHA resolved.');
          },
          'expired-callback': function(){
            appendLog('reCAPTCHA expired; please re-trigger.');
          }
        });
        recaptchaVerifier.render().then(widgetId => {
          appendLog('reCAPTCHA rendered (widgetId=' + widgetId + ')');
        }).catch(err=>{
          appendLog('reCAPTCHA render error: ' + err.message);
          console.error(err);
        });
        return recaptchaVerifier;
      }

      document.getElementById('btn-send-otp').addEventListener('click', async ()=>{
        const phone = (document.getElementById('phone').value || '').trim();
        if(!phone){ alert('Enter phone number (with country code)'); return; }
        try{
          showStatus('Sending OTP to ' + phone);
          ensureRecaptcha();
          const appVerifier = recaptchaVerifier;
          const confirmationResult = await auth.signInWithPhoneNumber(phone, appVerifier);
          // store confirmationResult to verify later
          window._phoneConfirmation = confirmationResult;
          appendLog('OTP sent (client). Please enter code and verify.');
          alert('OTP sent. Check your phone.');
        }catch(err){
          appendLog('Send OTP error: ' + (err && err.message));
          console.error(err);
          alert('Send OTP failed: ' + (err.message || err));
        }
      });

      document.getElementById('btn-verify-otp').addEventListener('click', async ()=>{
        const code = (document.getElementById('otp').value || '').trim();
        if(!code){ alert('Enter OTP code'); return; }
        if(!window._phoneConfirmation){
          alert('No OTP request found. Please send OTP first.');
          return;
        }
        try{
          const res = await window._phoneConfirmation.confirm(code);
          appendLog('Phone login success: ' + res.user.uid);
          alert('Phone login success.');
        }catch(err){
          appendLog('Verify OTP error: ' + err.message);
          console.error(err);
          alert('OTP verify failed: ' + err.message);
        }
      });

      // Small helper to sign out
      window.signOutNJ = async function(){
        try {
          await auth.signOut();
          appendLog('User logged out (manual).');
          alert('Signed out.');
        } catch(e){
          appendLog('Sign out error: ' + e.message);
        }
      };

      // Ensure recaptcha is pre-rendered to reduce first-time delay
      try {
        ensureRecaptcha();
      } catch(e){
        appendLog('Recaptcha pre-render error: ' + (e && e.message));
      }

      // Provide a global debug helper
      window.NJ.debug = {
        log: appendLog,
        showStatus
      };

      appendLog('Login UI initialized. Use Google / Email / Phone to sign in.');
    })();
  </script>

  <!-- End of Part 1 -->
</body>
</html>
<!-- ======= Part 2 (append right after Part 1 content) ======= -->
<script>
  (function(){
    // ---------- Config ----------
    // IMPORTANT:
    // - If you want to restrict admin access, update ADMIN_WHITELIST below (emails or phone numbers).
    // - If you use a custom admin page, change ADMIN_PAGE to that file.
    const ADMIN_PAGE = 'admin.html';      // page to redirect admin users
    const USER_HOME = 'index.html';       // regular user
    const ADMIN_WHITELIST = [
      'your.admin.email@example.com',     // replace with real admin email(s)
      // phone example: '+919876543210'
    ];

    // small helpers
    const el = id => document.getElementById(id);
    const readLS = k => { try { return JSON.parse(localStorage.getItem(k)||'null'); } catch(e){ return null; } };
    const writeLS = (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} };

    // UI refs from part1
    const statusEl = el('status');
    const logEl = el('log');
    const curUserEl = el('current-user');

    function appendLog(txt){
      logEl.textContent = (new Date()).toLocaleTimeString() + ' - ' + txt + '\n' + logEl.textContent;
      console.log('[NJ_LOG]', txt);
    }

    // Wait for firebase to be ready
    async function waitForAuth(){
      let tries = 0;
      while(!window.NJ || !window.NJ.auth){
        await new Promise(r => setTimeout(r, 150));
        tries++;
        if(tries > 80){ appendLog('Firebase auth not available after wait.'); return null; }
      }
      return window.NJ.auth;
    }

    // simple admin check (email or phone)
    function isAdminUser(user){
      if(!user) return false;
      const email = (user.email || '').toString().toLowerCase();
      const phone = (user.phoneNumber || '').toString();
      for(let a of ADMIN_WHITELIST){
        if(!a) continue;
        if(a.includes('@') && email && email === a.toString().toLowerCase()) return true;
        if(a.startsWith('+') && phone && phone === a) return true;
      }
      return false;
    }

    // redirect helper with small delay for UX
    function redirectTo(url){
      appendLog('Redirecting to: ' + url);
      setTimeout(()=> window.location.href = url, 600);
    }

    // show detailed diagnostic if login fails (400/401 errors)
    function diagnosticMessage(err){
      if(!err) return 'Unknown error';
      const m = (err && err.message) ? err.message : (''+err);
      if(m.includes('network')) return 'Network error — check your internet connection.';
      if(m.includes('API key not valid')) return 'API key invalid — check firebaseConfig in the page and ensure the API key is correct & not restricted to other origins.';
      if(m.includes('auth/too-many-requests')) return 'Too many attempts — try again later or use a test number.';
      return m;
    }

    // update UI with signed-in user
    function showUser(user){
      if(!user){
        curUserEl.textContent = 'No user signed in.';
        return;
      }
      try{
        const safe = {
          uid: user.uid,
          email: user.email || null,
          phoneNumber: user.phoneNumber || null,
          displayName: user.displayName || null,
          providers: (user.providerData || []).map(p=>p.providerId)
        };
        curUserEl.textContent = JSON.stringify(safe, null, 2);
      }catch(e){
        curUserEl.textContent = 'Error rendering user';
      }
    }

    // onAuth change to handle redirect & localStorage write
    async function attachAuthObserver(){
      const auth = await waitForAuth();
      if(!auth) return;
      auth.onAuthStateChanged(async user => {
        if(user){
          appendLog('Auth state: signed in (' + (user.email || user.phoneNumber || user.uid) + ')');
          showUser(user);
          writeLS('nj_user', {
            uid: user.uid,
            email: user.email || '',
            phone: user.phoneNumber || '',
            name: user.displayName || '',
            providers: (user.providerData||[]).map(p=>p.providerId||'')
          });

          // Admin check
          if(isAdminUser(user)){
            appendLog('User is admin — redirecting to admin panel.');
            // optional: set token or custom claim check here
            redirectTo(ADMIN_PAGE);
            return;
          }

          // else regular user
          appendLog('Redirecting to user home.');
          redirectTo(USER_HOME);

        } else {
          appendLog('Auth state: signed out.');
          showUser(null);
          statusEl.textContent = 'Not signed in';
        }
      });
    }

    // ---- Extra helper: create a "user profile" entry in firestore (optional) ----
    // This will create/update a document in 'customers' collection with basic info.
    // Useful to have user records in Firestore for later use.
    async function ensureUserProfile(user){
      if(!user) return;
      try{
        const db = window.NJ.db;
        if(!db) { appendLog('Firestore not initialized; skipping profile save.'); return; }
        const uid = user.uid;
        const docRef = db.collection('customers').doc(uid);
        await docRef.set({
          uid: uid,
          name: user.displayName || '',
          email: user.email || '',
          phone: user.phoneNumber || '',
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        appendLog('User profile saved in Firestore.');
      } catch(err){
        appendLog('Profile save error: ' + (err.message || err));
      }
    }

    // ---- Admin whitelist UI helper: quick edit (only visible if currently admin on same device) ----
    function showAdminQuickEdit(user){
      // If signed-in user is admin, show quick admin controls in the Status panel
      try{
        const node = document.createElement('div');
        node.style.marginTop = '10px';
        node.style.padding = '10px';
        node.style.background = '#f4fff7';
        node.style.border = '1px solid #e6f4ea';
        node.style.borderRadius = '8px';
        node.innerHTML = `<div style="font-weight:700">Admin quick</div>
          <div style="margin-top:6px">
            <button id="btn-open-admin" class="btn" style="padding:8px 10px;margin-right:8px">Open Admin panel</button>
            <button id="btn-copy-user" class="btn ghost" style="padding:8px 10px">Copy user details</button>
          </div>`;
        document.querySelector('.panel.right').appendChild(node);
        document.getElementById('btn-open-admin').addEventListener('click', ()=>{ window.location.href = ADMIN_PAGE; });
        document.getElementById('btn-copy-user').addEventListener('click', ()=>{
          const u = readLS('nj_user') || {};
          navigator.clipboard?.writeText(JSON.stringify(u, null, 2));
          appendLog('User details copied to clipboard.');
        });
      }catch(e){}
    }

    // ---- Run initialization ----
    (async function initPart2(){
      appendLog('Part 2 init — attaching auth observer & final checks.');

      // attach observer
      attachAuthObserver();

      // show initial debug info
      const cfg = (typeof firebaseConfig !== 'undefined') ? firebaseConfig : null;
      appendLog('Using Firebase project: ' + (cfg && cfg.projectId ? cfg.projectId : 'unknown'));
      if(!cfg || !cfg.apiKey){
        appendLog('Firebase config missing/invalid. Please set firebaseConfig in Part 1 of the file.');
        statusEl.textContent = 'Firebase config missing — open Part 1 and paste your config from Firebase console.';
        return;
      } else {
        appendLog('Firebase API key appears present.');
      }

      // small diagnostic: test a simple API call (list providers) to check API restrictions
      try{
        const apicheck = await fetch('https://www.googleapis.com/identitytoolkit/v3/relyingparty/getAccountInfo?key=' + encodeURIComponent(cfg.apiKey), { method: 'POST', body: '{}' });
        if(apicheck && apicheck.status === 400){
          appendLog('API check returned 400 — often indicates API key restrictions. Verify API key is not restricted to other referrers.');
        } else if(apicheck && apicheck.status === 200){
          appendLog('API check OK (200).');
        } else {
          appendLog('API check HTTP status: ' + (apicheck && apicheck.status));
        }
      }catch(e){
        appendLog('API key check failed: ' + (e && e.message));
      }

      // If user already signed-in (page reloaded), we still want to offer admin quick edit
      const saved = readLS('nj_user');
      if(saved && ADMIN_WHITELIST && ADMIN_WHITELIST.length && (ADMIN_WHITELIST.includes((saved.email||'').toString().toLowerCase()) || ADMIN_WHITELIST.includes(saved.phone))){
        showAdminQuickEdit(saved);
      }

      // final status
      statusEl.textContent = 'Ready — choose a sign-in method.';
    })();
  })();
</script>

<!-- small helper UI for manual sign-out (can be called from console) -->
<script>
  // expose signOut function globally (safer to use via console or a visible button)
  window.njSignOut = async function(){
    try {
      if(window.NJ && window.NJ.auth){
        await window.NJ.auth.signOut();
        localStorage.removeItem('nj_user');
        alert('Signed out.');
      } else {
        alert('Auth not available.');
      }
    } catch(e){
      alert('Sign out error: ' + (e.message || e));
    }
  };
</script>

<!-- End of Part 2 (append after Part 1) -->
