<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Login</title>

  <!-- Favicon (add your favicon.ico in project root) -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <!-- Tailwind (CDN) — fallback to unpkg if official fails -->
  <script>
    (function(){
      try {
        // prefer official CDN (fast). If blocked, unpkg fallback will be used below by loading tailwind via <script src>
        window.tailwind = window.tailwind || {};
      } catch(e){}
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent: #16a34a;
      --accent-dark: #0f7a36;
      --muted: #6b7280;
      --card: #ffffff;
      --bg: #f6fbf8;
      --shadow: 0 10px 28px rgba(12,30,40,0.06);
      --maxw: 1100px;
    }
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg), #eef7f1);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      margin:0;
    }
    .card { box-shadow: var(--shadow); border-radius: 14px; background: var(--card); }
    .logo { width:56px; height:56px; border-radius:12px; display:inline-flex;align-items:center;justify-content:center;font-weight:800;color:white;background:linear-gradient(135deg,var(--accent),var(--accent-dark)); }
    /* small helpers */
    .muted { color: var(--muted) }
    .kbd { font-family: monospace;background:#f3f4f6;padding:2px 6px;border-radius:6px;font-size:12px }
    @media (max-width:640px){ .hide-mobile { display:none } }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-5xl mx-auto">

    <!-- Top nav (minimal) -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="logo">NJ</div>
        <div>
          <div class="text-xl font-bold">NJ Mart</div>
          <div class="text-sm muted">Grocery • Home delivery</div>
        </div>
      </div>
      <div class="hidden sm:flex items-center gap-4">
        <a href="index.html" class="text-sm text-gray-700 hover:underline">Home</a>
        <a href="products.html" class="text-sm text-gray-700 hover:underline">Products</a>
        <a href="cart.html" class="text-sm text-gray-700 hover:underline">Cart</a>
        <a href="admin.html" class="text-sm text-gray-700 hover:underline">Admin</a>
      </div>
    </header>

    <!-- Main card -->
    <main class="card p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left: Info -->
      <section class="hidden lg:flex flex-col justify-center px-6">
        <h1 class="text-3xl font-extrabold text-green-700 mb-2">Secure Sign-In</h1>
        <p class="mb-4 text-gray-700">Access your NJ Mart admin console — manage products, orders, staff and reports.</p>

        <div class="space-y-3">
          <div class="p-4 rounded-lg border border-gray-100">
            <div class="text-sm font-semibold">Why sign in?</div>
            <ul class="mt-2 text-sm text-gray-600 list-disc list-inside">
              <li>Manage inventory & warehouse</li>
              <li>View and process orders</li>
              <li>Create coupons & reports</li>
            </ul>
          </div>

          <div class="p-4 rounded-lg border border-gray-100">
            <div class="text-sm font-semibold">Need help?</div>
            <div class="text-sm text-gray-600 mt-2">Call: <a class="text-green-700 font-semibold" href="tel:+917062918607">+91 70629 18607</a></div>
            <div class="text-xs text-gray-500 mt-1">Support available 9am — 8pm</div>
          </div>
        </div>
      </section>

      <!-- Right: Login forms -->
      <section class="px-4 sm:px-8 py-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-lg font-bold">Sign in to NJ Mart</div>
            <div class="text-sm muted">Sign in with Google, phone or email</div>
          </div>
          <div class="text-sm text-gray-400 hide-mobile">Secure • Fast • Reliable</div>
        </div>

        <!-- Buttons / forms -->
        <div class="space-y-4">

          <!-- Google sign-in -->
          <button id="btnGoogle" class="w-full flex items-center justify-center gap-3 border rounded-lg py-2 hover:bg-gray-50">
            <img src="https://www.svgrepo.com/show/355037/google.svg" alt="Google" class="w-5 h-5">
            <span class="font-semibold">Continue with Google</span>
          </button>

          <!-- Divider -->
          <div class="flex items-center gap-3">
            <hr class="flex-1 border-gray-200">
            <div class="text-xs text-gray-400 uppercase">Or</div>
            <hr class="flex-1 border-gray-200">
          </div>

          <!-- Email sign-in -->
          <div class="space-y-3">
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input id="email" type="email" placeholder="you@example.com"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-200" />

            <label class="block text-sm font-medium text-gray-700">Password</label>
            <input id="password" type="password" placeholder="Enter password"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-200" />

            <div class="flex gap-3">
              <button id="btnEmailLogin" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">Login</button>
              <button id="btnSignup" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">Sign up</button>
            </div>

            <div class="flex items-center justify-between">
              <button id="btnReset" class="text-sm text-gray-600 hover:underline">Forgot password?</button>
              <div class="text-xs muted">Use Google or phone if password not set</div>
            </div>
          </div>

          <!-- Divider -->
          <div class="flex items-center gap-3">
            <hr class="flex-1 border-gray-200">
            <div class="text-xs text-gray-400 uppercase">Or</div>
            <hr class="flex-1 border-gray-200">
          </div>

          <!-- Phone OTP -->
          <div class="space-y-3">
            <label class="block text-sm font-medium text-gray-700">Phone (with country code)</label>
            <input id="phone" type="text" placeholder="+91 9876543210"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-200" />

            <!-- reCAPTCHA container (will render widget) -->
            <div id="recaptcha-container" class="mt-2"></div>

            <div class="flex gap-3">
              <button id="btnSendOtp" class="flex-1 bg-yellow-500 text-white py-2 rounded-lg font-semibold hover:bg-yellow-600">Send OTP</button>
              <button id="btnVerifyOtp" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">Verify OTP</button>
            </div>

            <input id="otp" type="text" placeholder="Enter OTP"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-200" />
          </div>

          <!-- Status -->
          <div id="status" class="text-sm text-center muted mt-2">Ready — choose a sign-in method</div>

        </div>

        <!-- Small docs & links -->
        <div class="mt-6 text-xs muted">
          <div>By signing in you agree to NJ Mart terms and privacy.</div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="mt-6 text-center text-sm text-gray-600">
      © NJ Mart — All rights reserved. Support: <a href="tel:+917062918607" class="text-green-700 font-semibold">+91 70629 18607</a>
    </footer>
  </div>

  <!-- Firebase compat SDKs (use compat to avoid migration friction) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
  /************************************************************************
   * NJ Mart — login.html (single-file final)
   * - Integrates Google sign-in, Email sign-in/signup/reset, Phone OTP (reCAPTCHA)
   * - Uses Firebase compat SDK (9.22.2) so existing code snippets work
   * - Replace FIREBASE_CONFIG below if your Firebase console shows different values
   *
   * IMPORTANT:
   * - For Phone OTP to work: Firebase Auth -> Sign-in method -> Phone enabled,
   *   and Authorized domains must include your deployed domain (eg. njmart.netlify.app).
   * - If you see auth/api-key-not-valid → replace apiKey with the one from Firebase project settings.
   ************************************************************************/

  // ----- CONFIG -----
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCbf19k8pLFh-9UQz8sQRim2rPYTlqaEL8",
    authDomain: "njmartonline.firebaseapp.com",
    projectId: "njmartonline",
    storageBucket: "njmartonline.firebasestorage.app",
    messagingSenderId: "594505763627",
    appId: "1:594505763627:web:a13b0d3ef40e620f9b936e"
  };

  // initialize
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(FIREBASE_CONFIG);
      console.info('[NJ] Firebase initialized');
    } else {
      firebase.app(); // if already initialized
    }
  } catch (e) {
    console.error('Firebase init error', e);
    document.getElementById('status').textContent = 'Firebase initialization error — check console.';
  }

  const auth = firebase.auth();
  const db = firebase.firestore ? firebase.firestore() : null;

  // ----- DOM helpers -----
  const $ = id => document.getElementById(id);
  const statusEl = $('status');

  function setStatus(msg, cls) {
    statusEl.textContent = msg;
    if (cls) {
      statusEl.className = 'text-sm text-center ' + cls;
    } else {
      statusEl.className = 'text-sm text-center muted';
    }
  }

  // ----- Auth state -----
  auth.onAuthStateChanged(user => {
    if (user) {
      console.log('User signed in:', user);
      const display = user.displayName || user.email || user.phoneNumber || 'User';
      setStatus('Signed in as ' + display, 'text-green-600');
      // redirect to admin or dashboard if desired:
      // window.location.href = 'admin.html';
    } else {
      console.log('User signed out');
      setStatus('No user signed in');
    }
  });

  // ----- Google Sign-in -----
  $('btnGoogle').addEventListener('click', async () => {
    setStatus('Opening Google sign-in...', 'text-gray-600');
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
      const res = await auth.signInWithPopup(provider);
      setStatus('Logged in with Google: ' + (res.user.email || res.user.displayName), 'text-green-600');
      // optional: save to backend (Apps Script) if needed
    } catch (err) {
      console.error('Google login error', err);
      setStatus('Google sign-in failed: ' + (err.message || err), 'text-red-500');
    }
  });

  // ----- Email Login/Signup/Reset -----
  $('btnEmailLogin').addEventListener('click', async () => {
    const email = $('email').value.trim();
    const pwd = $('password').value;
    if (!email || !pwd) { setStatus('Enter email and password', 'text-red-500'); return; }
    setStatus('Signing in...', 'text-gray-600');
    try {
      await auth.signInWithEmailAndPassword(email, pwd);
      setStatus('Signed in ' + email, 'text-green-600');
    } catch (err) {
      console.error('Email login error', err);
      setStatus('Login failed: ' + (err.message || err), 'text-red-500');
    }
  });

  $('btnSignup').addEventListener('click', async () => {
    const email = $('email').value.trim();
    const pwd = $('password').value;
    if (!email || !pwd) { setStatus('Enter email and password', 'text-red-500'); return; }
    if (pwd.length < 6) { setStatus('Password must be 6+ characters', 'text-red-500'); return; }
    setStatus('Creating account...', 'text-gray-600');
    try {
      const res = await auth.createUserWithEmailAndPassword(email, pwd);
      setStatus('Account created: ' + (res.user.email || ''), 'text-green-600');
    } catch (err) {
      console.error('Signup error', err);
      setStatus('Sign up failed: ' + (err.message || err), 'text-red-500');
    }
  });

  $('btnReset').addEventListener('click', async () => {
    const email = $('email').value.trim();
    if (!email) { setStatus('Enter email to reset', 'text-red-500'); return; }
    setStatus('Sending reset link...', 'text-gray-600');
    try {
      await auth.sendPasswordResetEmail(email);
      setStatus('Password reset email sent to ' + email, 'text-green-600');
    } catch (err) {
      console.error('Reset error', err);
      setStatus('Reset failed: ' + (err.message || err), 'text-red-500');
    }
  });

  // ----- Phone OTP -----
  // Initialize reCAPTCHA (render once)
  let recaptchaRendered = false;
  function initRecaptcha() {
    try {
      if (!recaptchaRendered) {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          'size': 'normal',
          'callback': (response) => {
            console.log('reCAPTCHA solved');
          },
          'expired-callback': () => {
            console.log('reCAPTCHA expired');
          }
        });
        window.recaptchaVerifier.render().then(id => {
          recaptchaRendered = true;
          console.info('reCAPTCHA rendered', id);
        });
      }
    } catch (err) {
      console.error('recaptcha init error', err);
      setStatus('reCAPTCHA initialization error (see console).', 'text-red-500');
    }
  }
  initRecaptcha();

  let confirmationResult = null;

  $('btnSendOtp').addEventListener('click', async () => {
    const phoneVal = $('phone').value.trim();
    if (!phoneVal) { setStatus('Enter phone number with country code', 'text-red-500'); return; }
    try {
      setStatus('Sending OTP...', 'text-gray-600');
      const appVerifier = window.recaptchaVerifier;
      confirmationResult = await auth.signInWithPhoneNumber(phoneVal, appVerifier);
      setStatus('OTP sent to ' + phoneVal, 'text-green-600');
      console.info('confirmationResult ready', confirmationResult);
    } catch (err) {
      console.error('send OTP error', err);
      setStatus('Send OTP failed: ' + (err.message || err), 'text-red-500');
      // reset recaptcha if needed
      try { if (window.recaptchaVerifier) { window.recaptchaVerifier.clear(); recaptchaRendered = false; initRecaptcha(); } } catch(e){}
    }
  });

  $('btnVerifyOtp').addEventListener('click', async () => {
    const code = $('otp').value.trim();
    if (!code) { setStatus('Enter OTP', 'text-red-500'); return; }
    if (!confirmationResult) { setStatus('No OTP sent — press Send OTP first', 'text-red-500'); return; }
    setStatus('Verifying OTP...', 'text-gray-600');
    try {
      const res = await confirmationResult.confirm(code);
      setStatus('Phone verified: ' + (res.user.phoneNumber || ''), 'text-green-600');
    } catch (err) {
      console.error('OTP verify error', err);
      setStatus('OTP verify failed: ' + (err.message || err), 'text-red-500');
    }
  });

  // ----- Small helpers -----
  // allow Enter to submit login
  ['email','password'].forEach(id => {
    $(id).addEventListener('keydown', (e) => {
      if (e.key === 'Enter') $('btnEmailLogin').click();
    });
  });

  // expose for debug
  window.__NJ = {
    firebase, auth, initRecaptcha, FIREBASE_CONFIG
  };

  // final ready
  setStatus('Ready — choose a sign-in method');
  </script>

</body>
</html>
