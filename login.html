<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Login</title>

  <!-- Fonts + icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Link to your global stylesheet (if using) -->
  <link rel="stylesheet" href="style.css">

  <!-- NOTE:
       This page expects firebase-config.js to initialise firebase and expose `firebase`.
       Also expects script-config.js to expose API_BASE and other project constants.
       Example files already present in your repo: firebase-config.js, script-config.js
  -->

  <style>
    /* Inline critical login styles to keep page self-contained & accessible.
       The rest of the site CSS should be in style.css; these are small overrides. */
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2db34a;
      --accent-2:#199338;
      --shadow: 0 10px 30px rgba(12,30,40,0.06);
      --max-width:900px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max-width);margin:18px auto;padding:14px}
    header.site-header{display:flex;align-items:center;gap:12px;padding:10px 12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media(max-width:880px){ .grid{grid-template-columns:1fr} .right-col{order:2} }
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted)}
    .signin-btn{display:flex;gap:8px;align-items:center;border:1px solid #e6eef0;padding:10px;border-radius:8px;cursor:pointer}
    .signin-btn .icon{width:20px;height:20px}
    .form-row{display:flex;gap:8px}
    input[type="text"], input[type="tel"], input[type="email"], .phone-input{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;background:#fff;font-size:14px;
    }
    .btn{border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e6eef0}
    .small{font-size:13px;color:var(--muted)}
    .divider{height:1px;background:#f1f3f4;margin:12px 0;border-radius:4px}

    .helper { font-size:13px; color:var(--muted); margin-top:6px; }

    /* phone auth area */
    .recaptcha-wrap{margin-top:6px}
    .otp-area{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    /* messages */
    .msg{padding:8px;border-radius:8px;margin-bottom:10px}
    .msg.info{background:#eef7ef;color:#165b20}
    .msg.warn{background:#fff7ed;color:#7a4a00}
    .msg.err{background:#fff0f0;color:#7a0000}

    /* accessibility focus */
    button:focus, input:focus{outline:3px solid rgba(34,197,94,0.12);outline-offset:2px}

    /* visual footer links */
    .footer-links{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .legal{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>

  <div class="wrap">

    <header class="site-header" role="banner">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>
          <h1>NJ Mart</h1>
          <div class="muted" style="font-size:12px">Login & Account</div>
        </div>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <a href="index.html" class="btn ghost">Home</a>
        <a href="checkout.html" class="btn primary">Checkout</a>
      </div>
    </header>

    <main class="grid" role="main" aria-labelledby="loginTitle">

      <!-- LEFT: sign-in forms -->
      <section class="card left-col" aria-label="Sign in options">
        <h2 id="loginTitle">Sign in or create account</h2>
        <p class="small">Secure & fast. You can sign in with Google or Phone (OTP).</p>

        <div id="alertArea" style="margin-top:12px"></div>

        <div style="margin-top:12px">
          <!-- Google Sign-in -->
          <div id="googleSignIn" class="signin-btn" role="button" tabindex="0" aria-pressed="false" title="Sign in with Google">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" class="icon" />
            <div>Sign in with Google</div>
          </div>

          <div style="height:12px"></div>

          <!-- Phone OTP area -->
          <div class="card" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>Phone OTP</strong>
                <div class="small muted">Enter your phone number with country code (e.g. +91XXXXXXXXXX)</div>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="form-row" aria-hidden="false">
              <input id="inputPhone" type="tel" class="phone-input" placeholder="+91xxxxxxxxxx" aria-label="Phone number" />
              <button id="btnSendOTP" class="btn primary" aria-label="Send OTP">Send OTP</button>
            </div>

            <div class="recaptcha-wrap" id="recaptcha-container" aria-hidden="false"></div>

            <div style="height:10px"></div>

            <div id="otpBlock" style="display:none">
              <div class="otp-area">
                <input id="inputOTP" type="text" maxlength="10" placeholder="Enter OTP" aria-label="One time password" />
                <button id="btnVerifyOTP" class="btn ghost">Verify</button>
                <button id="btnResendOTP" class="btn" style="background:#f3f4f6">Resend</button>
              </div>
              <div class="helper small">If you don't receive OTP, check your phone number or try resend. Phone auth requires reCAPTCHA & Authorized domains.</div>
            </div>

            <div style="height:8px"></div>
            <div id="phoneStatus" class="small muted"></div>
          </div>

          <div class="divider"></div>

          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <a href="login.html" class="small">Email sign-in (optional)</a>
            <div class="muted small">Email/password is intentionally not enabled to keep flow simple.</div>
          </div>

          <div class="divider"></div>

          <div class="small muted">
            Why sign in?
            <ul>
              <li>Save profile (address, phone) to reuse at checkout</li>
              <li>View order history and invoices</li>
              <li>Faster checkout with one-tap login</li>
            </ul>
          </div>
        </div>

      </section>

      <!-- RIGHT: account summary / quick profile -->
      <aside class="card right-col" aria-label="Your account">
        <h3 style="margin:0">Your account</h3>
        <div class="muted small">You are not signed in. Use Google or Phone OTP to sign in.</div>

        <div style="height:12px"></div>

        <div id="accountView" style="display:block">
          <div class="small" style="margin-bottom:8px">
            <button id="btnCheckLocal" class="btn ghost">Check saved profile</button>
          </div>

          <div id="savedProfile" style="display:none">
            <div style="font-weight:700" id="sp_name"></div>
            <div class="muted small" id="sp_phone"></div>
            <div style="height:8px"></div>
            <div class="small">
              <button id="btnUseProfile" class="btn primary">Use this profile</button>
              <button id="btnClearProfile" class="btn ghost">Clear</button>
            </div>
          </div>

        </div>

        <div class="divider"></div>

        <div class="small muted">Saved profiles are kept locally in your browser. Signing in will associate profile with your account.</div>

        <div class="footer-links">
          <a href="profile.html" class="small">Manage profile</a>
          <a href="orders.html" class="small">My orders</a>
          <a href="index.html" class="small">Shop</a>
        </div>
      </aside>

    </main>

    <footer style="max-width:var(--max-width);margin:20px auto;padding:8px">
      <div class="legal muted">NJ Mart &middot; Built for local demo. Make sure Firebase authorized domains & reCAPTCHA configured for phone auth.</div>
    </footer>

  </div>

  <!-- Required: firebase-config.js + script-config.js (should be included in your repo) -->
  <script src="firebase-config.js"></script>
  <script src="script-config.js"></script>

  <!-- Load Firebase UI auth (optional) -->
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth__en.js"></script>
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />

  <script>
  /* ========== Login page client script (expanded final) ==========
     - Works with firebase (Google & Phone OTP)
     - Uses script-config.js to get BACKEND URL (API_BASE)
     - Saves local profile in localStorage
     ----------------------------------------------------------------- */

  (function(){
    'use strict';

    // ---------- CONFIG ----------
    // fallback API_BASE if script-config didn't set it
    const API_BASE = (typeof NJ !== 'undefined' && NJ.BACKEND_URL) ? NJ.BACKEND_URL :
                     (typeof BACKEND_URL !== 'undefined' ? BACKEND_URL : (typeof API_BASE !== 'undefined' ? API_BASE : ''));

    // localStorage keys
    const KEY_PROFILE = 'nj_profile';

    // selectors
    const $ = id => document.getElementById(id);
    const alertArea = $('alertArea');
    const googleSignIn = $('googleSignIn');
    const btnSendOTP = $('btnSendOTP');
    const btnVerifyOTP = $('btnVerifyOTP');
    const btnResendOTP = $('btnResendOTP');
    const inputPhone = $('inputPhone');
    const inputOTP = $('inputOTP');
    const otpBlock = $('otpBlock');
    const phoneStatus = $('phoneStatus');

    const btnCheckLocal = $('btnCheckLocal');
    const savedProfileDiv = $('savedProfile');
    const sp_name = $('sp_name');
    const sp_phone = $('sp_phone');
    const btnUseProfile = $('btnUseProfile');
    const btnClearProfile = $('btnClearProfile');

    // recaptcha verifier holder
    let recaptchaVerifier = null;
    let confirmationResult = null;
    let lastPhoneSent = null;

    // ---------- helpers ----------
    function info(msg){ showMsg(msg,'info'); }
    function warn(msg){ showMsg(msg,'warn'); }
    function err(msg){ showMsg(msg,'err'); }
    function clearMsgs(){ alertArea.innerHTML = ''; }

    function showMsg(message, type='info', timeout=4000){
      const div = document.createElement('div');
      div.className = 'msg ' + (type==='info' ? 'info' : (type==='err' ? 'err' : 'warn'));
      div.textContent = message;
      alertArea.appendChild(div);
      if(timeout>0){
        setTimeout(()=>{ if(div && div.parentNode) div.parentNode.removeChild(div); }, timeout);
      }
    }

    // read/write local profile
    function saveLocalProfile(p){
      try{
        localStorage.setItem(KEY_PROFILE, JSON.stringify(p||{}));
      }catch(e){ console.warn('local save failed', e); }
    }

    function loadLocalProfile(){
      try{
        const raw = localStorage.getItem(KEY_PROFILE);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }

    function clearLocalProfile(){
      localStorage.removeItem(KEY_PROFILE);
      renderSavedProfile();
    }

    function renderSavedProfile(){
      const p = loadLocalProfile();
      if(p && (p.Name || p.Phone)){
        sp_name.textContent = p.Name || 'Unnamed';
        sp_phone.textContent = p.Phone || '';
        savedProfileDiv.style.display = 'block';
      } else {
        savedProfileDiv.style.display = 'none';
      }
    }

    // small phone normalizer
    function normalizePhone(v){
      if(!v) return '';
      v = v.toString().trim();
      // if number missing plus, assume +91 for quick convenience (optional)
      if(!v.startsWith('+')) {
        // do not auto-prepend for international; only for 10-digit numbers
        const digits = v.replace(/\D/g,'');
        if(digits.length === 10) return '+91' + digits;
      }
      return v;
    }

    function validPhone(v){
      const s = normalizePhone(v);
      if(!s) return false;
      // minimal check: + and 10-15 digits
      const digits = s.replace(/\D/g,'');
      return digits.length >= 10 && digits.length <= 15;
    }

    // ---------- Firebase init check ----------
    function ensureFirebaseReady(){
      if(typeof firebase === 'undefined'){
        err('Firebase SDK not loaded — ensure firebase-config.js is included and initialised.');
        return false;
      }
      if(!firebase.apps || firebase.apps.length === 0){
        err('Firebase app not initialised — check firebase-config.js');
        return false;
      }
      return true;
    }

    // ---------- Google sign-in ----------
    async function signInWithGoogle(){
      if(!ensureFirebaseReady()) return;
      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        const res = await firebase.auth().signInWithPopup(provider);
        // res.user available
        const user = res.user;
        if(user){
          // save profile locally
          const profile = {
            Name: user.displayName || '',
            Phone: user.phoneNumber || '',
            Email: user.email || '',
            Provider: 'google',
            UID: user.uid || ''
          };
          saveLocalProfile(profile);
          info('Signed in as ' + (profile.Name || profile.Email || profile.Phone));
          // redirect or update UI
          setTimeout(()=>{ window.location.href = 'profile.html'; }, 900);
        }
      }catch(error){
        console.error('Google sign-in failed', error);
        err('Google sign-in failed: ' + (error.message || error.code || 'unknown'));
      }
    }

    // ---------- Phone OTP (send / verify) ----------
    function setupRecaptcha(){
      // Only initialize once
      if(recaptchaVerifier) return recaptchaVerifier;
      try{
        // invisible reCAPTCHA by default
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          'size': 'invisible',
          'callback': function(response) {
            // recaptcha solved
            console.log('recaptcha solved', response);
          }
        });
        recaptchaVerifier.render().then(function(widgetId) {
          console.log('reCAPTCHA rendered, widgetId=',widgetId);
        });
      }catch(e){
        console.warn('recaptcha init failed', e);
        err('reCAPTCHA init failed. Check Firebase config and authorized domains.');
      }
      return recaptchaVerifier;
    }

    async function sendOTP(){
      clearMsgs();
      if(!ensureFirebaseReady()) return;
      const rawPhone = inputPhone.value || '';
      const phone = normalizePhone(rawPhone);
      if(!validPhone(phone)){
        warn('Enter valid phone number (with country code).');
        return;
      }
      lastPhoneSent = phone;
      phoneStatus.textContent = 'Sending OTP…';
      setupRecaptcha();
      try{
        // use recaptchaVerifier
        confirmationResult = await firebase.auth().signInWithPhoneNumber(phone, recaptchaVerifier);
        phoneStatus.textContent = 'OTP sent to ' + phone + '.';
        otpBlock.style.display = 'block';
        info('OTP sent; enter verification code.');
      }catch(err){
        console.error('sendOTP error', err);
        // common causes: recaptcha not configured, unauthorized domain, quota, invalid phone format
        if(err && err.code){
          if(err.code === 'auth/invalid-phone-number'){
            err('Invalid phone number.');
          } else if(err.code === 'auth/too-many-requests'){
            err('SMS quota exceeded. Try again later.');
          } else {
            err('Phone OTP error: ' + (err.message || err.code));
          }
        } else {
          err('Phone OTP failed: ' + (err && err.message ? err.message : 'unknown'));
        }
        phoneStatus.textContent = '';
      } finally {
        // re-enable recaptcha if you want
      }
    }

    async function verifyOTP(){
      clearMsgs();
      const code = (inputOTP.value || '').trim();
      if(!confirmationResult){
        warn('OTP not requested yet. Press "Send OTP" first.');
        return;
      }
      if(!code){
        warn('Enter OTP code.');
        return;
      }
      try{
        const res = await confirmationResult.confirm(code);
        const user = res.user;
        if(user){
          // Save profile locally (we may not have displayName)
          const profile = {
            Name: user.displayName || '',
            Phone: lastPhoneSent || (user.phoneNumber || ''),
            Email: user.email || '',
            Provider: 'phone',
            UID: user.uid || ''
          };
          saveLocalProfile(profile);
          info('Phone verified. Signed in.');
          setTimeout(()=>{ window.location.href = 'profile.html'; }, 900);
        }
      }catch(err){
        console.error('verifyOTP failed', err);
        err('OTP verify failed: ' + (err.message || err.code || 'invalid code'));
      }
    }

    async function resendOTP(){
      // simple resend: re-render recaptcha and send again
      if(!lastPhoneSent){
        warn('No previous phone found — enter phone and press Send OTP first.');
        return;
      }
      inputOTP.value = '';
      setupRecaptcha();
      try{
        confirmationResult = await firebase.auth().signInWithPhoneNumber(lastPhoneSent, recaptchaVerifier);
        info('OTP resent to ' + lastPhoneSent);
      }catch(e){
        console.error('resend failed', e);
        err('Resend failed: ' + (e.message || e.code));
      }
    }

    // ---------- On load: wire UI ----------
    function wireUI(){
      // Google click
      googleSignIn.addEventListener('click', signInWithGoogle);
      googleSignIn.addEventListener('keypress', function(e){
        if(e.key === 'Enter' || e.key === ' ') signInWithGoogle();
      });

      btnSendOTP.addEventListener('click', sendOTP);
      btnVerifyOTP.addEventListener('click', verifyOTP);
      btnResendOTP.addEventListener('click', resendOTP);

      btnCheckLocal.addEventListener('click', renderSavedProfile);
      btnUseProfile.addEventListener('click', function(){
        const p = loadLocalProfile();
        if(!p) { warn('No saved profile'); return; }
        // if profile contains UID or email, optionally try to log the user in server-side
        info('Profile loaded: ' + (p.Name || p.Phone || p.Email));
        // redirect to checkout/profile
        setTimeout(()=> window.location.href = 'profile.html', 600);
      });
      btnClearProfile.addEventListener('click', function(){
        clearLocalProfile();
        info('Local profile cleared');
      });
    }

    // ---------- utility: check auth state ----------
    function watchAuthState(){
      if(!ensureFirebaseReady()) return;
      firebase.auth().onAuthStateChanged(function(user){
        if(user){
          console.log('Auth state changed: signed in as', user.uid);
          // optionally save local profile
          const p = {
            Name: user.displayName || '',
            Email: user.email || '',
            Phone: user.phoneNumber || '',
            UID: user.uid
          };
          saveLocalProfile(p);
        } else {
          console.log('Auth state: signed out');
        }
        renderSavedProfile();
      });
    }

    // ---------- init ----------
    function init(){
      // render saved
      renderSavedProfile();
      // init recaptcha only when needed (on send)
      // wire UI
      wireUI();
      // watch firebase auth
      try{
        if(typeof firebase !== 'undefined' && firebase && firebase.auth) {
          watchAuthState();
        } else {
          // firebase not ready yet — show a gentle info
          console.warn('firebase not ready on login page; ensure firebase-config.js loads before this file.');
        }
      }catch(e){ console.warn('auth watch init error', e); }
    }

    // run init after DOM ready
    document.addEventListener('DOMContentLoaded', init);

    // expose small debug helpers
    window._nj_login = {
      saveLocalProfile,
      loadLocalProfile,
      clearLocalProfile,
      sendOTP,
      verifyOTP
    };

  })();
  </script>
<!-- Extra notes, analytics and meta helpers — keep at bottom of file -->

  <!-- Optional: small inline script to show helpful debug information -->
  <script>
    (function(){
      // small debug log; remove in production if not needed
      try{
        console.log('NJ Mart login page loaded');
        if(typeof NJ !== 'undefined') console.log('NJ config:', NJ);
        if(typeof BACKEND_URL !== 'undefined') console.log('BACKEND_URL:', BACKEND_URL);
      }catch(e){}
    })();
  </script>

  <!-- Accessibility: focus management (helps keyboard users) -->
  <script>
  (function(){
    // focus the main title for screen readers on load
    document.addEventListener('DOMContentLoaded', function(){
      var el = document.getElementById('loginTitle');
      if(el && el.focus) {
        el.setAttribute('tabindex','-1');
        el.focus();
      }
    });
  })();
  </script>

  <!-- SEO + Social meta (kept minimal to avoid repetition) -->
  <meta name="description" content="NJ Mart — quick local grocery. Sign in with Google or Phone OTP.">
  <meta name="robots" content="index,follow">

  <!-- Optional structured data (schema) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"NJ Mart — Login",
    "url": window.location.href || "https://njmart.netlify.app/login.html",
    "description":"Sign in to NJ Mart — Google or Phone OTP for quick checkout."
  }
  </script>

  <!-- End of login.html -->
</body>
</html>
