<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NJ Mart — Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #2db34a;
      --muted: #7b7f86;
      --card: #ffffff;
      --bg: #f3faf6;
      --danger: #e04d4d;
      --shadow: 0 8px 24px rgba(12,30,40,0.06);
      --radius: 12px;
    }
    * { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    body { margin:0; background: var(--bg); color:#111; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .wrap { max-width: 920px; margin: 28px auto; padding: 18px; display: grid; gap:20px; grid-template-columns: 1fr 400px; align-items:start; }
    @media (max-width:980px){ .wrap { grid-template-columns: 1fr; padding:12px } .right { order:2 } .left { order:1 } }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding:18px; }
    h1 { margin: 0 0 6px; font-size:20px; }
    p.lead { margin:0 0 12px; color:var(--muted) }

    /* Login box */
    .login-box { max-width:100%; }
    .btn { border:0; border-radius:10px; padding:12px 14px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:10px; }
    .btn.google { background:#fff; border:1px solid #e6e9ec; color:#222; width:100%; justify-content:center; }
    .btn.primary { background:var(--green); color:#fff; width:100%; justify-content:center; }
    .btn.ghost { background:#fff; border:1px solid #e6e9ec; color:#222; width:100%; }
    .field { margin-top:12px; }
    input[type="tel"], input[type="text"], input[type="email"], textarea {
      width:100%; padding:12px; border-radius:10px; border:1px solid #e6e9ec; font-size:14px;
    }
    .muted { color:var(--muted); font-size:13px; margin-top:10px; text-align:center; }

    /* small message box */
    .msg { margin-top:12px; padding:10px; border-radius:8px; background:#f1fff3; color:#1f6f2f; display:none; }
    .msg.error { background:#fff6f6; color:var(--danger); }

    /* profile summary */
    .profile-card { display:flex; flex-direction:column; gap:8px; }
    .profile-row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .profile-row div { font-size:14px; color:#333; }

    .small { font-size:13px; color:var(--muted) }

    /* footer note */
    .note { margin-top:12px; color:var(--muted); font-size:13px; text-align:center; }

    /* recaptcha placeholder */
    #recaptcha-container { margin-top:8px; }
  </style>
</head>
<body>

  <div class="wrap">

    <!-- Left: content / hero -->
    <div class="left">
      <div class="card">
        <h1>Welcome to NJ Mart</h1>
        <p class="lead">Fast grocery delivery, easy checkout and secure login — sign in with Google or phone OTP. Your profile will be saved locally and you can continue shopping.</p>

        <div style="margin-top:18px;">
          <strong>Why sign in?</strong>
          <ul style="margin:8px 0 0 18px; color:var(--muted)">
            <li>Save address & phone</li>
            <li>View orders & checkout quickly</li>
            <li>Cart persistence across pages</li>
          </ul>
        </div>

        <div style="margin-top:18px;">
          <a href="index.html" style="color:var(--green); text-decoration:none;">← Back to shopping</a>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <h3 style="margin:0 0 8px">Demo quick guide</h3>
        <div class="small">
          • Use Google sign-in or enter phone with +country code and send OTP. <br>
          • After sign-in you will be able to save name, phone and address on the profile card and proceed to checkout. <br>
          • If OTP/Google fails, check Firebase console (Auth), authorized domains and reCAPTCHA settings.
        </div>
      </div>
    </div>

    <!-- Right: login card -->
    <aside class="right">
      <div class="card login-box">

        <h1>Sign in to NJ Mart</h1>
        <p class="lead">Choose a quick sign-in method below</p>

        <!-- Google -->
        <button id="googleBtn" class="btn google">
          <svg width="18" height="18" viewBox="0 0 48 48" style="vertical-align:middle"><path fill="#4285F4" d="M24 9.5c3.5 0 6.5 1.2 8.7 2.9l6.4-6.5C34 2.7 29.6 1 24 1 14.9 1 6.9 6 3.2 13.9l7.8 6.1C12.2 13 17.6 9.5 24 9.5z"/><path fill="#34A853" d="M46.5 24.5c0-1.4-.1-2.8-.4-4.1H24v8.2h12.9c-.6 3.3-2.6 6-5.6 7.7l8.6 6.6C43.7 38.7 46.5 32 46.5 24.5z"/><path fill="#FBBC05" d="M10.9 29.9c-.9-2.4-1.4-4.9-1.4-7.4s.5-5 1.4-7.4L3.1 9.1C1.2 12.6 0 16.6 0 20.5s1.2 7.9 3.1 11.4l7.8-1.9z"/><path fill="#EA4335" d="M24 46.9c6 0 11.2-2 15-5.4l-8.6-6.6c-2.4 1.6-5.4 2.6-8.4 2.6-6.5 0-11.9-3.8-14.2-9.1L3.1 38.9C6.8 43.9 14.6 46.9 24 46.9z"/></svg>
          <span style="font-size:15px">Sign in with Google</span>
        </button>

        <div style="height:8px"></div>

        <div style="text-align:center; color:var(--muted); margin:8px 0">or</div>

        <!-- Phone input -->
        <div class="field">
          <label class="small">Phone number</label>
          <input id="phoneInput" type="tel" placeholder="+91 9876543210" />
        </div>

        <div id="recaptcha-container"></div>

        <div style="display:flex; gap:10px; margin-top:12px;">
          <button id="sendOtp" class="btn primary" style="flex:1">Send OTP</button>
          <button id="clearSession" class="btn ghost" style="flex:1">Clear local session</button>
        </div>

        <div class="field" style="margin-top:12px;">
          <label class="small">Enter OTP</label>
          <input id="otpInput" type="text" placeholder="123456" style="display:none" />
          <button id="verifyOtp" class="btn primary" style="display:none; margin-top:8px">Verify OTP</button>
        </div>

        <div id="message" class="msg"></div>

        <div class="note">By signing in you agree to our Terms & Privacy.</div>

        <!-- Signed-in info -->
        <div id="signedBox" style="display:none; margin-top:12px">
          <div class="profile-card">
            <div class="profile-row"><div><strong id="signedLabel">Signed in as:</strong></div></div>
            <div class="profile-row"><div id="signedEmail">email@example.com</div></div>

            <!-- profile form -->
            <div style="margin-top:12px; padding:12px; border-radius:10px; background:#fbfffb;">
              <label class="small">Name</label>
              <input id="profileName" type="text" placeholder="Your name">

              <label class="small" style="margin-top:8px">Phone (with country code)</label>
              <input id="profilePhone" type="tel" placeholder="+91 9876543210">

              <label class="small" style="margin-top:8px">Address</label>
              <textarea id="profileAddress" rows="3" placeholder="House, Street, Area"></textarea>

              <div style="display:flex;gap:8px;margin-top:10px">
                <button id="getLocation" class="btn ghost" style="flex:1">Get Current Location</button>
                <button id="saveProfile" class="btn primary" style="flex:1">Save Profile</button>
              </div>

              <div class="small" style="margin-top:8px">Latitude: <span id="latShow">—</span> Longitude: <span id="lngShow">—</span></div>
            </div>

            <div style="display:flex; gap:10px; margin-top:12px;">
              <button id="gotoAccount" class="btn ghost" style="flex:1">Go to Account</button>
              <button id="signout" class="btn" style="flex:1; background:var(--danger); color:#fff">Sign Out</button>
            </div>

            <div class="small" style="margin-top:10px">Status: <span id="authStatus">Not signed in</span></div>
          </div>
        </div>

      </div>
    </aside>
  </div>

  <!-- Firebase SDK (v8 style) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
  /****************************************************************
   * NJ Mart - login page
   * Features:
   *  - Google Sign-in (popup)
   *  - Phone OTP sign-in (with reCAPTCHA invisible)
   *  - Save basic profile locally (name, phone, address, lat/lng)
   *  - Redirect to profile/checkout pages as needed
   *
   * Instructions:
   *  - Replace firebaseConfig below with your project's config
   *  - Ensure Auth providers enabled in Firebase console
   *  - Add netlify domain/localhost to authorized domains
   ****************************************************************/

  // ---------- Replace with your real Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCbf19k8pLFh-9UQz8sQRim2rPYTlqaEL8",
    authDomain: "njmartonline.firebaseapp.com",
    projectId: "njmartonline",
    storageBucket: "njmartonline.appspot.com",
    messagingSenderId: "594505763627",
    appId: "1:594505763627:web:a13b0d3ef40e620f9b936e"
  };
  // ------------------------------------------------------------

  // init firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  // UI elements
  const googleBtn = document.getElementById('googleBtn');
  const phoneInput = document.getElementById('phoneInput');
  const sendOtpBtn = document.getElementById('sendOtp');
  const otpInput = document.getElementById('otpInput');
  const verifyOtpBtn = document.getElementById('verifyOtp');
  const messageBox = document.getElementById('message');
  const signedBox = document.getElementById('signedBox');
  const signedEmail = document.getElementById('signedEmail');
  const authStatus = document.getElementById('authStatus');
  const profileName = document.getElementById('profileName');
  const profilePhone = document.getElementById('profilePhone');
  const profileAddress = document.getElementById('profileAddress');
  const getLocationBtn = document.getElementById('getLocation');
  const saveProfileBtn = document.getElementById('saveProfile');
  const signoutBtn = document.getElementById('signout');
  const clearSessionBtn = document.getElementById('clearSession');
  const gotoAccountBtn = document.getElementById('gotoAccount');
  const latShow = document.getElementById('latShow');
  const lngShow = document.getElementById('lngShow');

  // helper messages
  function showMsg(text, type='ok'){
    messageBox.style.display = 'block';
    messageBox.className = 'msg' + (type==='error' ? ' error' : '');
    messageBox.innerText = text;
    setTimeout(()=>{ messageBox.style.display = 'none'; }, 8000);
  }

  // set up reCAPTCHA (invisible)
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    'size': 'invisible',
    'callback': (response) => {
      // grecaptcha callback (handled automatically)
      console.log('reCAPTCHA resolved');
    }
  });

  // --- Google sign in ---
  googleBtn.addEventListener('click', ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        const user = result.user;
        onSignedIn(user, 'Google');
      })
      .catch(err => {
        console.error(err);
        showMsg('Google Sign-in error: ' + (err.message||err), 'error');
      });
  });

  // --- Phone OTP ---
  sendOtpBtn.addEventListener('click', async ()=>{
    const phone = phoneInput.value.trim();
    if(!phone){ showMsg('Enter phone with country code e.g. +91 9876543210','error'); return; }

    try {
      // show recaptcha & send
      const appVerifier = window.recaptchaVerifier;
      const confirmationResult = await auth.signInWithPhoneNumber(phone, appVerifier);
      window.confirmationResult = confirmationResult;
      otpInput.style.display = 'block';
      verifyOtpBtn.style.display = 'block';
      showMsg('OTP sent to ' + phone);
    } catch(err){
      console.error(err);
      showMsg('OTP send error: ' + (err.message||err), 'error');
      // Usually billing or recaptcha error — check firebase console / authorized domains
    }
  });

  verifyOtpBtn.addEventListener('click', async ()=>{
    const code = otpInput.value.trim();
    if(!code){ showMsg('Enter OTP', 'error'); return; }
    try {
      const result = await window.confirmationResult.confirm(code);
      const user = result.user;
      onSignedIn(user, 'Phone');
      showMsg('Phone verified');
      otpInput.style.display = 'none'; verifyOtpBtn.style.display = 'none';
    } catch(err){
      console.error(err);
      showMsg('OTP verify failed: ' + (err.message||err), 'error');
    }
  });

  // when signed in show profile panel
  function onSignedIn(user, method){
    signedBox.style.display = 'block';
    signedEmail.innerText = user.email || user.phoneNumber || ('UID: ' + user.uid);
    authStatus.innerText = 'Signed in via ' + method;
    // prefill profile fields from localStorage or firebase
    const saved = JSON.parse(localStorage.getItem('nj_profile') || '{}');
    profileName.value = saved.name || user.displayName || '';
    profilePhone.value = saved.phone || user.phoneNumber || phoneInput.value || '';
    profileAddress.value = saved.address || '';
    if(saved.lat) latShow.innerText = saved.lat;
    if(saved.lng) lngShow.innerText = saved.lng;
    // show success
    showMsg('Signed in successfully');
    // Save a small session flag
    localStorage.setItem('nj_signed', JSON.stringify({ uid:user.uid, method:method, email:user.email||'', phone:user.phoneNumber||'' }));
  }

  // auth state change (persists across page loads)
  auth.onAuthStateChanged(user=>{
    if(user){
      onSignedIn(user, 'existing');
    } else {
      // not signed in
      // if you want to auto show previously saved profile -> you can populate fields too
      const saved = JSON.parse(localStorage.getItem('nj_profile') || '{}');
      if(saved && saved.name){
        // show partial profile but not signed-in
      }
    }
  });

  // Save profile locally
  saveProfileBtn.addEventListener('click', ()=>{
    const data = {
      name: profileName.value.trim(),
      phone: profilePhone.value.trim(),
      address: profileAddress.value.trim(),
      lat: latShow.innerText === '—' ? '' : latShow.innerText,
      lng: lngShow.innerText === '—' ? '' : lngShow.innerText,
      savedAt: Date.now()
    };
    localStorage.setItem('nj_profile', JSON.stringify(data));
    showMsg('Profile saved locally');
  });

  // Get current location
  getLocationBtn.addEventListener('click', ()=>{
    if(!navigator.geolocation){
      showMsg('Geolocation not supported by your browser', 'error'); return;
    }
    getLocationBtn.innerText = 'Getting...';
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude.toFixed(7);
      const lng = pos.coords.longitude.toFixed(7);
      latShow.innerText = lat;
      lngShow.innerText = lng;
      getLocationBtn.innerText = 'Get Current Location';
      showMsg('Location obtained');
    }, err=>{
      console.error(err);
      getLocationBtn.innerText = 'Get Current Location';
      showMsg('Failed to get location: ' + (err.message||err), 'error');
    }, { enableHighAccuracy:true, timeout:10000 });
  });

  // Sign out
  signoutBtn.addEventListener('click', ()=>{
    auth.signOut().then(()=>{
      // clear session flag
      localStorage.removeItem('nj_signed');
      signedBox.style.display = 'none';
      showMsg('Signed out');
    }).catch(err=>{
      console.error(err);
      showMsg('Sign out failed: ' + (err.message||err), 'error');
    });
  });

  // Clear local session button (logout locally, keep firebase)
  clearSessionBtn.addEventListener('click', ()=>{
    localStorage.removeItem('nj_signed');
    localStorage.removeItem('nj_profile');
    // keep firebase auth as-is or sign out as well? We'll just clear local state.
    showMsg('Local session cleared');
  });

  // Go to account/profile page (profile.html)
  gotoAccountBtn.addEventListener('click', ()=>{
    // If you want ensure sign-in before allowing -> check auth.currentUser or nj_signed
    const signed = localStorage.getItem('nj_signed');
    if(!signed && !auth.currentUser){
      showMsg('Please sign in first', 'error'); return;
    }
    // redirect to profile page (create profile.html separately)
    location.href = 'profile.html';
  });

  // On page load check for existing local signed & populate UI
  (function init(){
    // load profile if present
    const saved = JSON.parse(localStorage.getItem('nj_profile') || '{}');
    if(saved && saved.name){
      profileName.value = saved.name || '';
      profilePhone.value = saved.phone || '';
      profileAddress.value = saved.address || '';
      if(saved.lat){ latShow.innerText = saved.lat; }
      if(saved.lng){ lngShow.innerText = saved.lng; }
    }
    const signed = JSON.parse(localStorage.getItem('nj_signed') || 'null');
    if(signed){
      // show signed box with saved data in UI (but firebase might be expired)
      signedBox.style.display = 'block';
      signedEmail.innerText = signed.email || signed.phone || ('UID:' + signed.uid);
      authStatus.innerText = 'Signed (local session)';
    }
  })();

  // A tiny helper to show console hint for debugging
  console.log('Login page initialized. Check Firebase config and Auth providers if sign-in fails.');
  </script>

  <!-- cache-bust comment -->
  <!-- login.html v20250908 -->
</body>
</html>
