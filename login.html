<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Admin Login</title>

  <!-- Simple CSS reset and styles (keeps file self-contained) -->
  <style>
    /* Basic reset */
    html,body,div,span,applet,object,iframe,
    h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,
    address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,
    small,strike,strong,sub,sup,tt,var,b,u,i,center,
    dl,dt,dd,ol,ul,li,fieldset,form,label,legend,
    table,caption,tbody,tfoot,thead,tr,th,td {
      margin:0; padding:0; border:0; font-size:100%; vertical-align:baseline;
    }
    html,body { height:100%; }
    body {
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #f7fafc;
      color: #1a202c;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
      padding: 20px;
    }

    /* Layout */
    .container {
      max-width: 980px;
      margin: 18px auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(10,10,20,0.06);
      overflow: hidden;
      display: flex;
      gap: 0;
      min-height: 540px;
    }

    .left-panel {
      width: 420px;
      background: linear-gradient(180deg,#10b981,#059669);
      color: white;
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: flex-start;
      justify-content: center;
    }

    .brand {
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:700;
      font-size:20px;
    }
    .brand .logo {
      width:44px; height:44px; border-radius:8px;
      background: rgba(255,255,255,0.18);
      display:flex; align-items:center; justify-content:center;
      font-weight:700; color:white;
    }
    .left-panel h1 {
      font-size:28px; margin-top:6px;
      line-height:1.05;
    }
    .left-panel p { opacity:0.95; margin-top:6px; font-size:14px; max-width:320px; }

    .right-panel {
      flex:1; padding: 28px 30px;
      display:flex; flex-direction:column;
      gap:18px;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 6px 18px rgba(12, 12, 20, 0.04);
    }

    /* Tabs */
    .tabs {
      display:flex; gap:8px;
      margin-bottom: 10px;
    }
    .tab {
      padding:8px 12px; border-radius:8px; cursor:pointer;
      background: #f3f4f6; color: #374151; font-weight:600;
      border: 1px solid rgba(15, 15, 20, 0.02);
    }
    .tab.active { background: white; box-shadow: 0 4px 10px rgba(12,12,20,0.04); }

    /* forms */
    form { display:flex; flex-direction:column; gap:12px; }
    label { font-size:13px; color:#374151; font-weight:600; }
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"] {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6e9ef;
      font-size:14px; outline:none;
      box-sizing:border-box;
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, input[type="tel"]:focus {
      border-color: #7dd3fc;
      box-shadow: 0 8px 20px rgba(34,197,94,0.04);
    }
    .row { display:flex; gap:10px; align-items:center; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:10px; cursor:pointer; border:0; font-weight:700;
    }
    .btn.primary {
      background: #059669; color:white;
      box-shadow: 0 10px 24px rgba(5,150,105,0.12);
    }
    .btn.ghost {
      background: transparent; border:1px solid #e6e9ef; color:#111827;
    }
    .muted { color:#6b7280; font-size:13px; }

    .socials {
      display:flex; gap:8px;
    }
    .social-btn {
      flex:1; padding:9px; border-radius:9px; display:flex; gap:8px; align-items:center; justify-content:center; cursor:pointer;
      border:1px solid rgba(0,0,0,0.06);
      background: #fff;
    }

    .footer {
      margin-top:auto; font-size:13px; color:#6b7280; text-align:center;
      padding-top:12px;
    }

    .notice {
      background:#fff3cd; color:#665b00; padding:10px; border-radius:8px; font-size:13px;
      border:1px solid rgba(200,160,0,0.12);
    }

    .status-line { font-size:13px; color:#374151; }

    /* responsive */
    @media (max-width:980px) {
      .container { flex-direction:column; padding:10px; margin:10px; }
      .left-panel { width:100%; order:2; padding:20px; text-align:center; }
      .right-panel { order:1; padding:18px; }
    }
  </style>

  <!-- Firebase CDN (compat libs) -->
  <!-- Using compat builds for simpler top-level API in a single file -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <!-- NOTE: If Identity Toolkit / reCAPTCHA calls fail in console, check Cloud Console settings and ensure API key is enabled and authorized domain added -->
</head>
<body>
  <div class="container" id="app-root">
    <div class="left-panel">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>NJ Mart Admin</div>
      </div>

      <h1>Admin access</h1>
      <p>Use Google, Email or Phone OTP to sign into your admin panel. Keep credentials safe.</p>

      <div style="margin-top:12px;">
        <div class="notice">
          Make sure <strong>Authorized domains</strong> in Firebase console contains your deployment domain (e.g., njmart.netlify.app)
        </div>
      </div>

      <div style="margin-top:18px; font-size:13px; opacity:0.95;">
        <div><strong>Support:</strong> +91 70000 00000</div>
        <div style="margin-top:6px" class="muted">Site: njmart.netlify.app</div>
      </div>
    </div>

    <div class="right-panel">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div>
          <div style="font-weight:700; font-size:20px;">Sign in to your admin account</div>
          <div class="muted" style="margin-top:4px;">Choose one of the available sign-in methods</div>
        </div>
        <div class="status-line" id="status-line">Initializing...</div>
      </div>

      <div class="card">
        <div class="tabs">
          <div class="tab active" data-tab="google" id="tab-google">Google</div>
          <div class="tab" data-tab="email" id="tab-email">Email</div>
          <div class="tab" data-tab="phone" id="tab-phone">Phone OTP</div>
        </div>

        <!-- Google Signin -->
        <div id="panel-google" class="panel">
          <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
            <div style="flex:1;">
              <div style="font-weight:700">Continue with Google</div>
              <div class="muted" style="font-size:13px">Use your Google account</div>
            </div>
            <div style="width:160px;">
              <button class="btn primary" id="btn-google">Sign in with Google</button>
            </div>
          </div>

          <div class="muted">Or use Email / Phone from tabs.</div>
        </div>

        <!-- Email Signin -->
        <div id="panel-email" class="panel" style="display:none;">
          <form id="form-email">
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@company.com" required />
            </div>
            <div>
              <label for="password">Password</label>
              <input id="password" type="password" placeholder="Enter password" required />
            </div>

            <div style="display:flex; gap:10px; margin-top:6px;">
              <button type="button" class="btn primary" id="btn-email-login">Login</button>
              <button type="button" class="btn ghost" id="btn-email-signup">Sign up</button>
              <button type="button" class="btn ghost" id="btn-forgot">Forgot</button>
            </div>
          </form>
        </div>

        <!-- Phone Signin -->
        <div id="panel-phone" class="panel" style="display:none;">
          <form id="form-phone">
            <div>
              <label for="phone">Phone (E.164 format)</label>
              <input id="phone" type="tel" placeholder="+91 70000 00000" />
            </div>

            <div id="recaptcha-container" style="margin-top:8px;"></div>

            <div style="display:flex; gap:10px; margin-top:10px;">
              <button type="button" class="btn primary" id="btn-send-otp">Send OTP</button>
              <button type="button" class="btn ghost" id="btn-clear-otp" style="display:none;">Clear</button>
            </div>

            <div id="otp-section" style="display:none; margin-top:12px;">
              <label for="otp">Enter OTP</label>
              <input id="otp" type="text" placeholder="123456" />
              <div style="display:flex; gap:10px; margin-top:8px;">
                <button type="button" class="btn primary" id="btn-verify-otp">Verify</button>
                <button type="button" class="btn ghost" id="btn-resend-otp">Resend</button>
              </div>
            </div>
          </form>
        </div>

        <hr style="margin:14px 0; border:none; border-top:1px solid #eef2f6;" />

        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
          <div class="muted">Logged-in user: <span id="user-email" style="font-weight:700">—</span></div>
          <div style="display:flex; gap:8px;">
            <button class="btn ghost" id="btn-signout">Sign out</button>
          </div>
        </div>

      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:700; margin-bottom:8px;">Developer logs</div>
        <pre id="dev-log" style="height:140px; overflow:auto; background:#fcfcfe; padding:10px; border-radius:8px; border:1px solid #eef2f6;"></pre>
      </div>

      <div class="footer">
        © NJ Mart — All rights reserved.
      </div>

    </div>
  </div>

  <!-- Begin Firebase configuration and app logic -->
  <script>
    /*************************************************************************
     * Firebase Configuration
     *
     * NOTE: This is the "config" snippet. If you host your app with bundlers
     * or NPM toolchain you might choose a different method. This file uses
     * the CDN "compat" approach for simplicity.
     *
     * Replace or verify values are correct in Firebase console (Project settings)
     *************************************************************************/

    const firebaseConfig = {
      apiKey: "AIzaSyCbf19k8pLFh-9Uq28s0Rim2rPYT1qaEL8",
      authDomain: "njmartonline.firebaseapp.com",
      projectId: "njmartonline",
      storageBucket: "njmartonline.firebasestorage.app",
      messagingSenderId: "594505763627",
      appId: "1:594505763627:web:a13b0da3ef40e620f9b936e"
    };

    // Initialize Firebase
    let app, auth;
    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      consoleLog("[NJ] Firebase initialized: " + (app.name || "default"));
    } catch (err) {
      consoleLog("[NJ][ERROR] Firebase init failed: " + err);
    }

    // Utility for dev log
    function consoleLog(msg) {
      const d = new Date().toISOString();
      const el = document.getElementById('dev-log');
      el.textContent = d + "  " + msg + "\n" + el.textContent;
      // Also print to browser console for convenience
      console.log(msg);
    }

    // Status line update
    function updateStatus(text) {
      const s = document.getElementById('status-line');
      s.textContent = text;
      consoleLog("[STATUS] " + text);
    }

    updateStatus("Initializing login UI...");

    /*************************************************************************
     * UI & Tabs
     *************************************************************************/
    (function setupTabs(){
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t => {
        t.addEventListener('click', () => {
          tabs.forEach(x => x.classList.remove('active'));
          t.classList.add('active');
          showPanel(t.getAttribute('data-tab'));
        });
      });

      function showPanel(name) {
        document.getElementById('panel-google').style.display = name==='google' ? 'block' : 'none';
        document.getElementById('panel-email').style.display = name==='email' ? 'block' : 'none';
        document.getElementById('panel-phone').style.display = name==='phone' ? 'block' : 'none';
      }

      // default: google
      showPanel('google');
    })();

    /*************************************************************************
     * Auth State Listener
     *************************************************************************/
    let currentUser = null;
    if (auth) {
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
          document.getElementById('user-email').textContent = user.email || user.phoneNumber || user.displayName || user.uid;
          updateStatus("User signed in");
          consoleLog("[NJ] Signed in: " + (user.email || user.phoneNumber || user.uid));
        } else {
          document.getElementById('user-email').textContent = "No user logged in";
          updateStatus("Ready. Use Google / Email / Phone to login.");
          consoleLog("[NJ] No user logged in");
        }
      });
    } else {
      updateStatus("Firebase not initialized");
      consoleLog("[NJ] Auth object not initialized.");
    }

    /*************************************************************************
     * Google Sign-in (Popup)
     *************************************************************************/
    document.getElementById('btn-google').addEventListener('click', async function() {
      updateStatus("Opening Google sign-in...");
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('profile');
        provider.addScope('email');

        // popup sign-in
        const result = await auth.signInWithPopup(provider);
        consoleLog('[NJ] Google signin success: ' + JSON.stringify({ user: result.user && result.user.email }));
        updateStatus("Google sign-in success");
      } catch (err) {
        consoleLog("[NJ][Google Signin Error] " + err);
        updateStatus("Google sign-in failed (see console)");
      }
    });

    /*************************************************************************
     * Email/Password Login & Signup
     *************************************************************************/
    document.getElementById('btn-email-login').addEventListener('click', async function() {
      const email = document.getElementById('email').value.trim();
      const pwd = document.getElementById('password').value;
      if (!email || !pwd) { updateStatus("Email & password required"); return; }
      updateStatus("Signing in with email...");
      try {
        const res = await auth.signInWithEmailAndPassword(email, pwd);
        consoleLog("[NJ] Email login success: " + (res.user && res.user.email));
        updateStatus("Email login successful");
      } catch (err) {
        consoleLog("[NJ][EmailLoginError] " + err);
        updateStatus("Email login failed. " + (err && err.message));
      }
    });

    document.getElementById('btn-email-signup').addEventListener('click', async function() {
      const email = document.getElementById('email').value.trim();
      const pwd = document.getElementById('password').value;
      if (!email || !pwd) { updateStatus("Email & password required for signup"); return; }
      updateStatus("Creating account...");
      try {
        const res = await auth.createUserWithEmailAndPassword(email, pwd);
        consoleLog("[NJ] Signup success: " + (res.user && res.user.email));
        updateStatus("Account created and signed in");
      } catch (err) {
        consoleLog("[NJ][SignupError] " + err);
        updateStatus("Signup failed: " + (err && err.message));
      }
    });

    document.getElementById('btn-forgot').addEventListener('click', async function() {
      const email = document.getElementById('email').value.trim();
      if (!email) { updateStatus("Enter your email to reset password"); return; }
      updateStatus("Sending reset email...");
      try {
        await auth.sendPasswordResetEmail(email);
        updateStatus("Reset email sent (check inbox).");
        consoleLog("[NJ] Password reset email sent to " + email);
      } catch (err) {
        consoleLog("[NJ][ResetError] " + err);
        updateStatus("Reset failed: " + (err && err.message));
      }
    });

    /*************************************************************************
     * Sign out
     *************************************************************************/
    document.getElementById('btn-signout').addEventListener('click', async function() {
      if (!auth) return;
      try {
        await auth.signOut();
        updateStatus("Signed out");
        consoleLog("[NJ] User signed out");
      } catch (err) {
        consoleLog("[NJ][SignoutErr] " + err);
        updateStatus("Sign out failed");
      }
    });

    /*************************************************************************
     * Phone authentication (OTP) using reCAPTCHA verifier
     *************************************************************************/
    // We will create a global recaptchaVerifier and confirmationResult on send
    let recaptchaVerifier = null;
    let confirmationResult = null;

    function setupRecaptchaOnce() {
      // if already setup, return
      if (recaptchaVerifier) return;
      try {
        // render invisible container if not present
        const container = document.getElementById('recaptcha-container');
        if (!container) return;

        // Use Firebase reCAPTCHA verifier (visible or invisible)
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          size: 'invisible', // invisible, can be changed to 'normal' to show a visible widget
          callback: (response) => {
            consoleLog("[NJ] reCAPTCHA solved");
          },
          'expired-callback': () => {
            consoleLog("[NJ] reCAPTCHA expired - reset required");
          }
        });

        recaptchaVerifier.render().then(widgetId => {
          consoleLog("[NJ] reCAPTCHA rendered (widgetId=" + widgetId + ")");
        }).catch(err => {
          consoleLog("[NJ][reCAPTCHA render error] " + err);
        });

      } catch (err) {
        consoleLog("[NJ][reCAPTCHA setup failed] " + err);
      }
    }

    document.getElementById('btn-send-otp').addEventListener('click', async function() {
      const phoneNumber = document.getElementById('phone').value.trim();
      if (!phoneNumber) { updateStatus("Enter phone number in E.164 (e.g. +917000000000)"); return; }
      setupRecaptchaOnce();
      updateStatus("Sending SMS OTP...");
      try {
        // ensure recaptchaVerifier available
        if (!recaptchaVerifier) throw new Error("reCAPTCHA not initialized");

        // clear any previous
        confirmationResult = null;

        confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, recaptchaVerifier);
        consoleLog("[NJ] OTP sent (confirmationResult available)");
        updateStatus("OTP sent — enter the code below");
        document.getElementById('otp-section').style.display = 'block';
        document.getElementById('btn-clear-otp').style.display = 'inline-flex';
      } catch (err) {
        consoleLog("[NJ][PhoneSendError] " + err);
        updateStatus("Sending OTP failed: " + (err && err.message));
        // If failed due to recaptcha, reset recaptcha
        try { recaptchaVerifier && recaptchaVerifier.clear(); recaptchaVerifier = null; } catch(e){}
      }
    });

    document.getElementById('btn-verify-otp').addEventListener('click', async function() {
      const otp = document.getElementById('otp').value.trim();
      if (!otp) { updateStatus("Enter OTP"); return; }
      if (!confirmationResult) { updateStatus("No OTP request found; request OTP first"); return; }
      updateStatus("Verifying OTP...");
      try {
        const credentialResult = await confirmationResult.confirm(otp);
        consoleLog("[NJ] Phone sign-in success: " + (credentialResult.user && credentialResult.user.phoneNumber));
        updateStatus("Phone sign-in success");
        // hide OTP input on success
        document.getElementById('otp-section').style.display = 'none';
      } catch (err) {
        consoleLog("[NJ][VerifyOTPError] " + err);
        updateStatus("OTP verification failed: " + (err && err.message));
      }
    });

    document.getElementById('btn-clear-otp').addEventListener('click', function(){
      document.getElementById('otp').value = '';
      document.getElementById('otp-section').style.display = 'none';
      document.getElementById('btn-clear-otp').style.display = 'none';
      try { recaptchaVerifier && recaptchaVerifier.clear(); recaptchaVerifier = null; } catch(e) {}
      updateStatus("OTP cleared");
    });

    // Resend OTP = re-trigger the send flow (with recaptcha reset)
    document.getElementById('btn-resend-otp').addEventListener('click', async function() {
      try { recaptchaVerifier && recaptchaVerifier.clear(); recaptchaVerifier = null; } catch(e){}
      document.getElementById('otp').value = '';
      updateStatus("Resending OTP...");
      document.getElementById('btn-send-otp').click();
    });

    /*************************************************************************
     * End of Part 1
     *
     * Copy Part 2 below and paste immediately after this script tag in the same file
     *************************************************************************/
  </script>
  <script>
    /*************************************************************************
     * Part 2: additional helpers, diagnostics, and final bits
     *************************************************************************/

    // Small helper to show alerts within page (non-intrusive)
    function showInlineMsg(msg, type='info') {
      // Adds a single-line toast like message in developer logs top
      const d = new Date().toISOString();
      const el = document.getElementById('dev-log');
      const prefix = (type === 'error') ? '[ERROR]' : (type==='warn' ? '[WARN]' : '[INFO]');
      el.textContent = d + " " + prefix + " " + msg + "\n" + el.textContent;
    }

    // Diagnostics & troubleshooting check (run on load)
    function runDiagnostics() {
      try {
        if (!firebase || !auth) {
          updateStatus("Firebase missing or auth not ready");
          consoleLog("[NJ][Diag] Firebase or auth missing");
          return;
        }
        consoleLog("[NJ][Diag] Firebase SDK loaded, auth present.");
        // check API key visible
        if (firebaseConfig && firebaseConfig.apiKey) {
          consoleLog("[NJ][Diag] API key present (length: " + firebaseConfig.apiKey.length + ")");
        } else {
          consoleLog("[NJ][Diag] API key missing - configure project settings");
        }

        // authorized domains message
        consoleLog("[NJ][Diag] If Google sign-in fails with 'API key not valid', ensure:");
        consoleLog("  - The API key in project settings is unrestricted OR allowed for IdentityToolkit APIs");
        consoleLog("  - Authorized domains contains your domain (e.g., njmart.netlify.app or localhost)");
        consoleLog("  - OAuth client for web is configured (if using redirect flows)");
      } catch (err) {
        consoleLog("[NJ][DiagError] " + err);
      }
    }

    // Run diagnostics shortly after init
    setTimeout(()=> {
      runDiagnostics();
      updateStatus("Ready. Select Google / Email / Phone to login.");
    }, 600);

    /*************************************************************************
     * Extra UI polish (keyboard shortcuts)
     *************************************************************************/
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') {
        // clear OTP section on Escape
        document.getElementById('otp').value = '';
      }
    });

    /*************************************************************************
     * Helpful debug: display current auth info in console
     *************************************************************************/
    window.NJDebug = {
      getUser: () => currentUser,
      signOut: () => auth && auth.signOut()
    };

    /*************************************************************************
     * Helpful notes for deployment / troubleshooting:
     *
     * 1) API key errors (auth/api-key-not-valid) usually mean:
     *    - The API key is restricted or disabled OR
     *    - Authorized domains list does not contain the domain you are using
     *
     *    -> Go to Firebase Console > Project Settings > General > Web SDK Config
     *       and check the apiKey and other values.
     *
     *    -> Go to Firebase Console > Authentication > Sign-in method
     *       and ensure Google / Phone providers are enabled.
     *
     *    -> Phone auth requires a working reCAPTCHA; ensure Authorized domains and
     *       also check reCAPTCHA site settings in Google Cloud Console if necessary.
     *
     * 2) If reCAPTCHA fails to render:
     *    - Check console for network errors to gstatic.googleapis.com
     *    - Check allowed origins / authorized domains in Firebase
     *
     * 3) If using Netlify / Vercel / Cloudflare:
     *    - Ensure there are no extra content security policies blocking gstatic or googleapis
     *
     *************************************************************************/

    // final friendly log
    consoleLog("[NJ] Login UI fully loaded. Use Google / Email / Phone to sign in.");

    // Ensure the dev-log has some initial text for easier reading
    document.getElementById('dev-log').textContent = "Developer log (newest at top)\n\n" + document.getElementById('dev-log').textContent;

  </script>
</body>
</html>
  
