<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart - Cart</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;margin:0;padding:20px;}
    .cart-container{max-width:600px;margin:30px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.08);}
    h2{margin-top:0;}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee;}
    .cart-item:last-child{border-bottom:0;}
    .total{font-size:18px;font-weight:bold;margin:15px 0;text-align:right;}
    button{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
    .btn-primary{background:#27ae60;color:#fff;}
    .btn-secondary{background:#ddd;color:#333;}
    .actions{display:flex;justify-content:space-between;margin-top:20px;}
  </style>
</head>
<body>

  <div class="cart-container">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Your Cart</h2>
      <button class="btn-secondary" onclick="window.location.href='products.html'">‚úï</button>
    </div>

    <div id="cartItems"></div>
    <div id="cartTotal" class="total"></div>

    <div class="actions">
      <button class="btn-secondary" onclick="window.location.href='products.html'">‚Üê Continue Shopping</button>
      <button id="confirmOrderBtn" class="btn-primary">Confirm Order</button>
    </div>

    <div id="message" style="margin-top:10px;font-weight:600;"></div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCbf19k8pLFh-9UQz8sQRim2rPYTlqaEL8",
      authDomain: "njmartonline.firebaseapp.com",
      projectId: "njmartonline",
      storageBucket: "njmartonline.appspot.com",
      messagingSenderId: "594505763627",
      appId: "1:594505763627:web:a13b0d3ef40e620f9b936e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalEl = document.getElementById("cartTotal");
    const confirmBtn = document.getElementById("confirmOrderBtn");
    const msg = document.getElementById("message");

    // Load cart from localStorage
    let cart = JSON.parse(localStorage.getItem("cart") || "[]");

    function renderCart() {
      cartItemsEl.innerHTML = "";
      let total = 0;
      if (cart.length === 0) {
        cartItemsEl.innerHTML = "<p>Your cart is empty üõí</p>";
        cartTotalEl.textContent = "";
        confirmBtn.disabled = true;
        return;
      }
      cart.forEach((item, i) => {
        total += item.price * item.qty;
        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <span>${item.name} (x${item.qty})</span>
          <span>‚Çπ${item.price * item.qty}</span>
        `;
        cartItemsEl.appendChild(div);
      });
      cartTotalEl.textContent = "Total: ‚Çπ" + total;
      confirmBtn.disabled = false;
    }

    renderCart();

    // Confirm order
    confirmBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("‚ö†Ô∏è Please login first to confirm your order");
        window.location.href = "/login.html";
        return;
      }

      const profileRef = db.collection("customers").doc(user.uid);
      const snap = await profileRef.get();
      if (!snap.exists) {
        alert("‚ö†Ô∏è Please complete your profile before confirming order");
        window.location.href = "/profile.html";
        return;
      }

      const orderData = {
        items: cart,
        total: cart.reduce((sum, i) => sum + i.price * i.qty, 0),
        status: "pending",
        userId: user.uid,
        createdAt: new Date()
      };

      try {
        const orderId = "order_" + Date.now();
        await db.collection("orders").doc(orderId).set(orderData);
        msg.style.color = "#27ae60";
        msg.textContent = "‚úÖ Order placed successfully!";
        localStorage.removeItem("cart");
        setTimeout(() => {
          window.location.href = "/orders.html"; // redirect to orders page
        }, 1500);
      } catch (err) {
        console.error(err);
        msg.style.color = "#c0392b";
        msg.textContent = "‚ùå Error placing order: " + err.message;
      }
    });
  </script>
</body>
</html>
