<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cart — NJ Mart</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--primary:#2fa360;--accent:#0b7dd6;--muted:#6b6f76;--danger:#e04b3a}
    body{font-family:Inter,system-ui,Arial; background:var(--bg); margin:0; color:#111}
    .wrap{max-width:1000px;margin:18px auto;padding:16px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
    .item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:10px}
    .item img{width:88px;height:88px;object-fit:cover;border-radius:8px}
    .title{font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .price{font-weight:700}
    .qty{display:flex;align-items:center;gap:8px}
    .qty input{width:54px;padding:6px;border-radius:6px;border:1px solid #ddd;text-align:center}
    .btn{display:inline-block;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:#fff;border:1px solid #ddd}
    .btn-danger{background:var(--danger);color:#fff}
    .empty{padding:40px;text-align:center;color:var(--muted)}
    .summary .row{display:flex;justify-content:space-between;padding:10px 0;border-top:1px dashed #eee}
    .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    @media(max-width:880px){ .grid{grid-template-columns:1fr} .summary{order:2} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Cart</h1>
      <div>
        <button class="btn btn-ghost" id="continueBtn">← Continue shopping</button>
        <button class="btn btn-ghost" id="clearBtn">Clear Cart</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h3 style="margin-top:0">Items in cart</h3>
        <div id="itemsContainer"></div>
        <div id="emptyMsg" class="empty" style="display:none">
          Your cart is empty. <br/><br/>
          <button class="btn btn-primary" id="shopNow">Start shopping</button>
        </div>
      </section>

      <aside class="card summary">
        <h3 style="margin-top:0">Order Summary</h3>
        <div style="padding-top:8px">
          <div class="row" style="display:flex;justify-content:space-between;margin-bottom:8px">
            <div class="muted">Items</div><div id="countItems">0</div>
          </div>
          <div class="row" style="display:flex;justify-content:space-between">
            <div class="muted">Subtotal</div><div id="subtotal">₹0.00</div>
          </div>
          <div class="row" style="display:flex;justify-content:space-between">
            <div class="muted">GST (5%)</div><div id="tax">₹0.00</div>
          </div>
          <div style="display:flex;justify-content:space-between;padding-top:12px;font-weight:700">
            <div>Total</div><div id="total">₹0.00</div>
          </div>

          <div class="actions">
            <button class="btn btn-primary" id="checkoutBtn">Proceed to Checkout</button>
            <button class="btn btn-ghost" id="continueShoppingBtn">Continue Shopping</button>
          </div>

          <p class="muted" style="margin-top:10px">You can update quantity or remove items. The cart is stored locally on your browser.</p>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // keys to check in localStorage (check common names)
    const KEYS = ['cart','nj_cart','nj_checkout'];

    // get cart data from first matching key
    function loadCart(){
      for(const k of KEYS){
        const raw = localStorage.getItem(k);
        if(raw){
          try{
            const obj = JSON.parse(raw);
            // if stored as {items: [...] } prefer that
            if(Array.isArray(obj)) return {key:k, items: obj};
            if(obj && Array.isArray(obj.items)) return {key:k, items: obj.items};
            // fallback if object is mapping of ids
            if(obj && typeof obj === 'object'){ // maybe {id: {...}}
              const arr = Object.values(obj);
              return {key:k, items:arr};
            }
          }catch(e){}
        }
      }
      return {key:null, items: []};
    }

    function saveCart(key, items){
      if(!key) key = 'nj_cart';
      // try to keep same structure as before if checkout used {items:[]}
      localStorage.setItem(key, JSON.stringify(items));
      // also mirror to nj_checkout for checkout flow convenience
      localStorage.setItem('nj_checkout', JSON.stringify({items}));
    }

    function formatCurrency(n){ return '₹' + Number(n || 0).toFixed(2); }

    const itemsContainer = document.getElementById('itemsContainer');
    const emptyMsg = document.getElementById('emptyMsg');
    const countItems = document.getElementById('countItems');
    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const totalEl = document.getElementById('total');

    // load & render
    let CART_KEY = null;
    let CART_ITEMS = [];

    function render(){
      const loaded = loadCart();
      CART_KEY = loaded.key || 'nj_cart';
      CART_ITEMS = loaded.items || [];
      itemsContainer.innerHTML = '';

      if(!CART_ITEMS.length){
        emptyMsg.style.display = 'block';
      } else {
        emptyMsg.style.display = 'none';
        CART_ITEMS.forEach((it, idx) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'item';
          itemDiv.innerHTML = `
            <img src="${escapeHtml(it.image || 'https://via.placeholder.com/200')}" alt="">
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="title">${escapeHtml(it.name || 'Product')}</div>
                  <div class="muted">${escapeHtml(it.category || '')}</div>
                </div>
                <div style="text-align:right">
                  <div class="price">${formatCurrency(it.price)}</div>
                  <div class="muted">Unit</div>
                </div>
              </div>

              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
                <div class="qty">
                  <button data-action="dec" data-index="${idx}" class="btn btn-ghost">−</button>
                  <input data-index="${idx}" type="number" min="1" value="${Number(it.qty||1)}" />
                  <button data-action="inc" data-index="${idx}" class="btn btn-ghost">+</button>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <button data-action="remove" data-index="${idx}" class="btn btn-danger">Remove</button>
                </div>
              </div>
            </div>
          `;
          itemsContainer.appendChild(itemDiv);
        });

        // attach events (delegation)
        itemsContainer.querySelectorAll('[data-action]').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const action = btn.getAttribute('data-action');
            const index = Number(btn.getAttribute('data-index'));
            if(action === 'inc') { updateQty(index, (CART_ITEMS[index].qty||1)+1); }
            if(action === 'dec') { updateQty(index, Math.max(1,(CART_ITEMS[index].qty||1)-1)); }
            if(action === 'remove') { removeItem(index); }
          });
        });
        itemsContainer.querySelectorAll('input[type="number"]').forEach(inp=>{
          inp.addEventListener('change', e=>{
            const index = Number(inp.getAttribute('data-index'));
            let v = Number(inp.value);
            if(!v || v < 1) v = 1;
            updateQty(index, v);
          });
        });
      }

      updateSummary();
    }

    function updateSummary(){
      const subtotal = CART_ITEMS.reduce((s,i) => s + (Number(i.price||0) * Number(i.qty||1)), 0);
      const tax = +(subtotal * 0.05).toFixed(2);
      const total = +(subtotal + tax).toFixed(2);
      countItems.innerText = CART_ITEMS.length;
      subtotalEl.innerText = formatCurrency(subtotal);
      taxEl.innerText = formatCurrency(tax);
      totalEl.innerText = formatCurrency(total);
    }

    function updateQty(index, qty){
      if(!CART_ITEMS[index]) return;
      CART_ITEMS[index].qty = qty;
      saveCart(CART_KEY, CART_ITEMS);
      render();
    }

    function removeItem(index){
      if(!CART_ITEMS[index]) return;
      CART_ITEMS.splice(index,1);
      saveCart(CART_KEY, CART_ITEMS);
      render();
    }

    // clear cart
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(!confirm('Clear cart?')) return;
      CART_ITEMS = [];
      saveCart(CART_KEY, CART_ITEMS);
      render();
    });

    // continue shopping -> index.html
    function continueShopping(){
      // if your products page is index.html change below accordingly
      window.location.href = 'index.html';
    }
    document.getElementById('continueBtn').addEventListener('click', continueShopping);
    document.getElementById('continueShoppingBtn').addEventListener('click', continueShopping);
    document.getElementById('shopNow').addEventListener('click', continueShopping);

    // proceed to checkout -> save a checkout snapshot and go to checkout.html
    document.getElementById('checkoutBtn').addEventListener('click', ()=>{
      if(!CART_ITEMS.length){
        alert('Your cart is empty.');
        return;
      }
      // Save snapshot in nj_checkout as {items: [...]} to match checkout.html expectation
      localStorage.setItem('nj_checkout', JSON.stringify({items: CART_ITEMS, createdAt: Date.now()}));
      // redirect to checkout page
      window.location.href = 'checkout.html';
    });

    // util escape
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

    // initial render
    render();
  </script>
</body>
</html>
