<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NJ Mart — Admin Dashboard</title>

  <!-- Fonts + icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Link the centralized stylesheet (you created) -->
  <link rel="stylesheet" href="style.css">

  <style>
    /* Small admin-specific overrides to complement style.css */
    .admin-wrap{display:flex;gap:18px;max-width:1300px;margin:18px auto;padding:12px}
    aside.sidebar{
      width:260px;
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow:0 10px 30px rgba(12,30,40,0.06);
      display:flex;flex-direction:column;gap:12px;flex-shrink:0;height:calc(100vh - 48px);position:sticky;top:12px;overflow:auto;
    }
    aside .brand{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    aside .brand .logo{width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;background:linear-gradient(135deg,#2db34a,#1f8a34);font-weight:800}
    aside .brand h1{font-size:18px;margin:0}
    .menu{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .menu-item{background:transparent;border:0;padding:10px 12px;text-align:left;border-radius:10px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:10px}
    .menu-item.active{background:#f3fff6;border:1px solid rgba(45,179,74,0.12)}
    .main-content{flex:1;display:flex;flex-direction:column;gap:12px}
    .admin-header{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
    .grid-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .big-number{font-size:22px;font-weight:800;margin-top:6px}
    .page{display:block}
    .hidden{display:none}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .form{display:flex;flex-direction:column;gap:8px;background:#fff;padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(12,30,40,0.04)}
    /* Modal styles */
    .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:120}
    .modal{background:#fff;border-radius:12px;padding:18px;max-width:900px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.18);max-height:88vh;overflow:auto}
    .modal h3{margin:0 0 8px 0}
    .table td .btn{margin-right:6px}
    @media(max-width:980px){
      .admin-wrap{flex-direction:column;padding:8px}
      aside.sidebar{width:100%;height:auto;position:relative;top:auto}
      .grid-cards{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="admin-wrap">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>
          <h1>NJ Mart</h1>
          <div style="font-size:12px;color:#6b7280">Admin</div>
        </div>
      </div>

      <nav class="menu" aria-label="Admin menu">
        <button class="menu-item active" data-page="dashboardPage"><i class="fa fa-chart-line"></i> Dashboard</button>
        <button class="menu-item" data-page="productsPage"><i class="fa fa-box"></i> Products</button>
        <button class="menu-item" data-page="ordersPage"><i class="fa fa-shopping-cart"></i> Orders</button>
        <button class="menu-item" data-page="customersPage"><i class="fa fa-users"></i> Customers</button>
        <button class="menu-item" data-page="staffPage"><i class="fa fa-user-tie"></i> Staff</button>
        <button class="menu-item" data-page="couponsPage"><i class="fa fa-ticket"></i> Coupons</button>
        <button class="menu-item" data-page="reportsPage"><i class="fa fa-file-alt"></i> Reports</button>
        <button class="menu-item" data-page="settingsPage"><i class="fa fa-cogs"></i> Settings</button>
        <div style="flex:1"></div>
        <button id="btnLogout" class="menu-item" style="color:#ef4444"><i class="fa fa-sign-out-alt"></i> Logout</button>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content" role="main">

      <!-- HEADER -->
      <header class="admin-header">
        <div>
          <h2 id="pageTitle" style="margin:0">Dashboard</h2>
          <div style="color:#6b7280;font-size:13px">Overview & quick actions</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="refreshBtn" class="btn ghost"><i class="fa fa-sync"></i> Refresh</button>
          <button id="openQuickAdd" class="btn primary"><i class="fa fa-plus"></i> Quick Add</button>
        </div>
      </header>

      <!-- PAGES: Dashboard -->
      <section class="page" id="dashboardPage">
        <div class="grid-cards">
          <div class="card">
            <h3 style="margin:0">Total Products</h3>
            <div id="dashProducts" class="big-number">0</div>
            <div class="text-muted" style="font-size:13px;margin-top:6px">Active items in catalog</div>
          </div>
          <div class="card">
            <h3 style="margin:0">Total Orders</h3>
            <div id="dashOrders" class="big-number">0</div>
            <div class="text-muted" style="font-size:13px;margin-top:6px">Orders placed</div>
          </div>
          <div class="card">
            <h3 style="margin:0">Total Customers</h3>
            <div id="dashCustomers" class="big-number">0</div>
            <div class="text-muted" style="font-size:13px;margin-top:6px">Registered customers</div>
          </div>
          <div class="card">
            <h3 style="margin:0">Revenue (₹)</h3>
            <div id="dashRevenue" class="big-number">₹0</div>
            <div class="text-muted" style="font-size:13px;margin-top:6px">Sum of completed orders</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Recent Orders</h3>
          <table class="table" id="recentOrders">
            <thead>
              <tr>
                <th style="width:140px">Order ID</th>
                <th>Customer</th>
                <th style="width:120px">Total</th>
                <th style="width:120px">Status</th>
                <th style="width:180px">Date</th>
                <th style="width:120px">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAGES: Products -->
      <section class="page hidden" id="productsPage">
        <div class="page-header">
          <div>
            <h3 style="margin:0">Products</h3>
            <div class="text-muted" style="font-size:13px">Add, update, or remove products</div>
          </div>
          <div style="display:flex;gap:8px">
            <input id="productSearch" type="search" placeholder="Search product by name or id" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
            <select id="productCategoryFilter" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
              <option value="">All categories</option>
            </select>
            <button id="btnAddProduct" class="btn primary"><i class="fa fa-plus"></i> Add product</button>
          </div>
        </div>

        <div class="card">
          <table class="table" id="productsTable">
            <thead>
              <tr>
                <th style="width:120px">ProductID</th>
                <th>Name</th>
                <th style="width:120px">Price (₹)</th>
                <th style="width:100px">Stock</th>
                <th style="width:140px">Category</th>
                <th style="width:160px">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted">Loading products…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAGES: Orders -->
      <section class="page hidden" id="ordersPage">
        <div class="page-header">
          <div>
            <h3 style="margin:0">Orders</h3>
            <div class="text-muted" style="font-size:13px">View and manage incoming orders</div>
          </div>
          <div style="display:flex;gap:8px">
            <select id="orderStatusFilter" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
              <option value="">All status</option>
              <option value="placed">Placed</option>
              <option value="processing">Processing</option>
              <option value="out for delivery">Out for delivery</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <input id="orderSearch" placeholder="Search order id / customer" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
          </div>
        </div>

        <div class="card">
          <table class="table" id="ordersTable">
            <thead>
              <tr>
                <th style="width:140px">OrderID</th>
                <th>Customer</th>
                <th>Items</th>
                <th style="width:120px">Total (₹)</th>
                <th style="width:140px">Payment</th>
                <th style="width:120px">Status</th>
                <th style="width:180px">Date</th>
                <th style="width:160px">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" class="text-muted">Loading orders…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAGES: Customers -->
      <section class="page hidden" id="customersPage">
        <div class="page-header">
          <div>
            <h3 style="margin:0">Customers</h3>
            <div class="text-muted" style="font-size:13px">View and export customer list</div>
          </div>
          <div style="display:flex;gap:8px">
            <input id="customerSearch" placeholder="Search by name or phone" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
            <button id="btnExportCustomers" class="btn ghost"><i class="fa fa-download"></i> Export CSV</button>
          </div>
        </div>

        <div class="card">
          <table class="table" id="customersTable">
            <thead>
              <tr>
                <th style="width:140px">CustomerID</th>
                <th>Name</th>
                <th style="width:140px">Phone</th>
                <th style="width:200px">Email</th>
                <th style="width:120px">Orders</th>
                <th style="width:120px">Total Spent</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted">Loading customers…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAGES: Staff -->
      <section class="page hidden" id="staffPage">
        <div class="page-header">
          <div>
            <h3 style="margin:0">Staff</h3>
            <div class="text-muted" style="font-size:13px">Manage delivery & store staff</div>
          </div>
          <div>
            <button id="btnOpenStaffModal" class="btn primary"><i class="fa fa-plus"></i> Add Staff</button>
          </div>
        </div>

        <div class="card">
          <table class="table" id="staffTable">
            <thead>
              <tr>
                <th style="width:120px">StaffID</th>
                <th>Name</th>
                <th style="width:140px">Role</th>
                <th style="width:160px">Phone</th>
                <th style="width:200px">Email</th>
                <th style="width:120px">Status</th>
                <th style="width:160px">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7" class="text-muted">Loading staff…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAGES: Coupons -->
      <section class="page hidden" id="couponsPage">
        <div class="page-header">
          <div>
            <h3 style="margin:0">Coupons</h3>
            <div class="text-muted" style="font-size:13px">Create and manage discount coupons</div>
          </div>
          <div>
            <button id="btnOpenCouponModal" class="btn primary"><i class="fa fa-plus"></i> Add Coupon</button>
          </div>
        </div>

        <div class="card">
          <table class="table" id="couponsTable">
            <thead>
              <tr>
                <th style="width:160px">Code</th>
                <th style="width:120px">Discount</th>
                <th style="width:120px">Type</th>
                <th style="width:160px">Expiry</th>
                <th style="width:100px">Status</th>
                <th style="width:160px">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted">Loading coupons…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAGES: Reports -->
      <section class="page hidden" id="reportsPage">
        <div class="page-header">
          <div>
            <h3 style="margin:0">Reports</h3>
            <div class="text-muted" style="font-size:13px">Sales and cashflow reports</div>
          </div>
          <div style="display:flex;gap:8px">
            <input type="date" id="reportFrom" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
            <input type="date" id="reportTo" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
            <button id="btnGenerateReport" class="btn primary">Generate</button>
          </div>
        </div>

        <div class="card">
          <table class="table" id="reportsTable">
            <thead>
              <tr><th style="width:160px">ReportID</th><th>Type</th><th style="width:160px">Value</th><th style="width:180px">Date</th></tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="text-muted">Loading reports…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAGES: Settings -->
      <section class="page hidden" id="settingsPage">
        <div class="page-header">
          <div>
            <h3 style="margin:0">Settings</h3>
            <div class="text-muted" style="font-size:13px">Store configuration and business details</div>
          </div>
        </div>

        <form id="settingsForm" class="form">
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <label>
              Store name
              <input name="StoreName" placeholder="NJ Mart"/>
            </label>
            <label>
              Business email
              <input type="email" name="BusinessEmail" placeholder="support@njmart.example"/>
            </label>
            <label>
              Support phone
              <input name="SupportPhone" placeholder="+91 90000 00000"/>
            </label>
            <label>
              Minimum order (₹)
              <input name="MinOrder" type="number" placeholder="199"/>
            </label>
            <label>
              Delivery charge (₹)
              <input name="DeliveryCharge" type="number" placeholder="25"/>
            </label>
            <label>
              Free delivery threshold (₹)
              <input name="FreeDelivery" type="number" placeholder="499"/>
            </label>
            <label>
              UPI ID
              <input name="UPIID" placeholder="njmart@ybl"/>
            </label>
            <label>
              COD available
              <select name="CODAvailable"><option value="yes">Yes</option><option value="no">No</option></select>
            </label>
          </div>

          <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
            <button type="button" id="btnResetSettings" class="btn ghost">Reset</button>
            <button type="submit" class="btn primary">Save settings</button>
          </div>
        </form>
      </section>

    </main>
  </div>

  <!-- MODALS (Add/Edit Product, Add Staff, Add Coupon, Order Detail) -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" id="modal">
      <!-- modal content injected by JS -->
    </div>
  </div>

  <!-- TOAST -->
  <div id="adminToast" style="position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 16px;border-radius:8px;display:none;z-index:140">Saved</div>

  <script>
  /*******************************************************************
   * NJ Mart — Admin (expanded)
   * Single-file admin UI that talks to Google Apps Script backend.
   *
   * IMPORTANT:
   * Replace API_BASE with your deployed Apps Script webapp URL if different.
   *******************************************************************/
  const API_BASE = "https://script.google.com/macros/s/AKfycbwsG5H7er3nqwGjEbrtokssc5LeGFc9Zog2bG1s0C5bQ-P2b_1S1kisSLpOmdESH7FB/exec";

  /* ------------------ small helpers ------------------ */
  const $ = (s,root=document) => root.querySelector(s);
  const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));
  function showToast(msg,ms=1800){
    const t = document.getElementById('adminToast');
    t.textContent = msg; t.style.display='block';
    setTimeout(()=>t.style.display='none', ms);
  }
  function apiGet(params={}) {
    const u = new URL(API_BASE);
    Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
    return fetch(u).then(r=>r.json()).catch(e=>({ok:false,error:String(e)}));
  }
  function apiPost(body={}){
    return fetch(API_BASE,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    }).then(r=>r.json()).catch(e=>({ok:false,error:String(e)}));
  }

  /* ------------------ navigation ------------------ */
  $$('.menu-item').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      $$('.menu-item').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const p = btn.dataset.page;
      if(p) showPage(p);
    });
  });
  function showPage(pageId){
    // hide all pages
    $$('.page').forEach(p=>p.classList.add('hidden'));
    // show requested
    document.getElementById(pageId).classList.remove('hidden');
    document.getElementById('pageTitle').textContent = document.getElementById(pageId).querySelector('h3,h2')?.textContent || 'Admin';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  /* ------------------ load dashboard data ------------------ */
  async function loadDashboard(){
    const [pRes,oRes,cRes,rRes] = await Promise.all([
      apiGet({action:'products'}),
      apiGet({action:'orders'}),
      apiGet({action:'customers'}),
      apiGet({action:'reports'})
    ]);
    if(pRes.ok) $('#dashProducts').textContent = (pRes.products||[]).length;
    if(oRes.ok){
      const orders = oRes.orders || [];
      $('#dashOrders').textContent = orders.length;
      const revenue = orders.reduce((s,x)=> s + (Number(x['Final Amount']||x['Total Amount']||0)), 0);
      $('#dashRevenue').textContent = '₹' + Number(revenue||0).toFixed(0);
      // recent orders
      const tbody = $('#recentOrders tbody'); tbody.innerHTML='';
      orders.slice(-8).reverse().forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${o.OrderID||''}</td><td>${o.CustomerID||''}</td><td>₹${Number(o['Final Amount']||0).toFixed(0)}</td><td>${o.Status||''}</td><td>${o['Order Date']||''}</td>
          <td><button class="btn ghost small" data-id="${o.OrderID}" data-act="
