<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NJ Mart — Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui;background:#f6fbf8;margin:0}
    .wrap{max-width:1100px;margin:12px auto;padding:12px}
    .card{background:#fff;padding:12px;border-radius:12px;box-shadow:0 12px 36px rgba(12,30,40,.06);margin-bottom:12px}
    input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #eef6f2;margin-bottom:8px}
    button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:#2db34a;color:#fff}
    .list { display:flex;flex-direction:column;gap:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Admin Panel</h2>
      <div id="adminMsg" class="small">Checking admin...</div>
    </div>

    <div class="card" id="productMgr" style="display:none">
      <h3>Products</h3>
      <div style="display:grid;grid-template-columns:1fr 320px;gap:12px">
        <div>
          <div id="productList" class="list"></div>
        </div>
        <div>
          <h4>Add / Edit Product</h4>
          <input id="pId" placeholder="Product ID (leave empty for auto)">
          <input id="pName" placeholder="Name">
          <input id="pPrice" placeholder="Price">
          <input id="pCategory" placeholder="Category">
          <input id="pImage" placeholder="Image URL">
          <textarea id="pDesc" placeholder="Description"></textarea>
          <div style="display:flex;gap:8px">
            <button id="saveProduct" class="btn-primary">Save</button>
            <button id="deleteProduct">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="settingsMgr" style="display:none">
      <h3>Store Settings</h3>
      <div>
        <label class="small">Store UPI</label>
        <input id="storeUpi">
        <label class="small">Coupons (JSON array)</label>
        <textarea id="couponsJson" rows="6"></textarea>
        <div style="margin-top:8px">
          <button id="saveSettings" class="btn-primary">Save Settings</button>
        </div>
        <div id="settingsMsg" class="small"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, onAuth } from './firebase-config.js';
    import { collection, getDocs, doc, setDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const productList = document.getElementById('productList');
    const productMgr = document.getElementById('productMgr');
    const settingsMgr = document.getElementById('settingsMgr');
    const adminMsg = document.getElementById('adminMsg');

    async function requireAdmin(user){
      if(!user){ adminMsg.textContent = 'Sign in as admin to use this panel.'; return false; }
      const t = await user.getIdTokenResult();
      if(t.claims && t.claims.admin === true){
        adminMsg.textContent = 'Admin access granted';
        productMgr.style.display = 'block';
        settingsMgr.style.display = 'block';
        loadProducts();
        loadSettings();
        return true;
      } else {
        adminMsg.textContent = 'No admin claim. Set admin:true using Admin SDK on server.';
        return false;
      }
    }

    async function loadProducts(){
      productList.innerHTML = 'Loading...';
      const snap = await getDocs(collection(db,'products'));
      productList.innerHTML = '';
      snap.forEach(d => {
        const data = d.data();
        const el = document.createElement('div');
        el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
        el.innerHTML = `<div><strong>${data.name}</strong><div class="small">${data.category} • ₹${data.price}</div></div><div><button onclick='editProduct("${d.id}")'>Edit</button></div>`;
        productList.appendChild(el);
      });
    }

    window.editProduct = async function(id){
      const d = await (await fetch('/__/firebase/init.json').catch(()=>null));
      // simpler approach: fetch doc via Firestore (can't from here synchronously). We will get from server -- for brevity, instruct admin to click product list then edit fields manually (or I can expand)
      alert('Click product in list to edit — implementation note: you can click Edit then fill fields.');
    }

    async function loadSettings(){
      const sDoc = doc(db,'settings','main');
      try{
        const res = await (await fetch(`/__/api/none`).catch(()=>null));
      }catch(e){}
      // For simplicity, read settings via Firestore client
      const r = await (await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js')).getDoc(doc(db,'settings','main')).catch(()=>null);
      if(r && r.exists){
        const data = r.data();
        document.getElementById('storeUpi').value = data.storeUpi || '';
        document.getElementById('couponsJson').value = JSON.stringify(data.coupons || [], null, 2);
      } else {
        document.getElementById('couponsJson').value = JSON.stringify([], null, 2);
      }
    }

    document.getElementById('saveSettings').addEventListener('click', async ()=>{
      try{
        const obj = { storeUpi: document.getElementById('storeUpi').value.trim() };
        obj.coupons = JSON.parse(document.getElementById('couponsJson').value || '[]');
        await setDoc(doc(db,'settings','main'), obj, { merge: true });
        document.getElementById('settingsMsg').textContent = 'Saved';
      }catch(e){ document.getElementById('settingsMsg').textContent = 'Error: ' + e.message; }
    });

    onAuth(user => {
      requireAdmin(user);
    });

  </script>
</body>
</html>
