<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NJ Mart — Checkout</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --green:#2db34a; --muted:#6f757b; --bg:#f6fbf8; --card:#fff; --danger:#e04d4d; --radius:12px;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
  body{margin:0;background:var(--bg);color:#0b1220}
  .wrap{max-width:1100px;margin:14px auto;padding:12px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .back{background:#fff;border:0;padding:8px;border-radius:10px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  h1{margin:0;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:14px}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 24px rgba(12,30,40,.04);margin-bottom:12px}
  .small{color:var(--muted);font-size:13px}
  .addressBox{background:#fbfff7;padding:12px;border-radius:10px}
  .addrName{font-weight:700}
  .items{margin-top:10px}
  .item{display:flex;justify-content:space-between;gap:12px;padding:12px 0;border-bottom:1px solid #f1f3f4}
  .left{display:flex;gap:12px;align-items:center}
  .thumb{width:72px;height:72px;border-radius:10px;background:#f7faf7;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .iname{font-weight:700}
  .meta{color:var(--muted);font-size:13px}
  .qty{display:flex;align-items:center;gap:8px}
  .qty button{padding:6px 8px;border-radius:8px;border:1px solid #e6ece6;background:#fff;cursor:pointer}
  .price{font-weight:700}
  .remove{background:transparent;border:0;color:var(--danger);cursor:pointer}
  .summary .row{display:flex;justify-content:space-between;padding:8px 0}
  .summary .total{font-size:18px;font-weight:800}
  .couponRow{display:flex;gap:8px;margin-top:8px}
  .couponRow input{flex:1;padding:10px;border-radius:8px;border:1px solid #e7efea}
  select,input,textarea{font-family:Inter,system-ui,Segoe UI,Roboto}
  textarea{min-height:80px;padding:10px;border-radius:8px;border:1px solid #e9f0eb}
  .btn{padding:12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--green);color:#fff}
  .btn.ghost{background:#fff;border:1px solid #e6ece6}
  .btn.warn{background:var(--danger);color:#fff}
  .note{font-size:13px;color:var(--muted);margin-top:8px}
  .actions{display:flex;gap:8px;margin-top:10px}
  .link{color:var(--green);cursor:pointer;text-decoration:underline}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <button class="back" onclick="location.href='cart.html'">← Cart</button>
      <div>
        <h1>Checkout</h1>
        <div class="small">Review your order, choose address & payment</div>
      </div>
    </header>

    <div class="grid">
      <!-- left: address + items + instructions -->
      <div>
        <div class="card">
          <h2 style="margin:0 0 8px 0">Delivery address</h2>
          <div id="addressContent" class="addressBox">
            <div class="small">Loading address...</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="editProfile" class="btn ghost">Edit profile</button>
            <button id="altAddress" class="btn ghost">Use different address</button>
            <button id="useLocation" class="btn ghost">Use current location</button>
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px 0">Items</h2>
          <div id="itemsList" class="items"></div>
          <div class="note">You can change quantity or remove items before placing order.</div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px 0">Delivery instructions</h2>
          <textarea id="instructions" placeholder="Example: Leave at door / Call on arrival (optional)"></textarea>
        </div>
      </div>

      <!-- right: summary & payment -->
      <aside>
        <div class="card summary">
          <h2 style="margin:0 0 8px 0">Order summary</h2>
          <div class="row"><div class="small">Items total</div><div id="subTotal">₹0</div></div>
          <div class="row"><div class="small">Delivery charge</div><div id="deliveryCharge">₹0</div></div>
          <div class="row"><div class="small">Discount</div><div id="discount">₹0</div></div>
          <hr style="border:none;border-top:1px dashed #eee;margin:8px 0">
          <div class="row total"><div>Grand total</div><div id="grandTotal">₹0</div></div>

          <div style="margin-top:10px">
            <div class="small">Apply coupon</div>
            <div class="couponRow">
              <input id="couponCode" placeholder="Enter coupon code e.g., SAVE50">
              <button id="applyCouponBtn" class="btn ghost">Apply</button>
            </div>
          </div>

          <div style="margin-top:10px">
            <div class="small">Payment method</div>
            <select id="paymentMethod" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e9f0eb;margin-top:8px">
              <option value="upi">UPI</option>
              <option value="cod">Cash on delivery</option>
              <option value="card">Card (placeholder)</option>
            </select>

            <div id="upiBox" style="display:none;margin-top:10px">
              <input id="upiId" type="text" placeholder="Store/your UPI id (example: yourupi@bank)" />
              <div class="small" style="margin-top:6px">You can update default UPI in admin settings later.</div>
            </div>
          </div>

          <div class="actions" style="margin-top:12px">
            <button id="placeOrderBtn" class="btn primary" style="flex:1">Place order</button>
            <button id="downloadInvoice" class="btn ghost" style="flex:1">Download invoice</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="emailInvoice" class="btn ghost" style="flex:1">Email invoice</button>
            <button id="copyDelivery" class="btn ghost" style="flex:1">Copy delivery link</button>
          </div>

          <div id="afterMsg" style="display:none;margin-top:10px" class="small">Order placed — redirecting to Orders...</div>
          <div class="note" style="margin-top:8px">Delivery ₹25 if order &lt; ₹1000. Free for ₹1000 and above.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0 0 6px 0">Store</h3>
          <div class="small">NJ Mart • +91 7062918607</div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* Full checkout page (copy-paste ready)
   Keys used:
    - nj_cart (array of items)
    - nj_profile (object)
    - nj_orders (array)
    - nj_latest_order (object)
    - nj_coupon (object)
    - nj_settings (object)
*/

const CART_KEY = 'nj_cart';
const PROFILE_KEY = 'nj_profile';
const ORDERS_KEY = 'nj_orders';
const LATEST_KEY = 'nj_latest_order';
const COUPON_KEY = 'nj_coupon';
const SETTINGS_KEY = 'nj_settings';

const DELIVERY_THRESHOLD = 1000;
const DELIVERY_CHARGE = 25;

// helpers
function load(key){ try{ return JSON.parse(localStorage.getItem(key)); }catch(e){ return null; } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function safeGet(key, fallback){ const v = load(key); return v == null ? fallback : v; }
function el(id){ return document.getElementById(id); }
function esc(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// UI refs
const addressContent = el('addressContent');
const itemsList = el('itemsList');
const subTotalEl = el('subTotal');
const deliveryEl = el('deliveryCharge');
const discountEl = el('discount');
const grandEl = el('grandTotal');
const couponInput = el('couponCode');
const applyCouponBtn = el('applyCouponBtn');
const paymentMethod = el('paymentMethod');
const upiBox = el('upiBox');
const upiId = el('upiId');
const placeOrderBtn = el('placeOrderBtn');
const downloadInvoiceBtn = el('downloadInvoice');
const emailInvoiceBtn = el('emailInvoice');
const copyDeliveryBtn = el('copyDelivery');
const afterMsg = el('afterMsg');

let cart = safeGet(CART_KEY, []);
let appliedCoupon = load(COUPON_KEY) || null;

// init
function init(){
  cart = safeGet(CART_KEY, []);
  if(!Array.isArray(cart)) cart = [];
  renderAddress();
  renderItems();
  updateSummary();
  // populate coupon box if existing
  if(appliedCoupon && appliedCoupon.code) couponInput.value = appliedCoupon.code;
  // show upi if settings exist
  const settings = load(SETTINGS_KEY) || {};
  if(settings.storeUpi) upiId.value = settings.storeUpi;
}
function renderAddress(){
  const p = load(PROFILE_KEY);
  if(!p || (!p.name && !p.address)){
    addressContent.innerHTML = `<div class="small">No profile address saved. <a class="link" id="goProfile">Save profile</a> to autofill delivery address.</div>`;
    const go = document.getElementById('goProfile');
    if(go) go.addEventListener('click', ()=> location.href = 'profile.html?next=checkout');
    return;
  }
  addressContent.innerHTML = `<div class="addrName">${esc(p.name)}</div>
    <div class="small">Phone: ${esc(p.phone || '')}</div>
    <div style="margin-top:8px">${esc(p.address || '').replace(/\n/g,'<br>')}</div>`;
}
function renderItems(){
  itemsList.innerHTML = '';
  if(!cart.length){ itemsList.innerHTML = '<div class="small">Your cart is empty</div>'; return; }
  cart.forEach((it, idx)=>{
    const wrapper = document.createElement('div');
    wrapper.className = 'item';
    wrapper.innerHTML = `
      <div class="left">
        <div class="thumb"><img src="${esc(it.image || 'https://via.placeholder.com/150')}" alt=""></div>
        <div>
          <div class="iname">${esc(it.name)}</div>
          <div class="meta">${esc(it.category || '')}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="qty">
          <button class="dec" data-idx="${idx}">−</button>
          <div class="small" style="display:inline-block;padding:6px 8px;border-radius:6px;background:#f6f8fa">${it.qty||1}</div>
          <button class="inc" data-idx="${idx}">+</button>
        </div>
        <div class="price">₹${(it.price*(it.qty||1)).toFixed(0)}</div>
        <div><button class="remove" data-idx="${idx}" style="background:transparent;border:0;color:var(--danger);cursor:pointer">Remove</button></div>
      </div>
    `;
    itemsList.appendChild(wrapper);
  });
  // attach events
  itemsList.querySelectorAll('.inc').forEach(btn => btn.addEventListener('click', onInc));
  itemsList.querySelectorAll('.dec').forEach(btn => btn.addEventListener('click', onDec));
  itemsList.querySelectorAll('.remove').forEach(btn => btn.addEventListener('click', onRemove));
}
function onInc(e){ const i = Number(e.currentTarget.dataset.idx); cart[i].qty = (cart[i].qty||1)+1; save(CART_KEY, cart); renderItems(); updateSummary(); }
function onDec(e){ const i = Number(e.currentTarget.dataset.idx); if((cart[i].qty||1) > 1){ cart[i].qty -= 1; save(CART_KEY, cart); renderItems(); updateSummary(); } else { if(confirm('Remove this item?')){ cart.splice(i,1); save(CART_KEY, cart); renderItems(); updateSummary(); } } }
function onRemove(e){ const i = Number(e.currentTarget.dataset.idx); if(confirm('Remove this item?')){ cart.splice(i,1); save(CART_KEY, cart); renderItems(); updateSummary(); } }

function calcTotals(){
  const subtotal = cart.reduce((s,i)=> s + (i.price * (i.qty||1)), 0);
  const delivery = subtotal >= DELIVERY_THRESHOLD || subtotal === 0 ? 0 : DELIVERY_CHARGE;
  const discount = appliedCoupon && appliedCoupon.discount ? appliedCoupon.discount : 0;
  const grand = Math.max(0, subtotal + delivery - discount);
  return { subtotal, delivery, discount, grand };
}
function updateSummary(){
  const t = calcTotals();
  subTotalEl.textContent = '₹' + t.subtotal.toFixed(0);
  deliveryEl.textContent = '₹' + t.delivery.toFixed(0);
  discountEl.textContent = '₹' + t.discount.toFixed(0);
  grandEl.textContent = '₹' + t.grand.toFixed(0);
}

// coupon apply
applyCouponBtn.addEventListener('click', ()=>{
  const code = (couponInput.value || '').trim().toUpperCase();
  if(!code){ alert('Enter coupon code'); return; }
  // demo coupons
  if(code === 'SAVE50'){ appliedCoupon = { code:'SAVE50', discount:50 }; save(COUPON_KEY, appliedCoupon); alert('Applied: ₹50 off'); }
  else if(code === 'FREEDEL'){ appliedCoupon = { code:'FREEDEL', discount: DELIVERY_CHARGE }; save(COUPON_KEY, appliedCoupon); alert('Applied: Free delivery'); }
  else { alert('Invalid coupon'); return; }
  updateSummary();
});

// payment method show/hide UPI
paymentMethod.addEventListener('change', ()=>{
  if(paymentMethod.value === 'upi') upiBox.style.display = 'block'; else upiBox.style.display = 'none';
});

// edit profile / alt address / location
el('editProfile').addEventListener('click', ()=> location.href = 'profile.html?next=checkout');
el('altAddress').addEventListener('click', ()=>{
  const alt = prompt('Enter alternate delivery address (temporary for this order):');
  if(!alt) return;
  addressContent.innerHTML = `<div class="addrName">Alternate address</div><div style="margin-top:6px">${esc(alt).replace(/\n/g,'<br>')}</div>`;
});
el('useLocation').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  el('useLocation').disabled = true; el('useLocation').textContent = 'Locating…';
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude.toFixed(6); const lng = pos.coords.longitude.toFixed(6);
    addressContent.innerHTML = `<div class="addrName">Current location</div><div class="small">Lat: ${lat}, Lng: ${lng}</div>`;
    el('useLocation').disabled = false; el('useLocation').textContent = 'Use current location';
  }, err=>{
    el('useLocation').disabled = false; el('useLocation').textContent = 'Use current location';
    alert('Failed to get location: ' + (err.message || err));
  }, { enableHighAccuracy:true, timeout:10000 });
});

// place order
placeOrderBtn.addEventListener('click', ()=>{
  if(!cart.length){ alert('Your cart is empty'); return; }
  // read profile
  const profile = load(PROFILE_KEY) || null;
  if(!profile || (!profile.name && !profile.address)){
    if(!confirm('No profile saved. Continue with checkout?')) return;
  }
  const totals = calcTotals();
  const payment = paymentMethod.value;
  const upi = upiId.value.trim() || null;
  const order = {
    id: 'ORD' + Date.now().toString(36).toUpperCase(),
    createdAt: Date.now(),
    items: cart,
    profile: profile,
    subtotal: totals.subtotal,
    delivery: totals.delivery,
    discount: totals.discount,
    total: totals.grand,
    payment: { method: payment, upi: upi },
    instructions: el('instructions').value || '',
    status: 'placed'
  };
  // save
  const orders = load(ORDERS_KEY) || [];
  orders.unshift(order);
  save(ORDERS_KEY, orders);
  save(LATEST_KEY, order);
  // clear cart & coupon
  localStorage.removeItem(CART_KEY);
  localStorage.removeItem(COUPON_KEY);
  // feedback
  afterMsg.style.display = 'block';
  placeOrderBtn.disabled = true;
  // redirect to orders
  setTimeout(()=> location.href = 'orders.html', 900);
});

// invoice download
downloadInvoiceBtn.addEventListener('click', ()=>{
  const order = load(LATEST_KEY) || buildPreviewOrder();
  if(!order){ alert('No recent order. Place order first.'); return; }
  const txt = invoiceText(order);
  const blob = new Blob([txt], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${order.id}_invoice.txt`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// email invoice
emailInvoiceBtn.addEventListener('click', ()=>{
  const order = load(LATEST_KEY) || buildPreviewOrder();
  if(!order){ alert('No recent order. Place order first.'); return; }
  const profile = load(PROFILE_KEY) || {};
  let to = profile.email || '';
  if(!to) to = prompt('Enter email to send invoice (this opens mail client):');
  if(!to) return;
  const subject = encodeURIComponent(`Invoice ${order.id} — NJ Mart`);
  const body = encodeURIComponent(invoiceText(order));
  window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subject}&body=${body}`;
});

// copy delivery link
copyDeliveryBtn.addEventListener('click', ()=>{
  const last = load(LATEST_KEY);
  if(!last){ alert('No recent order to make delivery link. Place order first.'); return; }
  const base = location.origin + location.pathname.replace(/\/[^\/]*$/, '/');
  const url = base + 'delivery.html?order=' + encodeURIComponent(last.id);
  // fallback if clipboard not available
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(url).then(()=> alert('Delivery link copied to clipboard'), ()=> prompt('Copy this delivery link', url));
  } else { prompt('Copy this delivery link', url); }
});

// helpers: build invoice text
function invoiceText(order){
  let out = `NJ Mart — Invoice\nOrder ID: ${order.id}\nDate: ${new Date(order.createdAt).toLocaleString()}\n\n`;
  if(order.profile){
    out += `Customer: ${order.profile.name || '-'}\nPhone: ${order.profile.phone || '-'}\nAddress: ${(order.profile.address||'').replace(/\n/g,' ')}\n\n`;
  }
  out += `Items:\n`;
  order.items.forEach(it=>{
    out += ` - ${it.name} x${it.qty||1} = ₹${(it.price*(it.qty||1)).toFixed(0)}\n`;
  });
  out += `\nSubtotal: ₹${order.subtotal}\nDelivery: ₹${order.delivery}\nDiscount: ₹${order.discount}\nGrand total: ₹${order.total}\n\nPayment: ${order.payment.method}${order.payment.upi ? ' (UPI: '+order.payment.upi+')' : ''}\nInstructions: ${order.instructions || '-'}\n\nThank you for shopping with NJ Mart!\n`;
  return out;
}
function buildPreviewOrder(){
  return {
    id: 'PREVIEW',
    createdAt: Date.now(),
    items: cart,
    profile: load(PROFILE_KEY) || null,
    subtotal: calcTotals().subtotal,
    delivery: calcTotals().delivery,
    discount: calcTotals().discount,
    total: calcTotals().grand,
    payment: { method: paymentMethod.value || 'NA' },
    instructions: el('instructions').value || '',
    status: 'preview'
  };
}

// initialize UI
init();
</script>
</body>
</html>
