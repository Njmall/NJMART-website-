<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NJ Mart — Checkout (Full)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
/* ========= Styles (mobile-first, responsive) ========= */
:root{
  --accent:#2db34a;
  --accent-dark:#239032;
  --muted:#6f767d;
  --danger:#e04d4d;
  --bg:#f6fbf8;
  --card:#ffffff;
  --radius:12px;
  --shadow: 0 10px 30px rgba(12,30,40,.06);
  --delivery-threshold:1000; /* displayed text only; logic in JS uses numeric constant */
  --delivery-charge:20; /* ₹20 if subtotal < 1000 */
}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif}
html,body{height:100%;margin:0;background:var(--bg);color:#0b1220}
.container{max-width:980px;margin:12px auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.back-btn{background:#fff;border:0;padding:8px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
.title{font-size:20px;font-weight:700;margin:0}
.grid{display:grid;grid-template-columns:1fr 380px;gap:12px}
@media(max-width:960px){ .grid{grid-template-columns:1fr} }

/* Cards */
.card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
.section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.small{font-size:13px;color:var(--muted)}
.note{font-size:13px;color:#4f5b5e;margin-top:8px}

/* cart list */
.cart-list{display:flex;flex-direction:column;gap:8px}
.cart-item{display:flex;gap:12px;padding:10px;border-radius:10px;border:1px solid #f1f3f3}
.thumb{width:84px;height:84px;border-radius:10px;overflow:hidden;flex:0 0 84px;background:#f4f7f6;display:flex;align-items:center;justify-content:center}
.thumb img{width:100%;height:100%;object-fit:cover}
.item-info{flex:1;display:flex;flex-direction:column;justify-content:space-between}
.item-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.item-name{font-weight:700;margin:0}
.item-meta{color:var(--muted);font-size:13px}
.qty-row{display:flex;align-items:center;gap:8px;margin-top:8px}
.qty-btn{padding:6px 10px;border-radius:8px;background:#fff;border:1px solid #e9f1ef;cursor:pointer}
.qty-count{padding:6px 10px;border-radius:8px;background:#f6faf8;border:1px solid #eef6ee}

/* summary */
.summary{min-width:280px}
.rowline{display:flex;justify-content:space-between;padding:8px 0;color:#333}
.total{font-size:20px;font-weight:800}
.coupon-row{display:flex;gap:8px;margin-top:10px}
.coupon-row input{flex:1;padding:10px;border-radius:8px;border:1px solid #e9f1ef}

/* payment */
.select{width:100%;padding:10px;border-radius:8px;border:1px solid #e9f1ef}

/* buttons */
.btn{display:inline-block;padding:11px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn.primary{background:var(--accent);color:#fff}
.btn.ghost{background:#fff;border:1px solid #e6ece6}
.btn.warn{background:var(--danger);color:#fff}

/* footer note */
.footer-note{font-size:13px;color:var(--muted);margin-top:10px;text-align:center}

/* responsive */
@media(max-width:420px){
  .thumb{width:72px;height:72px}
  .grid{gap:10px}
  .summary{min-width:auto}
}
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <button class="back-btn" onclick="location.href='cart.html'">←</button>
      <div>
        <h1 class="title">Checkout</h1>
        <div class="small">Confirm your order & delivery details</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Address + Cart -->
      <main>
        <!-- Profile / Address card -->
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800" id="profileName">Guest</div>
              <div class="small" id="profilePhone">—</div>
              <div id="profileAddress" class="small" style="margin-top:8px">No saved address. Save in Profile.</div>
            </div>
            <div style="text-align:right">
              <button id="editProfileBtn" class="btn ghost">Edit</button>
              <button id="altAddressBtn" class="btn ghost" style="margin-left:6px">Alt address</button>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="useLocationBtn" class="btn ghost">Use current location</button>
            <div style="flex:1" class="small" id="locMsg"></div>
          </div>
        </section>

        <!-- Cart Items -->
        <section class="card" style="margin-top:12px">
          <div class="section-title">
            <div style="font-weight:800">Your items</div>
            <div class="small" id="itemsCount">0 items</div>
          </div>
          <div id="cartList" class="cart-list">
            <!-- Items inserted here -->
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button id="clearCartBtn" class="btn ghost">Clear cart</button>
            <button id="continueShopping" class="btn ghost">Continue shopping</button>
          </div>
        </section>

        <!-- Delivery instructions -->
        <section class="card" style="margin-top:12px">
          <div style="font-weight:800">Delivery instructions</div>
          <div class="small" style="margin-top:6px">Example: Leave at door, call on arrival, etc.</div>
          <textarea id="deliveryInstructions" placeholder="Optional: delivery instructions" style="width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #eef6ef;min-height:72px"></textarea>
        </section>
      </main>

      <!-- RIGHT: Summary & Payment -->
      <aside class="summary">
        <div class="card">
          <div style="font-weight:800;margin-bottom:8px">Price Details</div>
          <div class="rowline"><div>Items total</div><div id="priceSubtotal">₹0</div></div>
          <div class="rowline"><div>Delivery charge</div><div id="priceDelivery">₹0</div></div>
          <div class="rowline"><div>Discount</div><div id="priceDiscount">₹0</div></div>
          <hr style="border:none;border-top:1px dashed #eee;margin:12px 0">
          <div class="rowline total"><div>Grand total</div><div id="priceGrand">₹0</div></div>

          <div class="note" style="margin-top:8px">Free delivery on orders ≥ ₹1000. Delivery ₹20 for orders below ₹1000.</div>

          <div style="margin-top:12px">
            <div class="small">Have a coupon?</div>
            <div class="coupon-row">
              <input id="couponInput" placeholder="Enter coupon code" />
              <button id="applyCouponBtn" class="btn ghost">Apply</button>
            </div>
            <div id="couponMsg" class="small" style="margin-top:6px"></div>
          </div>

          <div style="margin-top:12px">
            <div class="small">Payment method</div>
            <select id="paymentMethod" class="select" style="margin-top:8px">
              <option value="upi">UPI</option>
              <option value="cod">Cash on delivery</option>
              <option value="card">Card (placeholder)</option>
            </select>
            <div id="upiBox" style="display:none;margin-top:8px">
              <input id="upiId" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef6ef" placeholder="Enter UPI ID (optional)">
            </div>
          </div>

          <div style="margin-top:12px">
            <button id="placeOrderBtn" class="btn primary" style="width:100%">Place Order</button>
            <button id="downloadInvoiceBtn" class="btn ghost" style="width:100%;margin-top:8px">Download Invoice</button>
            <button id="emailInvoiceBtn" class="btn ghost" style="width:100%;margin-top:8px">Email Invoice</button>
            <button id="copyDeliveryBtn" class="btn ghost" style="width:100%;margin-top:8px">Copy delivery link</button>
            <div id="afterPlaceMsg" class="small" style="display:none;margin-top:8px;color:var(--accent-dark)">Order placed — redirecting to Orders...</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:800">Store details</div>
          <div class="small" style="margin-top:6px">NJ Mart • +91 70629 18607</div>
          <div class="small" style="margin-top:6px">UPI & store details editable in admin (demo: localStorage `nj_settings`)</div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ========= FULL Checkout (expanded) =========
   Keys used (localStorage):
   - nj_cart            : array of cart items {id,name,price,qty,img,category}
   - nj_user            : saved profile {name,phone,address,email}
   - nj_checkout        : optional checkout snapshot
   - nj_orders          : saved orders array
   - nj_latest_order    : last order saved
   - nj_settings        : app settings (e.g., coupons, storeUpi)
   - nj_coupon          : currently applied coupon (object)
*/

/* ------------------ Configuration ------------------ */
const DELIVERY_THRESHOLD = 1000; // free delivery for >= this
const DELIVERY_CHARGE = 20;     // ₹20 if < threshold

/* ------------------ Helpers ------------------ */
function load(key){ try{ return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function remove(key){ localStorage.removeItem(key); }

function formatINR(n){ return '₹' + Number(n || 0).toFixed(0); }
function guid(prefix='ORD'){ return prefix + Date.now().toString(36).toUpperCase(); }

/* ------------------ Initial Data ------------------ */
/* If admin wants default coupons, they can be kept in nj_settings:
   Example:
   localStorage.setItem('nj_settings', JSON.stringify({
     coupons: [ {code:'SAVE50', type:'FLAT', value:50}, {code:'FREEDEL', type:'DELIVERY', value:DELIVERY_CHARGE} ],
     storeUpi: 'yourupi@bank'
   }))
*/
let settings = load('nj_settings') || { coupons: [ {code:'SAVE50', type:'FLAT', value:50}, {code:'FREEDEL', type:'DELIVERY', value: DELIVERY_CHARGE} ], storeUpi: '' };

/* If nj_cart is missing we won't create demo items here (we assume user added from index). */
/* But for convenience during first-time demo you may seed demo items in index page. */

/* ------------------ UI elements ------------------ */
const el = id => document.getElementById(id);
const cartListEl = el('cartList');
const itemsCountEl = el('itemsCount');
const priceSubtotalEl = el('priceSubtotal');
const priceDeliveryEl = el('priceDelivery');
const priceDiscountEl = el('priceDiscount');
const priceGrandEl = el('priceGrand');
const couponInputEl = el('couponInput');
const couponMsgEl = el('couponMsg');
const applyCouponBtn = el('applyCouponBtn');
const paymentMethodEl = el('paymentMethod');
const upiBoxEl = el('upiBox');
const upiIdEl = el('upiId');
const placeOrderBtn = el('placeOrderBtn');
const downloadInvoiceBtn = el('downloadInvoiceBtn');
const emailInvoiceBtn = el('emailInvoiceBtn');
const copyDeliveryBtn = el('copyDeliveryBtn');
const afterPlaceMsg = el('afterPlaceMsg');

const editProfileBtn = el('editProfileBtn');
const altAddressBtn = el('altAddressBtn');
const useLocationBtn = el('useLocationBtn');
const locMsgEl = el('locMsg');

const clearCartBtn = el('clearCartBtn');
const continueShoppingBtn = el('continueShopping');

/* ------------------ Cart / Profile state ------------------ */
let cart = load('nj_cart') || [];
let profile = load('nj_user') || null;
let appliedCoupon = load('nj_coupon') || null;
settings = load('nj_settings') || settings;

/* ------------------ Render functions ------------------ */

function renderProfile(){
  profile = load('nj_user') || null;
  if(profile && profile.name){
    el('profileName').textContent = profile.name;
    el('profilePhone').textContent = profile.phone || '';
    el('profileAddress').textContent = profile.address || '—';
  } else {
    el('profileName').textContent = 'Guest';
    el('profilePhone').textContent = '—';
    el('profileAddress').textContent = 'No saved address. Save in Profile.';
  }
}

function renderCart(){
  cart = load('nj_cart') || [];
  cartListEl.innerHTML = '';
  if(!cart || cart.length === 0){
    cartListEl.innerHTML = '<div style="text-align:center;color:var(--muted);padding:22px">Your cart is empty. <button class="btn primary" onclick="location.href=\\'index.html\\'">Shop now</button></div>';
    itemsCountEl.textContent = '0 items';
    updateSummary();
    return;
  }
  let count = 0;
  cart.forEach((it, idx) => {
    count += it.qty || 0;
    const node = document.createElement('div');
    node.className = 'cart-item';
    node.innerHTML = `
      <div class="thumb"><img src="${escapeHtml(it.img || 'https://via.placeholder.com/200')}" alt=""></div>
      <div class="item-info">
        <div class="item-top">
          <div>
            <div class="item-name">${escapeHtml(it.name)}</div>
            <div class="item-meta">Seller: NJ Mart • ${escapeHtml(it.category || 'Grocery')}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800">${formatINR(it.price * (it.qty||1))}</div>
            <div style="margin-top:6px"><button class="btn ghost remove-btn" data-idx="${idx}">Remove</button></div>
          </div>
        </div>

        <div class="qty-row">
          <button class="qty-btn dec" data-idx="${idx}">−</button>
          <div class="qty-count" id="qty-${escapeHtml(it.id)}">${it.qty||1}</div>
          <button class="qty-btn inc" data-idx="${idx}">+</button>
          <div style="margin-left:auto" class="small">₹${it.price}</div>
        </div>
      </div>
    `;
    cartListEl.appendChild(node);
  });

  itemsCountEl.textContent = count + (count === 1 ? ' item' : ' items');

  // attach events
  Array.from(document.querySelectorAll('.inc')).forEach(b => b.addEventListener('click', onInc));
  Array.from(document.querySelectorAll('.dec')).forEach(b => b.addEventListener('click', onDec));
  Array.from(document.querySelectorAll('.remove-btn')).forEach(b => b.addEventListener('click', onRemove));

  updateSummary();
}

/* Quantity handlers */
function onInc(e){
  const idx = Number(e.currentTarget.dataset.idx);
  if(!isFinite(idx)) return;
  cart[idx].qty = (cart[idx].qty || 1) + 1;
  save('nj_cart', cart);
  renderCart();
}
function onDec(e){
  const idx = Number(e.currentTarget.dataset.idx);
  if(!isFinite(idx)) return;
  if((cart[idx].qty || 1) > 1){
    cart[idx].qty--;
    save('nj_cart', cart);
    renderCart();
  } else {
    if(confirm('Remove this item from cart?')){
      cart.splice(idx,1);
      save('nj_cart', cart);
      renderCart();
    }
  }
}
function onRemove(e){
  const idx = Number(e.currentTarget.dataset.idx);
  if(!isFinite(idx)) return;
  if(confirm('Remove this item?')){
    cart.splice(idx,1);
    save('nj_cart', cart);
    renderCart();
  }
}

/* ------------------ Summary & Coupons ------------------ */
function getTotals(){
  const subtotal = (cart || []).reduce((s,i) => s + (i.price * (i.qty || 1)), 0);
  const delivery = (subtotal >= DELIVERY_THRESHOLD || subtotal === 0) ? 0 : DELIVERY_CHARGE;
  let discount = 0;
  if(appliedCoupon && appliedCoupon.type){
    if(appliedCoupon.type === 'FLAT') discount = appliedCoupon.value || 0;
    else if(appliedCoupon.type === 'PERCENT') discount = Math.round(subtotal * ((appliedCoupon.value || 0) / 100));
    else if(appliedCoupon.type === 'DELIVERY') discount = appliedCoupon.value || 0;
  }
  // ensure discount not exceed subtotal + delivery
  const grand = Math.max(0, subtotal + delivery - discount);
  return { subtotal, delivery, discount, grand };
}

function updateSummary(){
  const t = getTotals();
  priceSubtotalEl.textContent = formatINR(t.subtotal);
  priceDeliveryEl.textContent = formatINR(t.delivery);
  priceDiscountEl.textContent = formatINR(t.discount);
  priceGrandEl.textContent = formatINR(t.grand);
  // also update UI elements like applied coupon message
  couponMsgEl.textContent = appliedCoupon ? `Applied: ${appliedCoupon.code} (${appliedCoupon.type === 'DELIVERY' ? 'Free delivery' : (appliedCoupon.type==='PERCENT' ? appliedCoupon.value + '%' : formatINR(appliedCoupon.value))})` : '';
}

/* ------------------ Coupon logic ------------------ */
function findCoupon(code){
  if(!code) return null;
  code = code.trim().toUpperCase();
  // First check admin-defined coupons in settings
  const adminCoupons = (settings && settings.coupons) ? settings.coupons : [];
  const foundAdmin = adminCoupons.find(c => (c.code||'').toUpperCase() === code);
  if(foundAdmin) return foundAdmin;
  // fallback to built-in demo coupons
  const demos = [
    {code:'SAVE50', type:'FLAT', value:50},
    {code:'FREEDEL', type:'DELIVERY', value: DELIVERY_CHARGE}
  ];
  return demos.find(c => c.code === code) || null;
}

applyCouponBtn.addEventListener('click', ()=>{
  const code = (couponInputEl.value || '').trim();
  if(!code){ alert('Enter coupon code'); return; }
  const c = findCoupon(code);
  if(!c){ couponMsgEl.textContent = 'Invalid coupon'; couponMsgEl.style.color = 'var(--danger)'; appliedCoupon = null; remove('nj_coupon'); updateSummary(); return; }
  appliedCoupon = c;
  save('nj_coupon', appliedCoupon);
  couponMsgEl.style.color = '#2b7b34';
  couponMsgEl.textContent = `Applied: ${c.code}`;
  updateSummary();
});

/* ------------------ Payment logic ------------------ */
paymentMethodEl.addEventListener('change', () => {
  if(paymentMethodEl.value === 'upi') upiBoxEl.style.display = 'block';
  else upiBoxEl.style.display = 'none';
});

/* ------------------ Address helpers ------------------ */
editProfileBtn.addEventListener('click', ()=> location.href = 'profile.html?next=checkout');
altAddressBtn.addEventListener('click', ()=>{
  const alt = prompt('Enter alternate delivery address (temporary for this order):');
  if(!alt) return;
  document.getElementById('profileAddress').textContent = alt;
});

useLocationBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){ locMsgEl.textContent = 'Geolocation not supported by your browser'; return; }
  useLocationBtn.disabled = true; useLocationBtn.textContent = 'Locating…';
  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat = pos.coords.latitude.toFixed(6), lon = pos.coords.longitude.toFixed(6);
    document.getElementById('profileAddress').textContent = `Current location — lat:${lat}, lon:${lon}`;
    locMsgEl.textContent = 'Using current location';
    useLocationBtn.disabled = false; useLocationBtn.textContent = 'Use current location';
  }, (err)=>{
    locMsgEl.textContent = 'Unable to get location: ' + (err.message || err.code);
    useLocationBtn.disabled = false; useLocationBtn.textContent = 'Use current location';
  }, { enableHighAccuracy:true, timeout:10000 });
});

/* ------------------ Place order ------------------ */
placeOrderBtn.addEventListener('click', ()=>{
  cart = load('nj_cart') || [];
  if(!cart || cart.length === 0){ alert('Your cart is empty'); return; }

  profile = load('nj_user') || null;
  if(!profile || !profile.name || !profile.phone){
    if(!confirm('No profile saved. Place order as guest? (We recommend saving profile)')) return;
  }

  const totals = getTotals();
  // build order object
  const order = {
    id: guid('ORD'),
    createdAt: Date.now(),
    items: cart,
    profile: profile || null,
    subtotal: totals.subtotal,
    deliveryCharge: totals.delivery,
    discount: totals.discount,
    total: totals.grand,
    payment: { method: paymentMethodEl.value || 'cod', upi: upiIdEl.value || (settings.storeUpi || null) },
    instructions: (document.getElementById('deliveryInstructions').value || '').trim(),
    status: 'placed'
  };

  // Save into nj_orders
  const orders = load('nj_orders') || [];
  orders.unshift(order);
  save('nj_orders', orders);
  save('nj_latest_order', order);

  // Cl
