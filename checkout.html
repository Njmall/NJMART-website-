<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Checkout</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Styles (expanded, production-ready) -->
  <style>
    :root{
      --bg:#f6fbf8;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#2db34a;
      --accent-dark:#1f8a34;
      --danger:#ef4444;
      --shadow: 0 12px 30px rgba(12,30,40,0.06);
      --radius:12px;
      --max-width:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:var(--max-width);margin:18px auto;padding:12px}

    header.top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:var(--shadow);
      position:sticky;top:12px;z-index:60;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    header.top h1{font-size:18px;margin:0}
    .small{font-size:13px;color:var(--muted)}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e6eef0}

    /* layout */
    .page{display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:16px}
    @media(max-width:980px){ .page{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:14px}

    /* form */
    .form-row{display:flex;gap:8px;margin-top:10px}
    .form-row .col{flex:1}
    .input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;background:#fff}
    textarea.input{min-height:80px;resize:vertical}

    /* payment methods */
    .pay-methods{display:flex;gap:8px;flex-direction:column;margin-top:10px}
    .pay-option{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:1px solid #e6eef0;cursor:pointer}
    .pay-option input{transform:scale(1.1)}
    .pay-option.selected{background:#f3fff6;border-color:rgba(45,179,74,0.15)}

    /* summary */
    .summary{position:sticky;top:90px}
    .summary .rowline{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
    .total{font-size:18px;font-weight:800}
    .coupon-row{display:flex;gap:8px;margin-top:8px}
    .coupon-row input{flex:1;padding:10px;border-radius:8px;border:1px solid #e6eef0}
    .note{font-size:13px;color:var(--muted)}
    .muted{color:var(--muted)}

    /* responsive */
    @media(max-width:720px){
      .form-row{flex-direction:column}
      .page{grid-template-columns:1fr}
      .summary{position:static}
    }
  </style>

  <!-- script-config.js must be present in same folder -->
  <script src="./script-config.js"></script>
</head>
<body>
  <div class="wrap">

    <!-- header -->
    <header class="top">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>
          <h1>NJ Mart</h1>
          <div class="small">Checkout</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost" onclick="location.href='cart.html'"><i class="fa fa-arrow-left"></i> Back to cart</button>
      </div>
    </header>

    <main class="page">

      <!-- left: checkout form -->
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Billing & delivery</div>
          <div class="small">Fill details to place the order</div>
        </div>

        <!-- customer fields -->
        <div style="margin-top:12px">
          <div class="form-row">
            <div class="col">
              <input id="name" class="input" placeholder="Full name" />
            </div>
            <div class="col">
              <input id="phone" class="input" placeholder="Mobile number (10 digits)" />
            </div>
          </div>

          <div class="form-row">
            <input id="email" class="input" placeholder="Email (optional)" />
          </div>

          <div class="form-row" style="margin-top:10px">
            <textarea id="address" class="input" placeholder="Delivery address: house / street / landmark"></textarea>
          </div>

          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button id="useLocation" class="btn ghost"><i class="fa fa-location-dot"></i> Use current location</button>
            <div class="small muted" id="locationMsg"></div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:800">Payment method</div>
            <div class="pay-methods" id="payMethods">
              <!-- options created by JS -->
            </div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:800">Apply coupon</div>
            <div class="coupon-row">
              <input id="couponCode" placeholder="Enter coupon code" />
              <button id="applyCoupon" class="btn primary">Apply</button>
            </div>
            <div class="small muted" id="couponMsg" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="placeOrderBtn" class="btn primary">Place Order (COD)</button>
            <button id="upiPayBtn" class="btn" style="background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#fff">Pay via UPI</button>
            <button id="cardBtn" class="btn ghost">Pay by Card (Coming)</button>
          </div>

          <div style="margin-top:8px" class="note">Order confirmation will be sent to the phone number entered above (or account phone if logged in).</div>
        </div>
      </section>

      <!-- right: order summary -->
      <aside class="summary">
        <div class="card">
          <div style="font-weight:800">Order summary</div>
          <div class="rowline" style="margin-top:8px"><div class="muted">Items total</div><div id="subtotal">₹0</div></div>
          <div class="rowline"><div class="muted">Delivery charge</div><div id="delivery">₹0</div></div>
          <div class="rowline"><div class="muted">Discount</div><div id="discount">₹0</div></div>
          <hr style="border:none;border-top:1px dashed #eee;margin:8px 0">
          <div class="rowline total"><div>Grand total</div><div id="grand">₹0</div></div>

          <div style="margin-top:8px" class="small muted">Delivery ₹20 for orders below ₹1000. Free for ₹1000 and above.</div>
        </div>
      </aside>

    </main>

  </div>

  <!-- Script: checkout logic -->
  <script>
  /*****************************************************************************
   * checkout.html — Production-ready checkout page
   * - Uses script-config.js functions if present:
   *    getCart(), saveCart(), getUser(), validateCoupon(code), addOrder(payload), addCustomer(payload), toast(msg)
   * - Fallbacks provided for local use (localStorage)
   * - UPI ID integrated: njmartnainwa@ybl
   * - Delivery rule: if subtotal < 1000 => ₹20 delivery else 0
   *****************************************************************************/

  // ---------- Config ----------
  const UPI_ID = 'njmartnainwa@ybl';           // provided by you
  const UPI_PAYEE_NAME = 'NJ Mart';
  const DELIVERY_THRESHOLD = 1000;             // ₹1000 threshold
  const DELIVERY_CHARGE = 20;                  // ₹20 when below threshold

  // ---------- safe function wrappers (script-config) ----------
  function exists(fn){ return (typeof window[fn] === 'function'); }
  const _getCart = exists('getCart') ? window.getCart : function(){ try{ return JSON.parse(localStorage.getItem('nj_cart')||'[]'); }catch(e){ return []; } };
  const _saveCart = exists('saveCart') ? window.saveCart : function(c){ localStorage.setItem('nj_cart', JSON.stringify(c)); };
  const _validateCoupon = exists('validateCoupon') ? window.validateCoupon : async function(code){ return { ok:false, error:'No coupon API' }; };
  const _addOrder = exists('addOrder') ? window.addOrder : async function(payload){ return { ok:false, error:'No addOrder API' }; };
  const _addCustomer = exists('addCustomer') ? window.addCustomer : async function(payload){ return { ok:false, error:'No addCustomer API' }; };
  const _getUser = exists('getUser') ? window.getUser : function(){ try{ return JSON.parse(localStorage.getItem('nj_user')||'null'); }catch(e){ return null; } };
  const _toast = (typeof toast === 'function') ? toast : function(m,ms=1800){ console.log('toast:',m); if(ms>0) {/* minimal */} alert(m); };

  // ---------- DOM refs ----------
  const nameEl = document.getElementById('name');
  const phoneEl = document.getElementById('phone');
  const emailEl = document.getElementById('email');
  const addressEl = document.getElementById('address');
  const useLocationBtn = document.getElementById('useLocation');
  const locationMsg = document.getElementById('locationMsg');

  const payMethodsEl = document.getElementById('payMethods');
  const couponInput = document.getElementById('couponCode');
  const applyCouponBtn = document.getElementById('applyCoupon');
  const couponMsg = document.getElementById('couponMsg');

  const placeOrderBtn = document.getElementById('placeOrderBtn');
  const upiPayBtn = document.getElementById('upiPayBtn');
  const cardBtn = document.getElementById('cardBtn');

  const subtotalEl = document.getElementById('subtotal');
  const deliveryEl = document.getElementById('delivery');
  const discountEl = document.getElementById('discount');
  const grandEl = document.getElementById('grand');

  // ---------- state ----------
  let CART = [];
  let APPLIED_COUPON = null;
  let SELECTED_PAYMENT = 'COD'; // default

  // ---------- init ----------
  document.addEventListener('DOMContentLoaded', () => {
    loadCart();
    renderPaymentOptions();
    bindUI();
    prefillUser();
    updateSummary();
  });

  function loadCart(){
    CART = _getCart() || [];
    // CART expected structure: array of { ProductID, Name, Price, Quantity, Image, ... }
  }

  function bindUI(){
    applyCouponBtn.addEventListener('click', onApplyCoupon);
    placeOrderBtn.addEventListener('click', onPlaceOrderCOD);
    upiPayBtn.addEventListener('click', onPayViaUPI);
    cardBtn.addEventListener('click', ()=> _toast('Card integration not configured', 2000));
    useLocationBtn.addEventListener('click', addCurrentLocation);
  }

  // Payment options UI
  function renderPaymentOptions(){
    const methods = [
      { id:'COD', label:'Cash on Delivery (Pay at delivery)' },
      { id:'UPI', label:'Pay via UPI (Instant)' },
      { id:'CARD', label:'Card / Netbanking (Coming)' }
    ];
    payMethodsEl.innerHTML = '';
    methods.forEach(m=>{
      const div = document.createElement('div');
      div.className = 'pay-option' + (m.id === SELECTED_PAYMENT ? ' selected' : '');
      div.innerHTML = `<label style="display:flex;align-items:center;gap:10px;width:100%"><input type="radio" name="pay" value="${m.id}" ${m.id===SELECTED_PAYMENT?'checked':''} /> <div style="flex:1">${m.label}</div></label>`;
      div.addEventListener('click', ()=>{
        SELECTED_PAYMENT = m.id;
        // visual select
        Array.from(payMethodsEl.querySelectorAll('.pay-option')).forEach(x=>x.classList.remove('selected'));
        div.classList.add('selected');
        // update button visibility / text
        updatePayButtons();
      });
      payMethodsEl.appendChild(div);
    });
    updatePayButtons();
  }

  function updatePayButtons(){
    if(SELECTED_PAYMENT === 'COD'){
      placeOrderBtn.style.display = 'inline-block';
      upiPayBtn.style.display = 'inline-block';
      upiPayBtn.textContent = 'Pay via UPI (optional)';
    } else if(SELECTED_PAYMENT === 'UPI'){
      placeOrderBtn.style.display = 'inline-block';
      upiPayBtn.style.display = 'inline-block';
      upiPayBtn.textContent = 'Pay via UPI';
    } else {
      // CARD or others
      placeOrderBtn.style.display = 'inline-block';
      upiPayBtn.style.display = 'none';
    }
  }

  // Prefill from logged in user if present
  function prefillUser(){
    try{
      const u = _getUser();
      if(u){
        if(u.Name) nameEl.value = u.Name;
        if(u.Phone) phoneEl.value = u.Phone;
        if(u.Email) emailEl.value = u.Email;
        if(u.Address) addressEl.value = u.Address;
      }
    }catch(e){ console.warn('prefillUser', e); }
  }

  // Add current location to address
  function addCurrentLocation(){
    if(!navigator.geolocation){ locationMsg.textContent = 'Geolocation not supported'; return; }
    locationMsg.textContent = 'Getting location...';
    navigator.geolocation.getCurrentPosition((pos)=>{
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      addressEl.value = `Lat: ${lat}, Lon: ${lon} — ${addressEl.value || ''}`;
      locationMsg.textContent = 'Location added';
    }, (err)=>{
      console.error(err);
      locationMsg.textContent = 'Could not access location';
    }, { enableHighAccuracy:true, timeout:10000 });
  }

  // Coupon apply
  async function onApplyCoupon(){
    const code = (couponInput.value || '').toString().trim();
    couponMsg.textContent = '';
    if(!code){ couponMsg.textContent = 'Enter coupon code'; return; }
    couponMsg.textContent = 'Checking...';
    try{
      const res = await _validateCoupon(code);
      if(res && res.ok){
        APPLIED_COUPON = { code: code, discount: Number(res.discount || res.Discount || 0) };
        couponMsg.textContent = `Coupon applied: ₹${APPLIED_COUPON.discount} off`;
        _toast('Coupon applied');
      } else {
        APPLIED_COUPON = null;
        couponMsg.textContent = (res && res.error) ? res.error : 'Invalid coupon';
        _toast('Invalid coupon');
      }
    }catch(err){
      APPLIED_COUPON = null;
      couponMsg.textContent = 'Coupon check failed';
      console.error(err);
    }
    updateSummary();
  }

  // Summary calculations
  function calcTotals(){
    const subtotal = CART.reduce((s,i) => s + (Number(i.Price || i.price || 0) * Number(i.Quantity || i.qty || 1)), 0);
    const delivery = (subtotal === 0 || subtotal >= DELIVERY_THRESHOLD) ? 0 : DELIVERY_CHARGE;
    const discount = APPLIED_COUPON ? Number(APPLIED_COUPON.discount || 0) : 0;
    const grand = Math.max(0, subtotal + delivery - discount);
    return { subtotal, delivery, discount, grand };
  }

  function updateSummary(){
    const t = calcTotals();
    subtotalEl.textContent = '₹' + (t.subtotal.toFixed(0));
    deliveryEl.textContent = '₹' + (t.delivery.toFixed(0));
    discountEl.textContent = '₹' + (t.discount.toFixed(0));
    grandEl.textContent = '₹' + (t.grand.toFixed(0));
  }

  // Helper: validate contact fields
  function validateCustomerFields(){
    const name = (nameEl.value || '').trim();
    const phone = (phoneEl.value || '').trim();
    const addr = (addressEl.value || '').trim();
    if(!name){ _toast('Enter name'); nameEl.focus(); return false; }
    if(!phone || !/^\d{10}$/.test(phone)){ _toast('Enter valid 10-digit phone'); phoneEl.focus(); return false; }
    if(!addr){ _toast('Enter delivery address'); addressEl.focus(); return false; }
    return true;
  }

  // Create order payload for backend
  function buildOrderPayload(paymentMethod){
    const t = calcTotals();
    const items = CART.map(i => ({
      ProductID: i.ProductID || i.productId || i.id,
      Name: i.Name || i.name,
      Price: Number(i.Price || i.price || 0),
      Quantity: Number(i.Quantity || i.qty || 1)
    }));
    const payload = {
      action: 'addOrder',
      CustomerID: '', // will be set after addCustomer if needed
      Items: JSON.stringify(items),
      TotalAmount: t.subtotal,
      Discount: t.discount,
      FinalAmount: t.grand,
      DeliveryAddress: (addressEl.value || '').trim(),
      Payment: paymentMethod,
      OrderDate: new Date().toLocaleString(),
      Status: (paymentMethod && paymentMethod.startsWith('UPI')) ? 'pending' : 'placed'
    };
    // include contact details
    payload.CustomerName = (nameEl.value || '').trim();
    payload.CustomerPhone = (phoneEl.value || '').trim();
    payload.CustomerEmail = (emailEl.value || '').trim();
    return payload;
  }

  // Add or find customer prior to order
  async function ensureCustomerExists(){
    const u = _getUser();
    if(u && (u.CustomerID || u.customerId)) return u.CustomerID || u.customerId;
    // else try to add customer via backend (non-blocking)
    const customer = {
      action: 'addCustomer',
      Name: (nameEl.value || '').trim(),
      Phone: (phoneEl.value || '').trim(),
      Email: (emailEl.value || '').trim(),
      Address: (addressEl.value || '').trim()
    };
    try{
      const res = await _addCustomer(customer);
      if(res && res.ok && res.id) return res.id;
    }catch(err){
      console.warn('addCustomer failed', err);
    }
    return '';
  }

  // Place order for COD (or generic)
  async function onPlaceOrderCOD(){
    if(!validateCustomerFields()) return;
    // ensure cart has items
    if(!CART || CART.length === 0){ _toast('Cart is empty'); return; }

    placeOrderBtn.disabled = true;
    placeOrderBtn.textContent = 'Placing order...';

    try{
      const customerId = await ensureCustomerExists();
      const payload = buildOrderPayload('COD');
      if(customerId) payload.CustomerID = customerId;
      // call backend
      const res = await _addOrder(payload);
      if(res && res.ok){
        _toast('Order placed successfully');
        // clear local cart
        CART = [];
        _saveCart(CART);
        // redirect to order page with id if returned
        const orderId = res.orderId || res.orderID || res.order || '';
        setTimeout(()=> {
          if(orderId) location.href = 'order.html?orderId=' + encodeURIComponent(orderId);
          else location.href = 'order.html';
        }, 600);
      } else {
        _toast((res && (res.error || res.message)) || 'Order failed');
        console.error('addOrder response', res);
      }
    }catch(err){
      console.error('place order error', err);
      _toast('Order failed: ' + String(err));
    } finally {
      placeOrderBtn.disabled = false;
      placeOrderBtn.textContent = 'Place Order (COD)';
    }
  }

  // UPI payment flow: create provisional order (status pending) then open upi:// link
  async function onPayViaUPI(){
    if(!validateCustomerFields()) return;
    if(!CART || CART.length === 0){ _toast('Cart is empty'); return; }

    const totals = calcTotals();
    // ensure customer exists
    try{
      upiPayBtn.disabled = true;
      upiPayBtn.textContent = 'Preparing UPI...';
      const customerId = await ensureCustomerExists();
      const payload = buildOrderPayload('UPI');
      if(customerId) payload.CustomerID = customerId;

      // save provisional order (status pending)
      const res = await _addOrder(payload);
      if(!(res && res.ok)){
        _toast('Unable to create order. Try again.');
        upiPayBtn.disabled = false;
        upiPayBtn.textContent = 'Pay via UPI';
        return;
      }

      const orderId = res.orderId || res.orderID || res.order || '';
      // build upi url with amount = totals.grand
      const amount = (totals.grand || 0).toFixed(2); // two decimals okay for UP
