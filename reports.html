<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Reports</title>

  <!-- fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- link site stylesheet -->
  <link rel="stylesheet" href="style.css">

  <!-- small inline helpers (keeps important layout stable before CSS loads) -->
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: #f6fbf8; color: #111; margin:0; }
    .wrap { max-width: 1100px; margin: 18px auto; padding: 14px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
  </style>
</head>
<body>

  <div class="wrap">

    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo-small">NJ</div>
        <div>
          <h1 class="page-title">Reports & Analytics</h1>
          <div class="muted small">Sales, orders, revenue and stock reports — live from your sheets</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnBack" class="btn ghost">← Back</button>
        <button id="btnExportReports" class="btn ghost"><i class="fa fa-file-csv"></i> Export CSV</button>
        <div id="adminBadge" class="pill hidden">Admin</div>
      </div>
    </div>

    <!-- filters -->
    <section class="panel">
      <div class="filter-row">
        <div class="filter-col">
          <label>From</label>
          <input id="fromDate" type="date">
        </div>
        <div class="filter-col">
          <label>To</label>
          <input id="toDate" type="date">
        </div>
        <div class="filter-col">
          <label>Report type</label>
          <select id="reportType">
            <option value="sales">Sales (revenue)</option>
            <option value="orders">Orders count</option>
            <option value="products">Top products</option>
            <option value="delivery">Delivery performance</option>
            <option value="customers">Customer growth</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:end">
          <button id="btnGenerate" class="btn primary">Generate</button>
          <button id="btnClearFilters" class="btn ghost">Clear</button>
        </div>
      </div>
    </section>

    <!-- quick metrics -->
    <section class="metrics-row">
      <div class="metric">
        <div class="metric-value" id="metricRevenue">₹0</div>
        <div class="metric-label">Revenue</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="metricOrders">0</div>
        <div class="metric-label">Orders</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="metricAOV">₹0</div>
        <div class="metric-label">Avg. order value</div>
      </div>
      <div class="metric">
        <div class="metric-value" id="metricCustomers">0</div>
        <div class="metric-label">New customers</div>
      </div>
    </section>

    <!-- chart + table area -->
    <section class="grid-2">
      <div class="panel">
        <h2>Time series</h2>
        <div id="chartArea" style="min-height:260px;display:flex;align-items:center;justify-content:center;color:var(--muted)">Generate a report to view charts</div>

        <div style="margin-top:12px">
          <label class="small muted">Granularity</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn ghost small" data-gran="daily">Daily</button>
            <button class="btn ghost small" data-gran="weekly">Weekly</button>
            <button class="btn ghost small" data-gran="monthly">Monthly</button>
          </div>
        </div>
      </div>

      <aside class="panel">
        <h3>Top items / quick breakdown</h3>
        <div id="breakdownList">
          <div class="muted small">Generate a report to view breakdown</div>
        </div>

        <div style="margin-top:12px">
          <h3>Quick actions</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="btnRefreshReports" class="btn ghost small">Refresh</button>
            <button id="btnSendSummary" class="btn primary small">Send summary (SMS/Email)</button>
          </div>
        </div>
      </aside>
    </section>

    <!-- data table -->
    <section class="panel" style="margin-top:12px">
      <h2>Report details</h2>
      <div style="overflow:auto">
        <table id="reportsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Subtotal</th>
              <th>Delivery</th>
              <th>Discount</th>
              <th>Final</th>
              <th>Payment</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="10" class="muted small">No report loaded</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <div style="height:28px"></div>

  </div> <!-- wrap -->

  <!-- libs (firebase first) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <!-- your config and helpers -->
  <script src="firebase-config.js"></script>
  <script src="script-config.js"></script>
  <script src="app.js"></script>

  <!-- Charting: lightweight — uses Chart.js CDN (works offline if you already have) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  /* Reports page logic
     - Relies on script-config.js providing API_BASE, apiGet(), apiPost()
     - If not present, fallback to window.API_BASE
     - This script builds report queries, draws chart and fills table
  */

  const byId = id => document.getElementById(id);
  const tableBody = document.querySelector('#reportsTable tbody');
  let activeChart = null;

  function formatINR(v){ return '₹' + (Number(v||0)).toFixed(0); }
  function humanDate(d){ const dt = new Date(d); if(isNaN(dt)) return d; return dt.toLocaleString(); }

  async function fetchOrdersInRange(from, to){
    // backend should return orders list; we filter by Order Date or Date field
    const res = await (typeof apiGet === 'function' ? apiGet({ action: 'orders' }) : fetch(window.API_BASE + '?action=orders').then(r=>r.json()));
    if(!res || !res.ok) return { ok:false, error: res && res.error ? res.error : 'Failed to load' };
    let list = res.orders || [];
    // Normalize date
    list = list.map(o => {
      const d = o['Order Date'] || o.Date || o.date || '';
      return Object.assign({}, o, { __date: new Date(d) });
    }).filter(o => !isNaN(o.__date));
    if(from) list = list.filter(o => o.__date >= new Date(from));
    if(to) list = list.filter(o => o.__date <= new Date(new Date(to).setHours(23,59,59,999)));
    // sort by date asc
    list.sort((a,b)=> a.__date - b.__date);
    return { ok:true, orders: list };
  }

  function aggregateByDay(list){
    const map = {};
    list.forEach(o=>{
      const day = o.__date.toISOString().slice(0,10);
      if(!map[day]) map[day] = { revenue:0, orders:0 };
      const val = Number(o['Final Amount']||o['Total Amount']||0);
      map[day].revenue += val;
      map[day].orders += 1;
    });
    const days = Object.keys(map).sort();
    return days.map(d => ({ date:d, revenue: map[d].revenue, orders: map[d].orders }));
  }

  function drawTimeSeries(data, type='sales'){
    const ctx = document.createElement('canvas');
    const area = document.getElementById('chartArea');
    area.innerHTML = '';
    area.appendChild(ctx);

    const labels = data.map(r => r.date);
    const dataset = type === 'orders' ? data.map(r => r.orders) : data.map(r => r.revenue);
    const label = type === 'orders' ? 'Orders' : 'Revenue (₹)';

    if(activeChart) activeChart.destroy();
    activeChart = new Chart(ctx.getContext('2d'), {
      type: 'line',
      data: { labels, datasets: [{ label, data: dataset, fill:false, tension:0.25, borderWidth:2 }] },
      options: { responsive:true, plugins:{legend:{display:false}} }
    });
  }

  function fillBreakdown(orders){
    const area = byId('breakdownList');
    area.innerHTML = '';
    if(!orders || orders.length === 0){ area.innerHTML = '<div class="muted small">No data</div>'; return; }

    // compute top products (assumes Items stored as JSON array in 'Item' or 'Items' field)
    const counts = {};
    orders.forEach(o=>{
      const itemsRaw = o.Item || o.Items || o.Items || '[]';
      let items = [];
      try{ items = typeof itemsRaw === 'string' ? JSON.parse(itemsRaw) : itemsRaw; }catch(e){ items=[]; }
      items.forEach(it=>{
        const pid = it.id || it.ProductID || it.id || it.productId || it.Product || it.name || it.Name;
        const name = it.name || it.Name || pid || 'Unknown';
        const qty = Number(it.qty || it.quantity || it.Quantity || 1);
        if(!counts[name]) counts[name] = 0;
        counts[name] += qty;
      });
    });
    const top = Object.keys(counts).map(k=>({ name:k, qty:counts[k] })).sort((a,b)=>b.qty-a.qty).slice(0,8);
    const ul = document.createElement('div');
    top.forEach(t=>{
      const row = document.createElement('div');
      row.style.display = 'flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
      row.innerHTML = `<div>${escapeHtml(t.name)}</div><div class="muted small">x${t.qty}</div>`;
      ul.appendChild(row);
    });
    if(top.length===0) ul.innerHTML = '<div class="muted small">No product items found</div>';
    area.appendChild(ul);
  }

  function escapeHtml(s){ if(!s) return ''; return (''+s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  function fillTable(orders){
    tableBody.innerHTML = '';
    if(!orders || orders.length === 0){ tableBody.innerHTML = '<tr><td colspan="10" class="muted small">No orders in this period</td></tr>'; return; }
    orders.forEach(o=>{
      const date = humanDate(o.__date);
      const items = o.Item || o.Items || '[]';
      const itemsDisplay = (()=> {
        try{
          const parsed = typeof items === 'string' ? JSON.parse(items) : items;
          if(Array.isArray(parsed)) return parsed.map(i => (i.name || i.Name || i.Product || i.ProductID || i.id) + ' x' + (i.qty||i.quantity||1)).join('<br>');
          return escapeHtml(''+items);
        }catch(e){ return escapeHtml(''+items); }
      })();

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escapeHtml(date)}</td>
        <td class="nowrap">${escapeHtml(o.OrderID || o.orderId || '')}</td>
        <td class="nowrap">${escapeHtml(o.CustomerID || o.Phone || o.Email || '')}</td>
        <td>${itemsDisplay}</td>
        <td>${formatINR(o['Total Amount']||o.Subtotal||0)}</td>
        <td>${formatINR(o['Delivery Charge']||o.Delivery||0)}</td>
        <td>${formatINR(o['Discount']||0)}</td>
        <td>${formatINR(o['Final Amount']||o.Total||0)}</td>
        <td>${escapeHtml(o['Payment Method']||o.Payment||'')}</td>
        <td>${escapeHtml(o.Status||'')}</td>
      `;
      tableBody.appendChild(row);
    });
  }

  async function generateReport(){
    byId('btnGenerate').disabled = true;
    const from = byId('fromDate').value;
    const to   = byId('toDate').value;
    const type = byId('reportType').value;

    const res = await fetchOrdersInRange(from, to);
    byId('btnGenerate').disabled = false;
    if(!res.ok){ alert('Failed to load orders: ' + (res.error || 'unknown')); return; }
    const orders = res.orders;

    // compute metrics
    const revenue = orders.reduce((s,o) => s + Number(o['Final Amount']||o['Total Amount']||0), 0);
    const ordersCount = orders.length;
    const customersUnique = new Set(orders.map(o => o.CustomerID || o.Phone || o.Email)).size;
    const aov = ordersCount ? Math.round(revenue / ordersCount) : 0;

    byId('metricRevenue').textContent = formatINR(revenue);
    byId('metricOrders').textContent = ordersCount;
    byId('metricAOV').textContent = formatINR(aov);
    byId('metricCustomers').textContent = customersUnique;

    // aggregate by day — simple example
    const agg = aggregateByDay(orders);
    if(type === 'products'){
      // for product report we can draw top products as bar data
      drawProductsBar(orders);
    } else {
      drawTimeSeries(agg, type === 'orders' ? 'orders' : 'sales');
    }

    fillBreakdown(orders);
    fillTable(orders);
  }

  function drawProductsBar(orders){
    // compute product totals
    const counts = {};
    orders.forEach(o=>{
      const itemsRaw = o.Item || o.Items || '[]';
      let items = [];
      try{ items = typeof itemsRaw === 'string' ? JSON.parse(itemsRaw) : itemsRaw; }catch(e){ items=[]; }
      items.forEach(it=>{
        const name = it.name || it.Name || it.Product || it.ProductID || 'Unknown';
        counts[name] = (counts[name] || 0) + (Number(it.qty || it.quantity || 1));
      });
    });
    const arr = Object.keys(counts).map(k => ({ name:k, qty:counts[k] })).sort((a,b)=>b.qty - a.qty).slice(0,12);
    const ctx = document.createElement('canvas');
    const area = byId('chartArea'); area.innerHTML=''; area.appendChild(ctx);

    if(activeChart) activeChart.destroy();
    activeChart = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: { labels: arr.map(a=>a.name), datasets: [{ label:'Qty', data: arr.map(a=>a.qty) }] },
      options: { indexAxis:'y', plugins:{legend:{display:false}}, responsive:true }
    });
  }

  // export table to CSV
  function tableToCSV(){
    const rows = [];
    const header = Array.from(document.querySelectorAll('#reportsTable thead th')).map(th => th.textContent.trim());
    rows.push(header.join(','));
    Array.from(tableBody.querySelectorAll('tr')).forEach(tr=>{
      const cols = Array.from(tr.querySelectorAll('td')).map(td => '"' + (td.innerText.replace(/"/g,'""')) + '"');
      rows.push(cols.join(','));
    });
    return rows.join('\n');
  }

  // helpers to set default date range for last 7 days
  function setDefaultDates(){
    const now = new Date();
    const to = new Date(now);
    const from = new Date(now); from.setDate(now.getDate() - 7);
    byId('fromDate').value = from.toISOString().slice(0,10);
    byId('toDate').value = to.toISOString().slice(0,10);
  }

  // UI wiring
  document.addEventListener('DOMContentLoaded', ()=>{
    setDefaultDates();
    byId('btnGenerate').addEventListener('click', generateReport);
    byId('btnRefreshReports').addEventListener('click', generateReport);
    byId('btnExportReports').addEventListener('click', ()=>{
      const csv = tableToCSV();
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'njmart_reports.csv'; a.click();
      URL.revokeObjectURL(url);
    });
    byId('btnBack').addEventListener('click', ()=> location.href = 'admin.html');

    // small convenience: clicking granularity buttons adjusts UI — not required
    document.querySelectorAll('[data-gran]').forEach(b=>{
      b.addEventListener('click', (e)=>{
        document.querySelectorAll('[data-gran]').forEach(x => x.classList.remove('active'));
        e.target.classList.add('active');
        // no change in dataset for now — client-side manipulation possible
      });
    });
  });
  </script>
</body>
</html>
