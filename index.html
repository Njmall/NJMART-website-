<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart â€” Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#2db34a; --accent-dark:#239032; --muted:#6b7280; --card:#fff; --bg:#f4f8f7; --radius:12px;
      --shadow: 0 14px 40px rgba(12,30,40,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto;background:var(--bg);color:#0b1220}
    .wrap{max-width:1100px;margin:12px auto;padding:12px}
    header.site{display:flex;gap:12px;align-items:center;justify-content:space-between;background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#38c36a);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .brand h1{font-size:18px;margin:0}
    .search{flex:1;margin:0 12px}
    .search input{width:100%;padding:12px;border-radius:999px;border:1px solid #eef6f2}
    .nav-actions{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:white}
    .btn.ghost{background:#fff;border:1px solid #eef6f2}
    .cart-ind{display:flex;gap:8px;align-items:center}
    .cart-badge{background:#e04545;color:#fff;padding:4px 8px;border-radius:999px;font-weight:800}
    main{margin-top:14px}
    .hero{display:flex;gap:16px;align-items:center;background:linear-gradient(180deg,var(--accent),#18a84c);color:#fff;padding:18px;border-radius:12px;box-shadow:var(--shadow)}
    .hero h2{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:14px}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .hero{flex-direction:column;align-items:flex-start} }
    .left .section{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 12px 30px rgba(12,30,40,.04);margin-bottom:12px}
    .categories{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px}
    .cat{background:#fff;padding:12px;border-radius:10px;text-align:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.03)}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .product{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.04);display:flex;flex-direction:column;gap:8px}
    .product .thumb{height:160px;border-radius:10px;overflow:hidden;background:#f5f7f6}
    .product img{width:100%;height:100%;object-fit:cover}
    .product h3{margin:0;font-size:15px}
    .product .meta{color:var(--muted);font-size:13px}
    .product .row{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:6px}
    .product .price{font-weight:800;color:var(--accent)}
    .sticky-cart{position:fixed;right:18px;bottom:18px;background:var(--accent);color:white;padding:12px 16px;border-radius:999px;box-shadow:0 12px 40px rgba(12,30,40,.2);cursor:pointer;z-index:999}
    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px;padding:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="site">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>
          <h1>NJ Mart</h1>
          <div style="font-size:13px;color:var(--muted)">Grocery â€¢ Home delivery</div>
        </div>
      </div>

      <div class="search">
        <input id="searchInput" placeholder="Search products, e.g., milk, atta, oil">
      </div>

      <div class="nav-actions">
        <div id="userBadge">Guest</div>
        <div class="cart-ind">
          <button class="btn ghost" onclick="location.href='cart.html'">Cart</button>
          <div class="cart-badge" id="cartCountBadge">0</div>
        </div>
        <button id="loginBtn" class="btn primary">Login</button>
      </div>
    </header>

    <main>
      <div class="hero">
        <div style="flex:1">
          <h2>Fresh groceries delivered to your door</h2>
          <p style="margin:6px 0;color:rgba(255,255,255,.95)">Daily essentials â€¢ Fresh produce â€¢ Fast delivery â€¢ Secure payments</p>
          <div style="margin-top:8px">
            <button class="btn" onclick="scrollToProducts()">Start shopping</button>
            <button class="btn ghost" onclick="location.href='products.html'">All products</button>
          </div>
        </div>
        <div style="width:160px"><img src="https://via.placeholder.com/160x120?text=Fresh" style="width:100%;border-radius:10px"></div>
      </div>

      <div class="grid">
        <div class="left">
          <div class="section">
            <h3>Categories</h3>
            <div class="categories" id="categoryGrid"></div>
          </div>

          <div class="section">
            <h3>Trending Products</h3>
            <div class="products" id="productGrid"></div>
          </div>
        </div>

        <aside>
          <div class="section">
            <h3>Your Cart</h3>
            <div id="smallCartSummary" style="margin-top:10px">No items yet</div>
            <div style="margin-top:10px">
              <button class="btn primary" onclick="location.href='cart.html'">Open cart</button>
              <button class="btn ghost" onclick="location.href='orders.html'">My orders</button>
            </div>
          </div>

          <div class="section" id="accountBox">
            <h3>Account</h3>
            <div id="accountInfo" style="margin-top:8px">Not signed in</div>
            <div style="margin-top:8px">
              <button class="btn ghost" id="profileBtn">Profile</button>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <footer>Â© 2025 NJ Mart â€” Local demo â€¢ Terms â€¢ Privacy</footer>
  </div>

  <div class="sticky-cart" id="stickyCartBtn" onclick="location.href='cart.html'">
    ðŸ›’ <span id="stickyTotal">â‚¹0</span> â€¢ <span id="stickyItems">0</span>
  </div>

  <script type="module">
    import { auth, db, onAuth, loadProductsOnce } from './firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // STORAGE KEYS
    const CART_KEY = 'nj_cart';
    const CHECKOUT_KEY = 'nj_checkout';
    const COUPON_KEY = 'nj_coupon';

    // DOM
    const productGrid = document.getElementById('productGrid');
    const categoryGrid = document.getElementById('categoryGrid');
    const cartCountBadge = document.getElementById('cartCountBadge');
    const stickyTotal = document.getElementById('stickyTotal');
    const stickyItems = document.getElementById('stickyItems');
    const smallCartSummary = document.getElementById('smallCartSummary');
    const userBadge = document.getElementById('userBadge');
    const loginBtn = document.getElementById('loginBtn');
    const profileBtn = document.getElementById('profileBtn');

    // helper localStorage functions
    function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch(e){ return []; } }
    function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartUI(); }
    function clearCartLocal(){ localStorage.removeItem(CART_KEY); updateCartUI(); }

    function updateCartUI(){
      const cart = loadCart();
      const count = cart.reduce((s,i)=>s + (i.qty||0), 0);
      const total = cart.reduce((s,i)=>s + (i.qty||0) * (i.price||0), 0);
      cartCountBadge.textContent = count;
      stickyItems.textContent = count;
      stickyTotal.textContent = 'â‚¹' + total.toFixed(0);
      smallCartSummary.textContent = count === 0 ? 'No items yet' : `${count} items â€¢ ${'â‚¹'+total.toFixed(0)}`;
    }

    function addToCart(product, qty=1){
      const cart = loadCart();
      const idx = cart.findIndex(p=>p.id === product.id);
      if(idx > -1) cart[idx].qty += qty;
      else cart.push({ id: product.id, name: product.name, price: product.price, qty: qty, img: product.image || '', category: product.category || '' });
      saveCart(cart);
      showToast(`${product.name} added to cart`);
    }

    function showToast(msg, t=1400){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position = 'fixed'; el.style.left='50%'; el.style.transform='translateX(-50%)';
      el.style.bottom='110px'; el.style.background='#111'; el.style.color='#fff'; el.style.padding='8px 12px';
      el.style.borderRadius='999px'; el.style.zIndex='9999'; el.style.opacity='0'; el.style.transition='opacity .12s';
      document.body.appendChild(el);
      requestAnimationFrame(()=> el.style.opacity='1');
      setTimeout(()=> { el.style.opacity='0'; setTimeout(()=> el.remove(),200); }, t);
    }

    // render products from Firestore
    async function loadAndRenderProducts(){
      try{
        // prefer helper loadProductsOnce from firebase-config; fallback to direct getDocs
        let products = [];
        try { products = await loadProductsOnce(200); } catch(e){}
        if(!products || products.length === 0){
          const col = collection(db, 'products');
          const snap = await getDocs(col);
          products = [];
          snap.forEach(d => products.push({ id: d.id, ...d.data() }));
        }
        renderProductGrid(products);
        populateCategories(products);
      }catch(err){
        console.error('Products load error', err);
        productGrid.innerHTML = '<div style="color:var(--muted)">Error loading products.</div>';
      }
    }

    function renderProductGrid(list){
      productGrid.innerHTML = '';
      list.forEach(p => {
        const node = document.createElement('div');
        node.className = 'product';
        node.innerHTML = `
          <div class="thumb"><img src="${p.image||'https://via.placeholder.com/400x300?text=Product'}" alt="${escapeHtml(p.name)}"></div>
          <h3>${escapeHtml(p.name)}</h3>
          <div class="meta">${escapeHtml(p.category||'')}</div>
          <div class="row">
            <div class="price">â‚¹${p.price}</div>
            <div><button class="btn primary">Add</button></div>
          </div>
        `;
        node.querySelector('button').addEventListener('click', ()=> addToCart(p));
        productGrid.appendChild(node);
      });
    }

    function populateCategories(products){
      const cats = Array.from(new Set(products.map(p => p.category || 'General'))).slice(0,12);
      categoryGrid.innerHTML = '';
      cats.forEach(cat=>{
        const c = document.createElement('div');
        c.className = 'cat';
        c.innerHTML = `<div style="font-weight:700">${escapeHtml(cat)}</div>`;
        c.addEventListener('click', ()=> {
          const filtered = (window._nj_products || []).filter(x=>x.category === cat);
          renderProductGrid(filtered);
        });
        categoryGrid.appendChild(c);
      });
      // store available products globally for filter
      window._nj_products = window._nj_products || [];
      // if not loaded, set later after render
    }

    // search
    document.getElementById('searchInput').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') doSearch();
    });
    function doSearch(){
      const q = (document.getElementById('searchInput').value||'').trim().toLowerCase();
      if(!q) return loadAndRenderProducts();
      const list = (window._nj_products || []).filter(p => (p.name||'').toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q));
      renderProductGrid(list);
    }

    // small helper to escape html
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // auth state and profile
    onAuth((user) => {
      if(user){
        userBadge.textContent = user.phone || (user.displayName || 'User');
        loginBtn.textContent = 'Logout';
        profileBtn.style.display = 'inline-block';
        // optional: fetch and show saved customer address
      } else {
        userBadge.textContent = 'Guest';
        loginBtn.textContent = 'Login';
        profileBtn.style.display = 'none';
      }
    });

    // login button behavior
    loginBtn.addEventListener('click', ()=> {
      if(loginBtn.textContent === 'Login') location.href = 'login.html';
      else {
        // sign out
        import('./firebase-config.js').then(mod => {
          mod.signOutUser().then(()=> {
            showToast('Signed out');
            location.reload();
          }).catch(e=> alert('Sign out: ' + e.message));
        });
      }
    });

    profileBtn.addEventListener('click', ()=> location.href = 'profile.html');

    // initial load
    (async function init(){
      updateCartUI();
      await loadAndRenderProducts();
      // once loaded, store globally
      try { window._nj_products = await loadProductsOnce(500); } catch(e){ /* ignore */ }
    })();

  </script>
</body>
</html>
