<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Online Grocery</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/sgVhyLYH/IMG-20250913-WA0003.jpg">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />

  <style>
    body { margin:0; font-family: 'Inter', sans-serif; background:#f9fafb; }
    header.site-header { background:#fff; box-shadow:0 4px 20px rgba(0,0,0,0.05); padding:12px 20px; position:sticky; top:0; z-index:100; display:flex; align-items:center; }
    header .brand { display:flex; align-items:center; gap:10px; font-weight:800; font-size:20px; color:#2db34a; }
    header nav { margin-left:auto; display:flex; gap:16px; align-items:center; }
    header nav a { color:#111; font-weight:600; text-decoration:none; }
    header nav .btn { background:#2db34a; color:#fff; padding:8px 14px; border-radius:8px; text-decoration:none; font-weight:600; }

    /* Hero section */
    .hero { background:#2db34a; color:#fff; padding:60px 20px; text-align:center; }
    .hero h1 { font-size:36px; margin:0 0 12px; }
    .hero p { font-size:18px; margin:0; }

    /* Layout */
    .container { max-width:1200px; margin:20px auto; padding:0 16px; }
    .flex { display:flex; gap:16px; }
    .sidebar { width:260px; background:#fff; padding:16px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
    .content { flex:1; }

    /* Sidebar filters */
    .sidebar h3 { margin:0 0 12px; font-size:18px; }
    .sidebar label { font-size:14px; display:block; margin-top:8px; }
    .sidebar input[type="number"] { width:100%; padding:6px; margin-top:4px; border:1px solid #ddd; border-radius:6px; }
    .sidebar button { margin-top:10px; width:100%; padding:8px; border:none; border-radius:8px; background:#2db34a; color:#fff; font-weight:600; cursor:pointer; }

    /* Product Grid */
    .products-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:16px; }
    .product-card { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05); padding:12px; display:flex; flex-direction:column; }
    .product-card img { width:100%; height:160px; object-fit:cover; border-radius:8px; }
    .product-card h4 { margin:10px 0 6px; font-size:16px; font-weight:700; }
    .product-card p { margin:0; font-size:14px; color:#555; }
    .product-card .price { font-size:16px; font-weight:700; color:#2db34a; margin:8px 0; }
    .product-card button { margin-top:auto; padding:8px; background:#2db34a; color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; }

    /* Cart button floating */
    .cart-btn { position:fixed; bottom:20px; right:20px; background:#2db34a; color:#fff; padding:14px 20px; border-radius:50px; box-shadow:0 4px 14px rgba(0,0,0,0.2); font-weight:700; cursor:pointer; }

    /* Footer */
    footer { margin-top:40px; padding:20px; background:#fff; border-top:1px solid #eee; text-align:center; font-size:14px; color:#555; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="brand">
      <i class="fa fa-store"></i> NJ Mart
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="cart.html">Cart <span id="cartCount">(0)</span></a>
      <a href="login.html">Login</a>
      <a href="profile.html">Profile</a>
      <a href="checkout.html" class="btn">Checkout</a>
    </nav>
  </header>

  <!-- HERO -->
  <section class="hero">
    <h1>Fresh groceries delivered to your door</h1>
    <p>Daily essentials, staples and fresh produce — shop local brands with quick home delivery</p>
  </section>

  <!-- MAIN CONTENT -->
  <div class="container flex">
    <!-- Sidebar Filters -->
    <aside class="sidebar">
      <h3>Filter Products</h3>
      <label>Min Price</label>
      <input type="number" id="minPrice" placeholder="₹0">
      <label>Max Price</label>
      <input type="number" id="maxPrice" placeholder="₹1000">
      <button onclick="applyFilters()">Apply</button>
    </aside>

    <!-- Products -->
    <main class="content">
      <h2>Products</h2>
      <div id="productsArea" class="products-grid">
        <!-- Products will be loaded here -->
      </div>
    </main>
  </div>
  <!-- ========== Part 2 — products, cart & scripts ========== -->

  <!-- cart floating button -->
  <button id="btnCart" class="cart-btn" title="View cart">Cart • <span id="cartTotalAmount">₹0</span></button>

  <!-- footer -->
  <footer>
    © <span id="year"></span> NJ Mart — All rights reserved. Support: +91 70000 00000
  </footer>

  <!-- Scripts: app logic -->
  <script>
  /****************************************************************
   * NJ Mart — client-side app.js (embedded)
   * - Loads products from Apps Script backend (API_BASE)
   * - Maintains cart in localStorage
   * - Supports search, filter, pagination, coupon validation
   * - Checkout flow supports COD & UPI deep link
   *
   * Make sure API_BASE matches your deployed Apps Script web app URL.
   ****************************************************************/

  // ---------------- CONFIG ----------------
  const API_BASE = 'https://script.google.com/macros/s/AKfycbwsG5H7er3nqwGjEbrtokssc5LeGFc9Zog2bG1s0C5bQ-P2b_1S1kisSLpOmdESH7FB/exec';
  const PRODUCT_SHEET = 'Products';
  const STORAGE_KEYS = { CART: 'nj_cart_v1', COUPON: 'nj_coupon' };
  const PAGE_SIZE = 12;

  // ---------------- DOM helpers ----------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const el = id => document.getElementById(id);

  const productsArea = document.getElementById('productsArea');
  const cartBtn = document.getElementById('btnCart');
  const cartTotalAmountEl = document.getElementById('cartTotalAmount');
  const cartCountEl = document.getElementById('cartCount');

  // ---------------- State ----------------
  let PRODUCTS = [];        // loaded product objects
  let FILTERED = [];        // after filter/search
  let CURRENT_PAGE = 1;
  let CART = loadCartFromStorage() || [];

  // ---------------- Utils ----------------
  function formatPrice(v){ return '₹' + (Number(v||0)).toFixed(0); }
  function nowYear(){ document.getElementById('year').textContent = new Date().getFullYear(); }

  // image fallback
  function safeImage(url){
    if(!url) return 'https://via.placeholder.com/300x200?text=No+Image';
    // if user provided valid http(s) URL, use it; otherwise placeholder
    if(/^https?:\/\//i.test(url)) return url;
    return 'https://via.placeholder.com/300x200?text=No+Image';
  }

  // ---------------- Storage ----------------
  function saveCartToStorage(){
    try{ localStorage.setItem(STORAGE_KEYS.CART, JSON.stringify(CART || [])); }catch(e){}
    renderCartSummary();
  }
  function loadCartFromStorage(){
    try{
      const raw = localStorage.getItem(STORAGE_KEYS.CART);
      if(!raw) return [];
      return JSON.parse(raw);
    }catch(e){ return []; }
  }

  // ---------------- Cart functions ----------------
  function findCartItemIndex(productId){
    return CART.findIndex(i => i.ProductID === productId);
  }

  function addToCart(product, qty=1){
    const idx = findCartItemIndex(product.ProductID);
    if(idx === -1){
      CART.push({
        ProductID: product.ProductID,
        Name: product.Name || 'Unnamed product',
        Price: Number(product.Price || 0),
        Quantity: Number(qty || 1),
        ImageURL: product['Image URL'] || product.Image || ''
      });
    } else {
      CART[idx].Quantity = Number(CART[idx].Quantity || 0) + Number(qty || 1);
    }
    saveCartToStorage();
    toast('Added to cart');
  }

  function updateCartItem(productId, qty){
    const idx = findCartItemIndex(productId);
    if(idx === -1) return;
    if(qty <= 0){
      CART.splice(idx,1);
    } else {
      CART[idx].Quantity = Number(qty);
    }
    saveCartToStorage();
  }

  function clearCart(){
    CART = [];
    saveCartToStorage();
    toast('Cart cleared');
  }

  function cartTotal(){
    return CART.reduce((s,it)=> s + (Number(it.Price||0) * Number(it.Quantity||0)), 0);
  }

  function cartCount(){
    return CART.reduce((s,it)=> s + Number(it.Quantity||0), 0);
  }

  // ---------------- UI render functions ----------------
  function renderProductsList(page=1){
    CURRENT_PAGE = page || 1;
    const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
    const pageItems = FILTERED.slice(start, start + PAGE_SIZE);

    productsArea.innerHTML = '';
    if(!pageItems || pageItems.length === 0){
      productsArea.innerHTML = '<div style="padding:32px;color:#666">No products found</div>';
      return;
    }

    pageItems.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      const img = safeImage(p['Image URL'] || p.Image || p.image);
      const price = Number(p.Price || p.price || 0);
      const stock = Number(p.Stock || p.stock || 0);
      card.innerHTML = `
        <img src="${img}" alt="${escapeHtml(p.Name||'Product')}" onerror="this.src='https://via.placeholder.com/300x200?text=Image+not+found'"/>
        <h4>${escapeHtml(p.Name||'Unnamed')}</h4>
        <p class="muted-sm">${escapeHtml(p.Category || p.category || '')}</p>
        <div class="price">${formatPrice(price)}</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <input type="number" min="1" max="${Math.max(1,stock)}" value="1" style="width:70px;padding:6px;border-radius:6px;border:1px solid #eee" class="qty-input" data-id="${p.ProductID}" />
          <button class="add-btn" data-id="${p.ProductID}">Add to cart</button>
        </div>
        <div style="margin-top:8px;font-size:13px;color:${stock>0? '#22c55e':'#ef4444'}">
          ${stock>0 ? 'In stock ('+stock+')' : 'Out of stock'}
        </div>
      `;
      productsArea.appendChild(card);
    });

    // attach handlers for add buttons
    $$('.add-btn').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        const pid = b.getAttribute('data-id');
        const input = document.querySelector('.qty-input[data-id="'+pid+'"]');
        const qty = input ? Math.max(1, Number(input.value||1)) : 1;
        const prod = PRODUCTS.find(x=> x.ProductID === pid) || {};
        if(Number(prod.Stock||0) > 0 || Number(prod.Stock||0) === 0){ // allow adding even if stock unknown
          addToCart(prod, qty);
        } else {
          toast('Product out of stock');
        }
      });
    });

    renderPagination();
  }

  function renderPagination(){
    const totalPages = Math.max(1, Math.ceil(FILTERED.length / PAGE_SIZE));
    // simple pagination: prev / page / next
    const nav = document.createElement('div');
    nav.style.marginTop = '18px';
    nav.style.display = 'flex';
    nav.style.gap = '8px';
    nav.style.alignItems = 'center';
    nav.innerHTML = `
      <button id="prevBtn" class="btn ghost">Prev</button>
      <div style="font-weight:700">Page ${CURRENT_PAGE} of ${totalPages}</div>
      <button id="nextBtn" class="btn ghost">Next</button>
    `;
    productsArea.appendChild(nav);
    document.getElementById('prevBtn').addEventListener('click', ()=> {
      if(CURRENT_PAGE>1) renderProductsList(CURRENT_PAGE-1);
    });
    document.getElementById('nextBtn').addEventListener('click', ()=> {
      if(CURRENT_PAGE < totalPages) renderProductsList(CURRENT_PAGE+1);
    });
  }

  function renderCartSummary(){
    cartTotalAmountEl.textContent = formatPrice(cartTotal());
    cartCountEl.textContent = '(' + cartCount() + ')';
  }

  // ---------------- Toast ----------------
  let toastTimer = null;
  function toast(msg, duration=1400){
    // small ephemeral message top-right
    let box = document.getElementById('nj_toast');
    if(!box){
      box = document.createElement('div');
      box.id = 'nj_toast';
      box.style.position = 'fixed';
      box.style.top = '20px';
      box.style.right = '20px';
      box.style.background = 'rgba(0,0,0,0.8)';
      box.style.color = '#fff';
      box.style.padding = '10px 14px';
      box.style.borderRadius = '8px';
      box.style.zIndex = 9999;
      document.body.appendChild(box);
    }
    box.textContent = msg || '';
    box.style.opacity = 1;
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> { box.style.opacity = 0; }, duration);
  }

  // ---------------- Search & Filter ----------------
  function applyFilters(){
    const min = Number((document.getElementById('minPrice')||{}).value || 0);
    const max = Number((document.getElementById('maxPrice')||{}).value || 0) || Number.MAX_SAFE_INTEGER;
    FILTERED = PRODUCTS.filter(p => {
      const price = Number(p.Price || p.price || 0);
      if(price < min) return false;
      if(price > max) return false;
      return true;
    });
    renderProductsList(1);
  }

  // escape html
  function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ---------------- API helpers ----------------
  async function apiGet(params={}){
    const u = new URL(API_BASE);
    Object.keys(params || {}).forEach(k => u.searchParams.set(k, params[k]));
    try{
      const res = await fetch(u.toString(), { method:'GET', cache:'no-store' });
      const json = await res.json();
      return json;
    }catch(err){
      console.error('apiGet error', err);
      return { ok:false, error: String(err) };
    }
  }

  async function apiPost(payload){
    try{
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      return await res.json();
    }catch(err){
      console.error('apiPost error', err);
      return { ok:false, error: String(err) };
    }
  }

  // ---------------- Load products ----------------
  async function loadProducts(){
    toast('Loading products...');
    // Prefer backend (sheet). If backend fails, fallback to static sample.
    const r = await apiGet({ action: 'products' });
    if(r && r.ok && Array.isArray(r.products) && r.products.length){
      PRODUCTS = normalizeProducts(r.products);
    } else {
      // fallback sample if backend fails
      PRODUCTS = [
        { ProductID:'p-sample-1', Name:'Sample Aata', Price:400, Stock:10, Category:'Aats', 'Image URL': 'https://via.placeholder.com/300x200?text=Aata', Quantity:'10kg' },
        { ProductID:'p-sample-2', Name:'Colgate Toothpaste', Price:70, Stock:20, Category:'Paste', 'Image URL': 'https://via.placeholder.com/300x200?text=Toothpaste', Quantity:'100gm' }
      ];
      toast('Loaded fallback products (backend unavailable)');
    }
    FILTERED = PRODUCTS.slice();
    renderProductsList(1);
    renderCartSummary();
  }

  // normalize product fields
  function normalizeProducts(list){
    return list.map((p, idx) => {
      return {
        ProductID: p.ProductID || p.ProductId || p['Product ID'] || ('p-'+(p.name||p.Name||idx)),
        Name: p.Name || p.name || 'Unnamed product',
        Price: Number(p.Price || p.price || 0),
        Stock: Number(p.Stock || p.stock || 0),
        Category: p.Category || p.category || p.cat || '',
        'Image URL': p['Image URL'] || p.Image || p.image || p['ImageURL'] || '',
        Quantity: p.Quantity || p.quantity || ''
      };
    });
  }

  // ---------------- Coupons ----------------
  async function validateCoupon(code){
    if(!code) return { ok:false, error:'Empty code' };
    const res = await apiPost({ action:'validatecoupon', code: code });
    return res;
  }

  // ---------------- Checkout helpers ----------------
  // build UPI deep-link for payment
  function buildUpiLink(vpa, name, amount, note='Order from NJ Mart'){
    // UPI: pay?pa=<vpa>&pn=<name>&tn=<note>&am=<amount>&cu=INR
    const q = new URLSearchParams({
      pa: vpa,
      pn: name || 'NJ Mart',
      tn: note,
      am: String(Number(amount||0).toFixed(2)),
      cu: 'INR'
    });
    return 'upi://pay?' + q.toString();
  }

  // save order to backend (adds to Orders sheet)
  async function saveOrder(order){
    // order: { CustomerID, Items (array), TotalAmount, Discount, FinalAmount, Payment, DeliveryAddress }
    const payload = {
      action: 'addorder',
      CustomerID: order.CustomerID || '',
      Items: JSON.stringify(order.Items || []),
      TotalAmount: order.TotalAmount || 0,
      Discount: order.Discount || 0,
      FinalAmount: order.FinalAmount || order.TotalAmount || 0,
      Payment: order.Payment || 'COD',
      DeliveryAddress: order.DeliveryAddress || '',
      Status: 'placed'
    };
    const res = await apiPost(payload);
    return res;
  }

  // open cart / checkout page
  function openCartPage(){
    // simplest: redirect to cart.html or checkout.html with cart in localStorage
    window.location.href = 'cart.html';
  }

  // ---------------- Events ----------------
  cartBtn.addEventListener('click', openCartPage);
  document.querySelector('button[onclick="applyFilters()"]').addEventListener('click', applyFilters);

  // attach search (if you later add search input)
  // e.g. document.get
