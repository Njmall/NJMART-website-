<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NJ Mart — Fresh groceries, fast delivery</title>

  <!-- Fonts + icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Main stylesheet (must exist in same folder) -->
  <link rel="stylesheet" href="style.css">

  <style>
    /* Small page-specific adjustments (keeps file standalone-friendly) */
    :root{--accent:#2db34a;--accent-dark:#1f8a34;--muted:#6b7280;--card:#ffffff}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; margin:0;background:#f6fbf8;color:#111}
    .wrap{max-width:1100px;margin:14px auto;padding:12px}
    header.site-header{display:flex;gap:12px;align-items:center;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(12,30,40,0.06)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .search-box{flex:1;display:flex;gap:8px;align-items:center}
    .search-box input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef0;background:#fff;font-size:15px}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#fff;border:1px solid #e6eef0}
    .cart-badge{background:#fff;border-radius:999px;padding:2px 8px;margin-left:6px;font-weight:700}
    .main-grid{display:grid;grid-template-columns:260px 1fr;gap:16px;margin-top:16px}
    @media(max-width:980px){ .main-grid{grid-template-columns:1fr} .logo{width:48px;height:48px} .search-box input{font-size:14px} }
    .sidebar{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(12,30,40,0.04)}
    .category-list{display:flex;flex-direction:column;gap:8px}
    .category-item{padding:8px;border-radius:8px;cursor:pointer;border:1px dashed transparent}
    .category-item.active{background:#f3fff6;border:1px solid rgba(45,179,74,0.12)}
    .hero{background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#fff;padding:18px;border-radius:12px;display:flex;gap:12px;align-items:center}
    .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:12px}
    .product{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(12,30,40,0.04);display:flex;flex-direction:column;justify-content:space-between}
    .product .thumb{height:150px;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#f4f7f6}
    .product h4{margin:8px 0 6px 0;font-size:15px}
    .meta{font-size:13px;color:var(--muted)}
    .price{font-weight:800;color:var(--accent);font-size:16px}
    .product .row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:8px}
    .cart-fab{position:fixed;right:18px;bottom:18px;z-index:80;background:var(--accent);color:#fff;padding:12px 16px;border-radius:14px;box-shadow:0 10px 36px rgba(16,185,129,0.18);cursor:pointer;display:flex;gap:8px;align-items:center}
    .cart-panel{position:fixed;right:18px;bottom:80px;width:360px;max-width:calc(100% - 32px);background:var(--card);border-radius:12px;box-shadow:0 20px 60px rgba(12,30,40,0.12);padding:12px;display:none;z-index:85}
    .cart-item{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid #f1f3f4}
    .cart-item img{width:64px;height:64px;object-fit:cover;border-radius:8px}
    .small{font-size:13px;color:var(--muted)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#f1f6f3;color:#1f8a34;font-weight:700}
    footer.site-footer{margin-top:18px;background:var(--card);padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(12,30,40,0.04);display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HEADER -->
    <header class="site-header" role="banner">
      <div class="brand">
        <div class="logo">NJ</div>
        <div>
          <h1 style="margin:0">NJ Mart</h1>
          <div class="small" style="margin-top:4px">Fresh groceries — home delivery</div>
        </div>
      </div>

      <div class="search-box" role="search">
        <input id="globalSearch" type="search" placeholder="Search for products, brands or categories..." aria-label="Search products">
      </div>

      <div class="actions">
        <button id="btnAccount" class="btn ghost" onclick="location.href='login.html'"><i class="fa fa-user"></i> <span id="accountLabel">Login</span></button>
        <button id="btnCartHeader" class="btn" title="Open cart"><i class="fa fa-shopping-cart"></i> Cart <span class="cart-badge" id="headerCartCount">0</span></button>
      </div>
    </header>

    <!-- LAYOUT -->
    <div class="main-grid" role="main">

      <!-- SIDEBAR -->
      <aside class="sidebar" aria-label="Filters">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Categories</div>
          <button id="clearFilters" class="btn ghost" title="Clear filters">Clear</button>
        </div>

        <div id="categoryList" class="category-list" style="margin-top:10px">
          <!-- categories injected here -->
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:800;margin-bottom:8px">Price range</div>
          <div style="display:flex;gap:8px">
            <input id="minPrice" type="number" placeholder="Min ₹" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef0">
            <input id="maxPrice" type="number" placeholder="Max ₹" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef0">
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="applyPrice" class="btn primary">Apply</button>
            <button id="resetPrice" class="btn ghost">Reset</button>
          </div>
        </div>

        <div style="margin-top:14px">
          <div style="font-weight:800;margin-bottom:8px">Sort</div>
          <select id="sortSelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef0">
            <option value="">Default</option>
            <option value="price_asc">Price low → high</option>
            <option value="price_desc">Price high → low</option>
            <option value="name_asc">Name A → Z</option>
            <option value="name_desc">Name Z → A</option>
          </select>
        </div>

        <div style="margin-top:16px" class="small">
          <div style="font-weight:700;margin-bottom:6px">Delivery info</div>
          <div>Free delivery above <span class="badge" id="freeThreshold">₹499</span></div>
          <div style="margin-top:6px">Delivery charge <span class="badge" id="deliveryCharge">₹25</span></div>
        </div>
      </aside>

      <!-- CONTENT AREA -->
      <section class="content-area">

        <!-- HERO -->
        <div class="hero" role="banner">
          <div style="flex:1">
            <h2 style="margin:0">Fresh groceries delivered to your door</h2>
            <p style="margin:8px 0 0 0;opacity:0.95">Daily essentials, staples and fresh produce — shop local brands with quick delivery.</p>
            <div style="margin-top:10px">
              <button id="shopNow" class="btn primary">Shop now</button>
              <button id="viewOffers" class="btn ghost">View offers</button>
            </div>
          </div>
          <div style="width:220px;text-align:center">
            <img src="https://via.placeholder.com/220x140?text=Fresh+Box" alt="Fresh box" style="border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.08)">
          </div>
        </div>

        <!-- TOPBAR -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:12px">
          <div>
            <h3 style="margin:0">Products</h3>
            <div class="small" style="margin-top:4px">Browse and add to cart — we deliver fast</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="quickSearch" placeholder="Quick search in results" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
            <select id="perPage" style="padding:8px;border-radius:8px;border:1px solid #e6eef0">
              <option value="12">12 / page</option>
              <option value="24">24 / page</option>
              <option value="48">48 / page</option>
            </select>
          </div>
        </div>

        <!-- PRODUCT GRID -->
        <div id="productGrid" class="product-grid" aria-live="polite" style="margin-top:12px">
          <!-- products show here -->
          <div style="grid-column:1/-1;color:var(--muted);padding:30px;border-radius:10px;background:#fff">Loading products…</div>
        </div>

        <!-- PAGINATION -->
        <div style="display:flex;justify-content:center;margin-top:12px;gap:8px">
          <button id="prevPage" class="btn ghost">Prev</button>
          <div id="pageInfo" style="padding:8px 12px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(12,30,40,0.04)">Page 1</div>
          <button id="nextPage" class="btn ghost">Next</button>
        </div>

        <!-- FOOTER -->
        <footer class="site-footer" role="contentinfo">
          <div>
            <div style="font-weight:800">NJ Mart</div>
            <div class="small" style="margin-top:6px">Groceries & essentials with same-day delivery.</div>
          </div>
          <div>
            <div style="font-weight:700">Support</div>
            <div class="small" style="margin-top:6px">Phone: <a href="tel:+917062918607">+91 70629 18607</a></div>
            <div class="small">Email: support@njmart.example</div>
          </div>
        </footer>

      </section>
    </div>

    <!-- CART FAB -->
    <div class="cart-fab" id="openCart" aria-live="polite">
      <i class="fa fa-shopping-basket"></i>
      <div>View cart</div>
      <div class="cart-badge" id="fabCount">0</div>
    </div>

    <!-- CART PANEL -->
    <div class="cart-panel" id="cartPanel" role="dialog" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Your cart</div>
        <button id="closeCart" class="btn ghost">Close</button>
      </div>

      <div id="cartItems" style="margin-top:10px;max-height:320px;overflow:auto">
        <!-- items injected here -->
      </div>

      <div style="margin-top:10px;border-top:1px dashed #eee;padding-top:10px">
        <div style="display:flex;justify-content:space-between"><div class="small">Subtotal</div><div id="cartSubtotal">₹0</div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="small">Delivery</div><div id="cartDelivery">₹0</div></div>
        <hr style="border:none;border-top:1px dashed #eee;margin:10px 0">
        <div style="display:flex;justify-content:space-between;font-weight:800"><div>Total</div><div id="cartTotal">₹0</div></div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="checkoutBtn" class="btn primary" style="flex:1">Checkout</button>
          <button id="clearCartBtn" class="btn ghost">Clear</button>
        </div>
        <div style="margin-top:8px" class="small">You can change delivery address at checkout</div>
      </div>
    </div>

  </div> <!-- wrap -->

  <!-- ========== SCRIPT: product load, cart logic, filters, pagination ========== -->
  <script>
  /*******************************************************************
   * index.html — Customer-facing final version
   * - Loads products from Apps Script backend (API_BASE?action=products)
   * - Supports: search, filters, pagination, add-to-cart, localStorage cart
   * - Checkout redirects to checkout.html (which should read localStorage 'nj_checkout')
   *
   * NOTE:
   * - Replace API_BASE with your Apps Script webapp URL if needed.
   * - style.css should exist in the same folder.
   *******************************************************************/
  const API_BASE = 'https://script.google.com/macros/s/AKfycbwsG5H7er3nqwGjEbrtokssc5LeGFc9Zog2bG1s0C5bQ-P2b_1S1kisSLpOmdESH7FB/exec';

  // Config
  const DELIVERY_THRESHOLD_DEFAULT = 499;
  const DELIVERY_CHARGE_DEFAULT = 25;

  // State
  let PRODUCTS = [];      // full products from backend
  let FILTERED = [];      // filtered set
  let CATEGORIES = [];
  let currentPage = 1;
  let perPage = Number(localStorage.getItem('nj_perpage') || 12);

  // Elements
  const el = id => document.getElementById(id);
  const productGrid = el('productGrid');
  const headerCartCount = el('headerCartCount');
  const fabCount = el('fabCount');
  const cartPanel = el('cartPanel');
  const openCartBtn = el('openCart');
  const closeCartBtn = el('closeCart');
  const cartItemsEl = el('cartItems');
  const checkoutBtn = el('checkoutBtn');
  const clearCartBtn = el('clearCartBtn');
  const cartSubtotalEl = el('cartSubtotal');
  const cartDeliveryEl = el('cartDelivery');
  const cartTotalEl = el('cartTotal');
  const pageInfo = el('pageInfo');
  const prevPageBtn = el('prevPage');
  const nextPageBtn = el('nextPage');

  // Helpers: localStorage cart
  function loadCart(){ try{ return JSON.parse(localStorage.getItem('nj_cart')||'[]'); }catch(e){ return []; } }
  function saveCart(c){ localStorage.setItem('nj_cart', JSON.stringify(c)); updateCartCounts(); }
  function clearCart(){ localStorage.removeItem('nj_cart'); renderCart(); updateCartCounts(); }

  function updateCartCounts(){
    const cart = loadCart();
    const count = cart.reduce((s,i)=> s + (i.qty||0), 0);
    headerCartCount.textContent = count;
    fabCount.textContent = count;
  }

  // Fetch products from backend
  async function fetchProducts(){
    productGrid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted);padding:30px;border-radius:10px;background:#fff">Loading products…</div>';
    try{
      const url = new URL(API_BASE);
      url.searchParams.set('action','products');
      const res = await fetch(url.toString(),{cache:'no-store'});
      const data = await res.json();
      if(!data.ok){ throw new Error(data.error||'Failed'); }
      PRODUCTS = (data.products || []).map(p => normalizeProduct(p));
      CATEGORIES = Array.from(new Set(PRODUCTS.map(p=>p.Category||'').filter(Boolean))).sort();
      renderCategoryList();
      applyFiltersAndRender();
    }catch(err){
      productGrid.innerHTML = `<div style="grid-column:1/-1;color:#e04d4d;padding:30px;border-radius:10px;background:#fff">Unable to load products: ${String(err)}</div>`;
    }
  }

  function normalizeProduct(p){
    // ensure consistent keys
    return {
      id: p.ProductID || p.id || p.ProductId || p.ProductId || (p.Name ? slugify(p.Name) : ''),
      name: p.Name || p.name || '',
      price: Number(p.Price || p.price || p['MRP'] || 0),
      stock: Number(p.Stock || p.stock || p.Quantity || 0),
      category: p.Category || p.category || '',
      image: p['Image URL'] || p.Image || p.image || (p.photo || ''),
      desc: p.Description || p.Desc || p.description || ''
    };
  }

  function slugify(s){ return s.toString().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_]/g,'').slice(0,40); }

  /* =========== Render category list =========== */
  function renderCategoryList(){
    const container = el('categoryList');
    container.innerHTML = '';
    // All
    const allBtn = document.createElement('button');
    allBtn.className = 'category-item active';
    allBtn.textContent = 'All categories';
    allBtn.dataset.cat = '';
    allBtn.addEventListener('click', ()=> { selectCategory(''); });
    container.appendChild(allBtn);
    CATEGORIES.forEach(cat=>{
      const b = document.createElement('button');
      b.className = 'category-item';
      b.textContent = cat;
      b.dataset.cat = cat;
      b.addEventListener('click', ()=> selectCategory(cat));
      container.appendChild(b);
    });
  }

  function selectCategory(cat){
    $$('.category-item').forEach(el=>el.classList.remove('active'));
    $$('.category-item').find(x => x.dataset.cat === (cat||'') )?.classList.add('active');
    el('productSearch').value = '';
    el('globalSearch').value = '';
    applyFiltersAndRender({category:cat});
  }

  // small DOM helper
  function $(sel,root=document){ return root.querySelector(sel); }
  function $$(sel,root=document){ return Array.from(root.querySelectorAll(sel)); }

  /* =========== Filtering, sorting, pagination =========== */
  function applyFiltersAndRender(opts = {}){
    const qGlobal = (el('globalSearch').value || '').trim().toLowerCase();
    const qQuick = (el('quickSearch').value || '').trim().toLowerCase();
    const category = opts.category !== undefined ? opts.category : ( $$('.category-item.active')?.find? $$('.category-item.active')[0]?.dataset.cat : ( $$('.category-item').find? ($$('.category-item').find(b=>b.classList.contains('active'))?.dataset.cat : '') );
    const minP = Number(el('minPrice').value || 0);
    const maxP = Number(el('maxPrice').value || 0);
    const sort = el('sortSelect').value;
    // filter
    FILTERED = PRODUCTS.filter(p=>{
      if(category && p.category !== category) return false;
      if(qGlobal && !(p.name.toLowerCase().includes(qGlobal) || (p.desc||'').toLowerCase().includes(qGlobal) || (p.category||'').toLowerCase().includes(qGlobal))) return false;
      if(qQuick && !(p.name.toLowerCase().includes(qQuick))) return false;
      if(minP && p.price < minP) return false;
      if(maxP && maxP>0 && p.price > maxP) return false;
      return true;
    });
    // sort
    if(sort==='price_asc') FILTERED.sort((a,b)=>a.price-b.price);
    else if(sort==='price_desc') FILTERED.sort((a,b)=>b.price-a.price);
    else if(sort==='name_asc') FILTERED.sort((a,b)=> a.name.localeCompare(b.name));
    else if(sort==='name_desc') FILTERED.sort((a,b)=> b.name.localeCompare(a.name));
    // pagination
    perPage = Number(el('perPage').value || perPage);
    localStorage.setItem('nj_perpage', perPage);
    const totalPages = Math.max(1, Math.ceil(FILTERED.length / perPage));
    if(currentPage > totalPages) currentPage = totalPages;
    renderProductsPage(currentPage, perPage);
  }

  function renderProductsPage(page, pageSize){
    productGrid.innerHTML = '';
    const start = (page-1) * pageSize;
    const end = start + pageSize;
    const slice = FILTERED.slice(start, end);
    if(slice.length === 0){
      productGrid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted);padding:30px;border-radius:10px;background:#fff">No products found</div>';
    } else {
      slice.forEach(p => {
        const node = document.createElement('div');
        node.className = 'product';
        node.innerHTML = `
          <div class="thumb"><img src="${escapeHtml(p.image)||'https://via.placeholder.com/300x300?text=Image'}" alt="${escapeHtml(p.name)}"></div>
          <div>
            <h4>${escapeHtml(p.name)}</h4>
            <div class="meta">${escapeHtml(p.category || '')}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
              <div class="price">₹${Number(p.price).toFixed(0)}</div>
              <div class="small">Stock: ${p.stock}</div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn primary add-btn" data-id="${p.id}">Add</button>
              <button class="btn ghost buy-now" data-id="${p.id}">Buy Now</b
